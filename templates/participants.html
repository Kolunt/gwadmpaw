{% extends "base.html" %}

{% block title %}–£—á–∞—Å—Ç–Ω–∏–∫–∏ - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–µ–¥—ã –ú–æ—Ä–æ–∑—ã{% endblock %}

{% block content %}
<div class="participants-container">
    <h1>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h1>
    
    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="table-controls">
        <div class="search-box">
            <input 
                type="text" 
                id="search-input" 
                class="search-input" 
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º..."
                autocomplete="off"
                value="{{ search_query|default('') }}"
            >
            <span class="search-icon">üîç</span>
        </div>
        
        <div class="table-info">
            <span id="rows-count">
                –ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="visible-count">{{ participants|length }}</strong> –∏–∑ <strong id="total-count">{{ total_count|default(participants|length) }}</strong>
                {% if total_pages is defined and total_pages > 1 %}
                    (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page|default(1) }} –∏–∑ {{ total_pages }})
                {% endif %}
            </span>
        </div>
    </div>
    
    <div class="table-container">
        <table class="admin-table" id="participants-table">
            <thead>
                <tr>
                    <th class="sortable" data-column="0" data-sort="none">
                        –ù–∏–∫–Ω–µ–π–º –≤ GWars
                        <span class="sort-indicator">‚áÖ</span>
                    </th>
                    <th class="sortable" data-column="1" data-sort="none">
                        –°—Ç–∞—Ç—É—Å
                        <span class="sort-indicator">‚áÖ</span>
                    </th>
                    <th class="sortable" data-column="2" data-sort="none">
                        –†–æ–ª—å
                        <span class="sort-indicator">‚áÖ</span>
                    </th>
                    <th class="sortable" data-column="3" data-sort="asc">
                        –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        <span class="sort-indicator">‚Üë</span>
                    </th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for participant in participants %}
                <tr data-username="{{ participant.username|lower }}" 
                    data-status="{{ participant.status|lower }}" 
                    data-roles="{{ (participant.roles or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')|lower }}">
                    <td data-label="–ù–∏–∫–Ω–µ–π–º –≤ GWars">
                        <div class="participant-name-cell">
                            {% if participant.avatar_seed %}
                            <img src="{{ get_avatar_url(participant.avatar_seed, participant.avatar_style or 'avataaars', 32) }}" alt="–ê–≤–∞—Ç–∞—Ä {{ participant.username }}" class="avatar-small">
                            {% endif %}
                            <a href="{{ url_for('view_profile', user_id=participant.user_id) }}" class="participant-link">
                                <strong>{{ participant.username }}</strong>
                            </a>
                        </div>
                    </td>
                    <td data-label="–°—Ç–∞—Ç—É—Å">
                        {% if participant.status == '–û–Ω–ª–∞–π–Ω' %}
                            <span class="status-badge status-online">{{ participant.status }}</span>
                        {% elif participant.status == '–ë—ã–ª —Å–µ–≥–æ–¥–Ω—è' %}
                            <span class="status-badge status-today">{{ participant.status }}</span>
                        {% else %}
                            <span class="status-badge status-offline">{{ participant.status }}</span>
                        {% endif %}
                    </td>
                    <td data-label="–†–æ–ª—å">
                        {% if participant.roles %}
                            {% for role in participant.roles.split(', ') %}
                                <span class="role-badge">{{ role.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="role-badge">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                        {% endif %}
                    </td>
                    <td data-label="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">
                        {{ participant.created_at or 'N/A' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–æ) -->
    {% if total_pages is not defined %}
    <!-- DEBUG: total_pages –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ -->
    {% endif %}
    {% if page is not defined %}
    <!-- DEBUG: page –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ -->
    {% endif %}
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages is defined and total_pages > 1 %}
    <div class="pagination-container">
        <nav class="pagination" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
            <ul class="pagination-list">
                {% if has_prev is defined and has_prev %}
                <li class="pagination-item">
                    <a href="{{ url_for('participants', page=(page|default(1))-1, per_page=per_page|default(50), search=search_query|default('')) }}" class="pagination-link pagination-link-prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                        ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                </li>
                {% else %}
                <li class="pagination-item pagination-item-disabled">
                    <span class="pagination-link pagination-link-prev pagination-link-disabled" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                        ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </span>
                </li>
                {% endif %}
                
                {% set current_page = page|default(1) %}
                {% set start_page = [1, current_page - 2]|max %}
                {% set end_page = [total_pages, current_page + 2]|min %}
                
                {% if start_page > 1 %}
                <li class="pagination-item">
                    <a href="{{ url_for('participants', page=1, per_page=per_page|default(50), search=search_query|default('')) }}" class="pagination-link">1</a>
                </li>
                {% if start_page > 2 %}
                <li class="pagination-item pagination-item-ellipsis">
                    <span class="pagination-ellipsis">...</span>
                </li>
                {% endif %}
                {% endif %}
                
                {% for p in range(start_page, end_page + 1) %}
                <li class="pagination-item">
                    {% if p == current_page %}
                    <span class="pagination-link pagination-link-active" aria-current="page">{{ p }}</span>
                    {% else %}
                    <a href="{{ url_for('participants', page=p, per_page=per_page|default(50), search=search_query|default('')) }}" class="pagination-link">{{ p }}</a>
                    {% endif %}
                </li>
                {% endfor %}
                
                {% if end_page < total_pages %}
                {% if end_page < total_pages - 1 %}
                <li class="pagination-item pagination-item-ellipsis">
                    <span class="pagination-ellipsis">...</span>
                </li>
                {% endif %}
                <li class="pagination-item">
                    <a href="{{ url_for('participants', page=total_pages, per_page=per_page|default(50), search=search_query|default('')) }}" class="pagination-link">{{ total_pages }}</a>
                </li>
                {% endif %}
                
                {% if has_next is defined and has_next %}
                <li class="pagination-item">
                    <a href="{{ url_for('participants', page=current_page+1, per_page=per_page|default(50), search=search_query|default('')) }}" class="pagination-link pagination-link-next" aria-label="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                        –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                    </a>
                </li>
                {% else %}
                <li class="pagination-item pagination-item-disabled">
                    <span class="pagination-link pagination-link-next pagination-link-disabled" aria-label="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                        –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                    </span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('participants-table');
    const tbody = document.getElementById('table-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const searchInput = document.getElementById('search-input');
    const visibleCount = document.getElementById('visible-count');
    const totalCount = document.getElementById('total-count');
    
    let currentSort = {
        column: null,
        direction: 'none'
    };
    
    // –ü–æ–∏—Å–∫ —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π (—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –≤—Å–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º)
    function performSearch() {
        const searchTerm = searchInput.value.trim();
        const url = new URL(window.location.href);
        
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
        } else {
            url.searchParams.delete('search');
        }
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –ø–µ—Ä–≤—É—é –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
        url.searchParams.set('page', '1');
        
        window.location.href = url.toString();
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    function sortTable(columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
        
        if (currentSort.column === columnIndex) {
            if (currentSort.direction === 'asc') {
                currentSort.direction = 'desc';
            } else if (currentSort.direction === 'desc') {
                currentSort.direction = 'none';
            } else {
                currentSort.direction = 'asc';
            }
        } else {
            currentSort.column = columnIndex;
            currentSort.direction = 'asc';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const headers = table.querySelectorAll('th.sortable');
        headers.forEach((header, index) => {
            const indicator = header.querySelector('.sort-indicator');
            if (index === columnIndex) {
                if (currentSort.direction === 'asc') {
                    indicator.textContent = '‚Üë';
                } else if (currentSort.direction === 'desc') {
                    indicator.textContent = '‚Üì';
                } else {
                    indicator.textContent = '‚áÖ';
                }
            } else {
                indicator.textContent = '‚áÖ';
            }
        });
        
        if (currentSort.direction === 'none') {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
            rows.forEach(row => tbody.appendChild(row));
            return;
        }
        
        rows.sort((a, b) => {
            const aCell = a.querySelectorAll('td')[columnIndex];
            const bCell = b.querySelectorAll('td')[columnIndex];
            
            let aValue = aCell.textContent.trim();
            let bValue = bCell.textContent.trim();
            
            // –î–ª—è –¥–∞—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É
            if (columnIndex === 3) {
                try {
                    const aDate = new Date(aValue);
                    const bDate = new Date(bValue);
                    if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
                        aValue = aDate;
                        bValue = bDate;
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                }
            }
            
            if (aValue < bValue) {
                return currentSort.direction === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return currentSort.direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // –§—É–Ω–∫—Ü–∏—è debounce
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    // –ü—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    searchInput.addEventListener('input', debounce(() => {
        performSearch();
    }, 500));
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    table.querySelectorAll('th.sortable').forEach((header, index) => {
        header.addEventListener('click', () => sortTable(index));
        header.style.cursor = 'pointer';
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é - —Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É)
    currentSort.column = 3; // –ö–æ–ª–æ–Ω–∫–∞ "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
    currentSort.direction = 'asc';
    sortTable(3);
});
</script>
{% endblock %}

