{% extends "base.html" %}

{% block title %}–£—á–∞—Å—Ç–Ω–∏–∫–∏ - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–µ–¥—ã –ú–æ—Ä–æ–∑—ã{% endblock %}

{% block content %}
<div class="participants-container">
    <h1>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h1>
    
    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="table-controls">
        <div class="search-box">
            <input 
                type="text" 
                id="search-input" 
                class="search-input" 
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º..."
                autocomplete="off"
            >
            <span class="search-icon">üîç</span>
        </div>
        
        <div class="filters-row">
            <div class="filter-group">
                <label for="filter-name" class="filter-label">–ù–∏–∫–Ω–µ–π–º:</label>
                <input type="text" id="filter-name" class="filter-input" placeholder="–í—Å–µ">
            </div>
            <div class="filter-group">
                <label for="filter-status" class="filter-label">–°—Ç–∞—Ç—É—Å:</label>
                <input type="text" id="filter-status" class="filter-input" placeholder="–í—Å–µ">
            </div>
            <div class="filter-group">
                <label for="filter-roles" class="filter-label">–†–æ–ª–∏:</label>
                <input type="text" id="filter-roles" class="filter-input" placeholder="–í—Å–µ">
            </div>
            <button type="button" id="clear-filters" class="btn btn-secondary btn-sm">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
        
        <div class="table-info">
            <span id="rows-count">–ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="visible-count">0</strong> –∏–∑ <strong id="total-count">{{ participants|length }}</strong></span>
        </div>
    </div>
    
    <div class="table-container">
        <table class="admin-table" id="participants-table">
            <thead>
                <tr>
                    <th class="sortable" data-column="0" data-sort="none">
                        –ù–∏–∫–Ω–µ–π–º –≤ GWars
                        <span class="sort-indicator">‚áÖ</span>
                    </th>
                    <th class="sortable" data-column="1" data-sort="none">
                        –°—Ç–∞—Ç—É—Å
                        <span class="sort-indicator">‚áÖ</span>
                    </th>
                    <th class="sortable" data-column="2" data-sort="none">
                        –†–æ–ª—å
                        <span class="sort-indicator">‚áÖ</span>
                    </th>
                    <th class="sortable" data-column="3" data-sort="asc">
                        –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        <span class="sort-indicator">‚Üë</span>
                    </th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for participant in participants %}
                <tr data-username="{{ participant.username|lower }}" 
                    data-status="{{ participant.status|lower }}" 
                    data-roles="{{ (participant.roles or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')|lower }}">
                    <td data-label="–ù–∏–∫–Ω–µ–π–º –≤ GWars">
                        <div class="participant-name-cell">
                            {% if participant.avatar_seed %}
                            <img src="{{ get_avatar_url(participant.avatar_seed, participant.avatar_style or 'avataaars', 32) }}" alt="–ê–≤–∞—Ç–∞—Ä {{ participant.username }}" class="avatar-small">
                            {% endif %}
                            <a href="{{ url_for('view_profile', user_id=participant.user_id) }}" class="participant-link">
                                <strong>{{ participant.username }}</strong>
                            </a>
                        </div>
                    </td>
                    <td data-label="–°—Ç–∞—Ç—É—Å">
                        {% if participant.status == '–û–Ω–ª–∞–π–Ω' %}
                            <span class="status-badge status-online">{{ participant.status }}</span>
                        {% elif participant.status == '–ë—ã–ª —Å–µ–≥–æ–¥–Ω—è' %}
                            <span class="status-badge status-today">{{ participant.status }}</span>
                        {% else %}
                            <span class="status-badge status-offline">{{ participant.status }}</span>
                        {% endif %}
                    </td>
                    <td data-label="–†–æ–ª—å">
                        {% if participant.roles %}
                            {% for role in participant.roles.split(', ') %}
                                <span class="role-badge">{{ role.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="role-badge">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                        {% endif %}
                    </td>
                    <td data-label="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">
                        {{ participant.created_at or 'N/A' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('participants-table');
    const tbody = document.getElementById('table-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const searchInput = document.getElementById('search-input');
    const filterName = document.getElementById('filter-name');
    const filterStatus = document.getElementById('filter-status');
    const filterRoles = document.getElementById('filter-roles');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const visibleCount = document.getElementById('visible-count');
    const totalCount = document.getElementById('total-count');
    
    let currentSort = {
        column: null,
        direction: 'none'
    };
    
    // –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    function filterRows() {
        const searchTerm = searchInput.value.toLowerCase();
        const nameFilter = filterName.value.toLowerCase();
        const statusFilter = filterStatus.value.toLowerCase();
        const rolesFilter = filterRoles.value.toLowerCase();
        
        let visible = 0;
        
        rows.forEach(row => {
            const username = row.getAttribute('data-username') || '';
            const status = row.getAttribute('data-status') || '';
            const roles = row.getAttribute('data-roles') || '';
            
            const cells = row.querySelectorAll('td');
            const cellText = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' ');
            
            const matchesSearch = !searchTerm || cellText.includes(searchTerm);
            const matchesName = !nameFilter || username.includes(nameFilter);
            const matchesStatus = !statusFilter || status.includes(statusFilter);
            const matchesRoles = !rolesFilter || roles.includes(rolesFilter);
            
            if (matchesSearch && matchesName && matchesStatus && matchesRoles) {
                row.style.display = '';
                visible++;
            } else {
                row.style.display = 'none';
            }
        });
        
        visibleCount.textContent = visible;
        totalCount.textContent = rows.length;
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    function sortTable(columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
        
        if (currentSort.column === columnIndex) {
            if (currentSort.direction === 'asc') {
                currentSort.direction = 'desc';
            } else if (currentSort.direction === 'desc') {
                currentSort.direction = 'none';
            } else {
                currentSort.direction = 'asc';
            }
        } else {
            currentSort.column = columnIndex;
            currentSort.direction = 'asc';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const headers = table.querySelectorAll('th.sortable');
        headers.forEach((header, index) => {
            const indicator = header.querySelector('.sort-indicator');
            if (index === columnIndex) {
                if (currentSort.direction === 'asc') {
                    indicator.textContent = '‚Üë';
                } else if (currentSort.direction === 'desc') {
                    indicator.textContent = '‚Üì';
                } else {
                    indicator.textContent = '‚áÖ';
                }
            } else {
                indicator.textContent = '‚áÖ';
            }
        });
        
        if (currentSort.direction === 'none') {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
            rows.forEach(row => tbody.appendChild(row));
            return;
        }
        
        rows.sort((a, b) => {
            const aCell = a.querySelectorAll('td')[columnIndex];
            const bCell = b.querySelectorAll('td')[columnIndex];
            
            let aValue = aCell.textContent.trim();
            let bValue = bCell.textContent.trim();
            
            // –î–ª—è –¥–∞—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É
            if (columnIndex === 3) {
                try {
                    const aDate = new Date(aValue);
                    const bDate = new Date(bValue);
                    if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
                        aValue = aDate;
                        bValue = bDate;
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                }
            }
            
            if (aValue < bValue) {
                return currentSort.direction === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return currentSort.direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    searchInput.addEventListener('input', filterRows);
    filterName.addEventListener('input', filterRows);
    filterStatus.addEventListener('input', filterRows);
    filterRoles.addEventListener('input', filterRows);
    
    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        filterName.value = '';
        filterStatus.value = '';
        filterRoles.value = '';
        filterRows();
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    table.querySelectorAll('th.sortable').forEach((header, index) => {
        header.addEventListener('click', () => sortTable(index));
        header.style.cursor = 'pointer';
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    filterRows();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é - —Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É)
    currentSort.column = 3; // –ö–æ–ª–æ–Ω–∫–∞ "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
    currentSort.direction = 'asc';
    sortTable(3);
});
</script>
{% endblock %}

