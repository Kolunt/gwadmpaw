{% extends "base.html" %}

{% block title %}Мероприятия - Анонимные Деды Морозы{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="admin-container">
        <div class="admin-header">
            <h1>Мероприятия</h1>
            {% if session.user_id and 'admin' in session.get('roles', []) %}
            <a href="{{ url_for('admin_events') }}" class="btn btn-primary">Управление мероприятиями</a>
            {% endif %}
        </div>
        
        {% if events_with_stages %}
        <div class="table-container">
            <table class="admin-table events-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Участники</th>
                        <th>Текущий этап</th>
                        <th>Мой статус</th>
                        <th style="width: 160px;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in events_with_stages %}
                    {% set event = item.event %}
                    {% set current_stage = item.current_stage %}
                    <tr>
                        <td data-label="Название">
                            <a href="{{ url_for('event_view', event_id=event.id) }}" class="event-name-link">{{ event.name }}</a>
                        </td>
                        <td data-label="Участники">
                            {{ item.registrations_count }}
                        </td>
                        <td data-label="Текущий этап">
                            {% if current_stage %}
                                {{ item.display_stage_name or current_stage.info.name }}
                            {% else %}
                                {% if item.next_stage_is_past %}
                                <span class="badge-upcoming" style="background-color: var(--text-secondary);">Завершено</span>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td data-label="Мой статус">
                            {% if session.user_id %}
                                {% if item.is_registered %}
                                    {% if item.needs_confirmation %}
                                        требуется подтверждение
                                    {% else %}
                                        участвую
                                    {% endif %}
                                {% else %}
                                    не участвую
                                {% endif %}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td data-label="Действия">
                            <div class="events-actions-group">
                                {% if session.user_id %}
                                    {% if item.needs_confirmation and item.registration_open %}
                                        <form method="POST"
                                              action="{{ url_for('event_register', event_id=event.id) }}"
                                              class="register-form"
                                              data-event-id="{{ event.id }}">
                                            <button type="submit" class="btn btn-sm btn-primary">Подтвердить</button>
                                        </form>
                                    {% elif item.registration_open %}
                                        {% if item.is_registered %}
                                            <form method="POST" action="{{ url_for('event_unregister', event_id=event.id) }}"
                                                  onsubmit="return confirm('Вы уверены, что хотите отменить регистрацию?');">
                                                <button type="submit" class="btn-icon btn-icon-danger" title="Отменить участие">&#10060;</button>
                                            </form>
                                        {% else %}
                                            <form method="POST"
                                                  action="{{ url_for('event_register', event_id=event.id) }}"
                                                  class="register-form"
                                                  data-event-id="{{ event.id }}">
                                                <button type="submit" class="btn-icon btn-icon-success" title="Записаться">&#10003;</button>
                                            </form>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">Регистрация закрыта</span>
                                    {% endif %}
                                {% endif %}
                                <a href="{{ url_for('event_view', event_id=event.id) }}" class="btn-icon" title="Просмотр">
                                    <span aria-hidden="true">&#128065;</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>Мероприятия пока не созданы</p>
            {% if session.user_id and 'admin' in session.get('roles', []) %}
            <a href="{{ url_for('admin_event_create') }}" class="btn btn-primary">Создать первое мероприятие</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% include 'partials/registration_modal.html' %}

<script>
function initCountdownTimers(selector) {
    const elements = document.querySelectorAll(selector);
    elements.forEach(element => {
        const targetIso = element.getAttribute('data-start');
        if (!targetIso) {
            return;
        }

        const targetDate = new Date(targetIso.replace(' ', 'T'));
        if (isNaN(targetDate.getTime())) {
            return;
        }

        const values = {
            days: element.querySelector('[data-unit="days"]'),
            hours: element.querySelector('[data-unit="hours"]'),
            minutes: element.querySelector('[data-unit="minutes"]'),
            seconds: element.querySelector('[data-unit="seconds"]')
        };

        function updateCountdown() {
            const now = new Date();
            const diff = targetDate - now;

            if (diff <= 0) {
                values.days.textContent = '0';
                values.hours.textContent = '00';
                values.minutes.textContent = '00';
                values.seconds.textContent = '00';
                element.classList.add('countdown-complete');
                return;
            }

            const seconds = Math.floor(diff / 1000) % 60;
            const minutes = Math.floor(diff / (1000 * 60)) % 60;
            const hours = Math.floor(diff / (1000 * 60 * 60)) % 24;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            values.days.textContent = String(days);
            values.hours.textContent = String(hours).padStart(2, '0');
            values.minutes.textContent = String(minutes).padStart(2, '0');
            values.seconds.textContent = String(seconds).padStart(2, '0');
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initCountdownTimers('.event-countdown, .event-countdown-home');
});
</script>

{% endblock %}



