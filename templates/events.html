{% extends "base.html" %}

{% block title %}–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–µ–¥—ã –ú–æ—Ä–æ–∑—ã{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="admin-container">
        <div class="admin-header">
            <h1>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h1>
            {% if session.user_id and 'admin' in session.get('roles', []) %}
            <a href="{{ url_for('admin_events') }}" class="btn btn-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏</a>
            {% endif %}
        </div>
        
        {% if events_with_stages %}
        <div class="table-container">
            <table class="admin-table events-table">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                        <th>–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø</th>
                        <th>–ú–æ–π —Å—Ç–∞—Ç—É—Å</th>
                        <th style="width: 160px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in events_with_stages %}
                    {% set event = item.event %}
                    {% set current_stage = item.current_stage %}
                    <tr>
                        <td data-label="–ù–∞–∑–≤–∞–Ω–∏–µ">
                            <a href="{{ url_for('event_view', event_id=event.id) }}" class="event-name-link">{{ event.name }}</a>
                        </td>
                        <td data-label="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
                            {{ item.registrations_count }}
                        </td>
                        <td data-label="–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø">
                            {% if current_stage %}
                                {{ item.display_stage_name or current_stage.info.name }}
                            {% else %}
                                {% if item.next_stage_is_past %}
                                <span class="badge-upcoming" style="background-color: var(--text-secondary);">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td data-label="–ú–æ–π —Å—Ç–∞—Ç—É—Å">
                            {% if session.user_id %}
                                {% if item.is_registered %}
                                    {% if item.needs_confirmation %}
                                        —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                                    {% else %}
                                        —É—á–∞—Å—Ç–≤—É—é
                                    {% endif %}
                                {% else %}
                                    –Ω–µ —É—á–∞—Å—Ç–≤—É—é
                                {% endif %}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                            <div class="events-actions-group">
                                {% if session.user_id %}
                                    {% if item.needs_confirmation and item.registration_open %}
                                        <form method="POST"
                                              action="{{ url_for('event_register', event_id=event.id) }}"
                                              class="register-form"
                                              data-event-id="{{ event.id }}">
                                            <button type="submit" class="btn btn-sm btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                                        </form>
                                    {% elif item.registration_open %}
                                        {% if item.is_registered %}
                                            <form method="POST" action="{{ url_for('event_unregister', event_id=event.id) }}"
                                                  onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é?');">
                                                <button type="submit" class="btn-icon btn-icon-danger" title="–û—Ç–º–µ–Ω–∏—Ç—å —É—á–∞—Å—Ç–∏–µ">&#10060;</button>
                                            </form>
                                        {% else %}
                                            <form method="POST"
                                                  action="{{ url_for('event_register', event_id=event.id) }}"
                                                  class="register-form"
                                                  data-event-id="{{ event.id }}">
                                                <button type="submit" class="btn btn-sm btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
                                            </form>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞</span>
                                    {% endif %}
                                {% endif %}
                                <a href="{{ url_for('event_view', event_id=event.id) }}" class="btn btn-sm btn-secondary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    <span aria-hidden="true">üëÅÔ∏è</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
            {% if session.user_id and 'admin' in session.get('roles', []) %}
            <a href="{{ url_for('admin_event_create') }}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% include 'partials/registration_modal.html' %}

<script>
function initCountdownTimers(selector) {
    const elements = document.querySelectorAll(selector);
    elements.forEach(element => {
        const targetIso = element.getAttribute('data-start');
        if (!targetIso) {
            return;
        }

        const targetDate = new Date(targetIso.replace(' ', 'T'));
        if (isNaN(targetDate.getTime())) {
            return;
        }

        const values = {
            days: element.querySelector('[data-unit="days"]'),
            hours: element.querySelector('[data-unit="hours"]'),
            minutes: element.querySelector('[data-unit="minutes"]'),
            seconds: element.querySelector('[data-unit="seconds"]')
        };

        function updateCountdown() {
            const now = new Date();
            const diff = targetDate - now;

            if (diff <= 0) {
                values.days.textContent = '0';
                values.hours.textContent = '00';
                values.minutes.textContent = '00';
                values.seconds.textContent = '00';
                element.classList.add('countdown-complete');
                return;
            }

            const seconds = Math.floor(diff / 1000) % 60;
            const minutes = Math.floor(diff / (1000 * 60)) % 60;
            const hours = Math.floor(diff / (1000 * 60 * 60)) % 24;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            values.days.textContent = String(days);
            values.hours.textContent = String(hours).padStart(2, '0');
            values.minutes.textContent = String(minutes).padStart(2, '0');
            values.seconds.textContent = String(seconds).padStart(2, '0');
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initCountdownTimers('.event-countdown, .event-countdown-home');
});
</script>

{% endblock %}



