{% extends "base.html" %}

{% block title %}–ó–∞–¥–∞–Ω–∏—è - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–µ–¥—ã –ú–æ—Ä–æ–∑—ã{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="admin-container">
        <div class="admin-header">
            <h1>üìã –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</h1>
        </div>
        
        {% if assignments_by_event %}
        <div class="assignments-filter">
            <button type="button" class="assignments-filter-btn is-active" data-filter="all">–í—Å–µ</button>
            {% for event_id, event_data in assignments_by_event.items() %}
            <button type="button" class="assignments-filter-btn" data-filter="{{ event_id }}">
                <span class="assignments-filter-label">{{ event_data.event_name }}</span>
                {% if event_data.event_finished %}
                <span class="assignments-filter-status">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                {% endif %}
            </button>
            {% endfor %}
        </div>
        {% for event_id, event_data in assignments_by_event.items() %}
            {% set event_finished = event_data.event_finished %}
            <details class="assignment-event-card" data-event-id="{{ event_id }}" data-finished="{{ '1' if event_finished else '0' }}" {% if not event_finished %}open{% endif %}>
                <summary class="assignment-event-summary">
                    <span class="assignment-event-name">
                        <a href="{{ url_for('event_view', event_id=event_id) }}" class="assignments-event-link">{{ event_data.event_name }}</a>
                    </span>
                    <span class="assignment-event-status {{ 'finished' if event_finished else 'active' }}">
                        {{ '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' if event_finished else '–ê–∫—Ç–∏–≤–Ω–æ' }}
                    </span>
                </summary>
                <div class="assignment-event-body">
                    {% if event_finished %}
                    <div class="assignment-finished-note">
                        <span>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.</span>
                    </div>
                    {% endif %}
                    <div class="assignments-grid">
                    <!-- –ì–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –î–µ–¥ –ú–æ—Ä–æ–∑ -->
                    {% if event_data.as_santa %}
                    <div class="assignment-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px;">
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <span style="font-size: 2rem; margin-right: 0.5rem;">üéÖ</span>
                            <h3 style="margin: 0; color: white;">–í—ã - –î–µ–¥ –ú–æ—Ä–æ–∑</h3>
                        </div>
                        <div style="margin-bottom: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <form method="GET" action="{{ url_for('letter') }}">
                                <input type="hidden" name="assignment_id" value="{{ event_data.as_santa.get('id') }}">
                                <button type="submit" class="btn btn-light btn-sm" style="color: #333;">–ü–∏—Å—å–º–æ</button>
                            </form>
                        </div>
                        <p style="margin-bottom: 1rem; opacity: 0.9;">–í—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫:</p>
                        <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            {% if event_data.as_santa.get('recipient_last_name') or event_data.as_santa.get('recipient_first_name') %}
                            <p style="margin: 0.5rem 0;">
                                <strong>–§–ò–û:</strong><br>
                                {{ event_data.as_santa.get('recipient_last_name', '') }} 
                                {{ event_data.as_santa.get('recipient_first_name', '') }} 
                                {{ event_data.as_santa.get('recipient_middle_name', '') }}
                            </p>
                            {% endif %}
                            {% if event_data.as_santa.get('recipient_postal_code') or event_data.as_santa.get('recipient_country') or event_data.as_santa.get('recipient_city') %}
                            <p style="margin: 0.5rem 0;">
                                <strong>–ê–¥—Ä–µ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong><br>
                                {{ event_data.as_santa.get('recipient_postal_code', '') }}, 
                                {{ event_data.as_santa.get('recipient_country', '') }},
                                {{ event_data.as_santa.get('recipient_city', '') }}<br>
                                {{ event_data.as_santa.get('recipient_street', '') }}, 
                                –¥. {{ event_data.as_santa.get('recipient_house', '') }}
                                {% if event_data.as_santa.get('recipient_building') %}, –∫–æ—Ä–ø. {{ event_data.as_santa.get('recipient_building') }}{% endif %}
                                {% if event_data.as_santa.get('recipient_apartment') %}, –∫–≤. {{ event_data.as_santa.get('recipient_apartment') }}{% endif %}
                            </p>
                            {% endif %}
                            {% if event_data.as_santa.get('recipient_bio') %}
                            <p style="margin: 0.5rem 0;">
                                <strong>–û —Å–µ–±–µ:</strong><br>
                                {{ event_data.as_santa.get('recipient_bio') | e | replace('\n', '<br>') | safe }}
                            </p>
                            {% endif %}
                        </div>
                        
                        {% if event_data.as_santa.get('santa_sent_at') %}
                        <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px;">
                            <p style="margin: 0.5rem 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {{ event_data.as_santa.get('santa_sent_at') }}</p>
                            {% if event_data.as_santa.get('santa_send_info') %}
                            <p style="margin: 0.5rem 0; white-space: pre-wrap;"><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ:</strong><br>{{ event_data.as_santa.get('santa_send_info') }}</p>
                            {% endif %}
                            {% if not event_finished %}
                            <form method="POST" action="{{ url_for('assignment_mark_sent', assignment_id=event_data.as_santa.get('id')) }}" style="margin-top: 0.75rem; display: grid; gap: 0.5rem;">
                                <label for="send_info_{{ event_data.as_santa.get('id') }}" style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.85); font-weight: 600;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ</label>
                                <textarea
                                    id="send_info_{{ event_data.as_santa.get('id') }}"
                                    name="send_info"
                                    class="setting-input"
                                    style="width: 100%; border-radius: 8px; border: none; padding: 0.75rem; resize: vertical; min-height: 100px;"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä, –¥–∞—Ç–∞, —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –¥—Ä.)"
                                    maxlength="500"
                                    required
                                >{{ event_data.as_santa.get('santa_send_info') }}</textarea>
                                <button type="submit" class="btn btn-light" style="align-self: flex-start;">
                                    <span aria-hidden="true">üîÑ</span>
                                    <span class="sr-only">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</span>
                                </button>
                                <p style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">–ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤. –¢–µ–∫—Å—Ç —É–≤–∏–¥–∏—Ç –≤–∞—à –≤–Ω—É—á–æ–∫ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ.</p>
                            </form>
                            {% else %}
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; opacity: 0.9;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–º–µ–Ω–∏—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.</p>
                            {% endif %}
                            {% if event_data.as_santa.get('recipient_received_at') %}
                            <p style="margin: 0.75rem 0 0;"><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ:</strong> {{ event_data.as_santa.get('recipient_received_at') }}</p>
                            {% else %}
                            <p style="margin: 0.75rem 0 0; opacity: 0.8;">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è.</p>
                            {% endif %}
                        </div>
                        {% set thanks_message = event_data.as_santa.get('recipient_thanks_message') %}
                        {% set thanks_image = event_data.as_santa.get('recipient_receipt_image') %}
                        {% if thanks_message or thanks_image %}
                        <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="margin: 0.5rem 0;"><strong>–û—Ç–≤–µ—Ç –æ—Ç –≤–Ω—É—á–∫–∞:</strong></p>
                            {% if thanks_message %}
                            <p style="margin: 0.5rem 0; white-space: pre-wrap;">{{ thanks_message | e | replace('\n', '<br>') | safe }}</p>
                            {% endif %}
                            {% if thanks_image %}
                            <div style="margin-top: 0.75rem; display: inline-flex;">
                                <a
                                    href="{{ url_for('static', filename=thanks_image) }}"
                                    target="_blank"
                                    rel="noopener"
                                    class="btn btn-light btn-sm"
                                    style="border: 1px solid rgba(0,0,0,0.15);"
                                >
                                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –ø–æ–¥–∞—Ä–∫–∞
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% else %}
                        {% if not event_finished %}
                        <form method="POST" action="{{ url_for('assignment_mark_sent', assignment_id=event_data.as_santa.get('id')) }}" style="margin-top: 1rem;">
                            <label for="send_info_{{ event_data.as_santa.get('id') }}" style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.8); font-weight: 600;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ</label>
                            <textarea 
                                id="send_info_{{ event_data.as_santa.get('id') }}"
                                name="send_info"
                                class="setting-input"
                                style="width: 100%; border-radius: 8px; border: none; padding: 0.75rem; resize: vertical; min-height: 100px;"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä, –¥–∞—Ç–∞, —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –¥—Ä.)"
                                maxlength="500"
                                required
                            ></textarea>
                            <button type="submit" class="btn btn-light" style="margin-top: 0.75rem;">–û—Ç–ø—Ä–∞–≤–∏–ª</button>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">–ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤</p>
                        </form>
                        {% else %}
                        <div style="margin-top: 1rem; background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                            <p style="margin: 0; opacity: 0.9;">–ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –±—ã–ª –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="assignment-card" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 2px dashed var(--border-color); text-align: center; color: var(--text-secondary);">
                        <span style="font-size: 2rem; display: block; margin-bottom: 0.5rem;">üéÖ</span>
                        <p style="margin: 0;">–í—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º</p>
                    </div>
                    {% endif %}
                    
                    <!-- –ì–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–Ω—É—á–∫–∞ -->
                    {% if event_data.as_recipient %}
                    <div class="assignment-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 12px;">
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <span style="font-size: 2rem; margin-right: 0.5rem;">üéÅ</span>
                            <h3 style="margin: 0; color: white;">–í—ã - –í–Ω—É—á–æ–∫</h3>
                        </div>
                        <div style="margin-bottom: 1.25rem;">
                            <form method="GET" action="{{ url_for('letter') }}">
                                <input type="hidden" name="assignment_id" value="{{ event_data.as_recipient.get('id') }}">
                                <button type="submit" class="btn btn-light btn-sm" style="color: #333;">–ü–∏—Å—å–º–æ</button>
                            </form>
                        </div>
                        {% if event_data.as_recipient.get('santa_sent_at') %}
                        <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; display: grid; gap: 0.75rem;">
                            <p style="margin: 0.5rem 0;"><strong>–î–µ–¥ –ú–æ—Ä–æ–∑ —Å–æ–æ–±—â–∏–ª –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ:</strong> {{ event_data.as_recipient.get('santa_sent_at') }}</p>
                            {% if event_data.as_recipient.get('santa_send_info') %}
                            <p style="margin: 0.5rem 0; white-space: pre-wrap;"><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞:</strong><br>{{ event_data.as_recipient.get('santa_send_info') }}</p>
                            {% endif %}
                            <div>
                                {% if event_data.as_recipient.get('recipient_received_at') %}
                                <p style="margin: 0.5rem 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> –í—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ {{ event_data.as_recipient.get('recipient_received_at') }}</p>
                                {% if event_data.as_recipient.get('recipient_thanks_message') %}
                                <p style="margin: 0.5rem 0; white-space: pre-wrap;"><strong>–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>{{ event_data.as_recipient.get('recipient_thanks_message') | e | replace('\n', '<br>') | safe }}</p>
                                {% endif %}
                                {% if event_data.as_recipient.get('recipient_receipt_image') %}
                            <div style="margin-top: 0.75rem; display: inline-flex;">
                                <a
                                    href="{{ url_for('static', filename=event_data.as_recipient.get('recipient_receipt_image')) }}"
                                    target="_blank"
                                    rel="noopener"
                                    class="btn btn-light btn-sm"
                                    style="border: 1px solid rgba(0,0,0,0.15);"
                                >
                                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –ø–æ–¥–∞—Ä–∫–∞
                                </a>
                            </div>
                                {% endif %}
                                {% else %}
                                {% if not event_finished %}
                                <form method="POST" action="{{ url_for('assignment_mark_received', assignment_id=event_data.as_recipient.get('id')) }}" enctype="multipart/form-data" style="display: grid; gap: 0.75rem; margin-top: 0.5rem;">
                                    <div>
                                    <label for="thank_you_{{ event_data.as_recipient.get('id') }}" style="font-weight: 600;">–°–æ–æ–±—â–µ–Ω–∏–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</label>
                                        <textarea
                                            id="thank_you_{{ event_data.as_recipient.get('id') }}"
                                            name="thank_you_message"
                                            class="setting-input"
                                            style="min-height: 100px; resize: vertical;"
                                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—ë–ø–ª—ã—Ö —Å–ª–æ–≤ —Å–≤–æ–µ–º—É –î–µ–¥—É –ú–æ—Ä–æ–∑—É"
                                            required
                                        ></textarea>
                                    </div>
                                    <div>
                                    <label for="receipt_image_{{ event_data.as_recipient.get('id') }}" style="font-weight: 600;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–¥–∞—Ä–∫–∞</label>
                                        <input
                                            type="file"
                                            id="receipt_image_{{ event_data.as_recipient.get('id') }}"
                                            name="receipt_image"
                                            accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                                            class="setting-input"
                                            required
                                        >
                                    <span style="font-size: 0.85rem;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è PNG, JPG, JPEG, GIF, WEBP.</span>
                                    </div>
                                    <button type="submit" class="btn btn-light">–ü–æ–ª—É—á–∏–ª</button>
                                </form>
                                {% else %}
                                <p style="margin: 0.5rem 0; opacity: 0.85;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —É–∂–µ –Ω–µ–ª—å–∑—è.</p>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px;">
                            <p style="margin: 0.5rem 0; opacity: 0.9;">–î–µ–¥ –ú–æ—Ä–æ–∑ –µ—â–µ –Ω–µ –æ—Ç–º–µ—Ç–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ–¥–∞—Ä–∫–∞.</p>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="assignment-card" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 2px dashed var(--border-color); text-align: center; color: var(--text-secondary);">
                        <span style="font-size: 2rem; display: block; margin-bottom: 0.5rem;">üéÅ</span>
                        <p style="margin: 0;">–í—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º –ø–æ–¥–∞—Ä–∫–∞</p>
                    </div>
                    {% endif %}
                </div>
                </div>
            </details>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <p style="font-size: 1.2rem; color: var(--text-secondary); text-align: center; padding: 3rem;">
                –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π. –ó–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
            </p>
        </div>
        {% endif %}
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterButtons = document.querySelectorAll('.assignments-filter-btn');
    const eventCards = document.querySelectorAll('.assignment-event-card');

    if (!filterButtons.length) {
        return;
    }

    filterButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const target = button.getAttribute('data-filter');
            filterButtons.forEach((btn) => btn.classList.remove('is-active'));
            button.classList.add('is-active');

            eventCards.forEach((card) => {
                const matches = target === 'all' || card.getAttribute('data-event-id') === target;
                card.classList.toggle('is-hidden', !matches);
                if (matches && target !== 'all') {
                    card.open = true;
                }
            });
        });
    });
});
</script>
{% endblock %}

