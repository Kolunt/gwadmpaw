{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–µ–¥—ã –ú–æ—Ä–æ–∑—ã{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="profile-card">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        
        {% if user.avatar_seed %}
        <div class="profile-avatar">
            <img id="avatar-preview" src="{{ get_avatar_url(user.avatar_seed, user.avatar_style or 'avataaars') }}" alt="–ê–≤–∞—Ç–∞—Ä {{ user.username }}" class="avatar-large">
            <button type="button" id="change-avatar-btn" class="btn btn-primary" style="margin-top: 1rem;">–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
            <div id="avatar-selected-indicator" style="display: none; margin-top: 0.5rem; color: var(--success-color); font-size: 0.9rem;">
                ‚úì –ù–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä –≤—ã–±—Ä–∞–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞–∂–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –Ω–∏–∂–µ.
            </div>
        </div>
        {% endif %}
        
        <form method="POST" class="profile-edit-form">
            <div class="form-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ GWars (–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è)</h3>
                <div class="readonly-info">
                    <div class="info-row">
                        <span class="info-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                        <span class="info-value">{{ user.user_id }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ò–º—è –≤ GWars:</span>
                        <span class="info-value">{{ user.username }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–£—Ä–æ–≤–µ–Ω—å:</span>
                        <span class="info-value">{{ user.level }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–°–∏–Ω–¥–∏–∫–∞—Ç:</span>
                        <span class="info-value">{{ user.synd }}</span>
                    </div>
                </div>
            </div>
            
            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ -->
            <input type="hidden" id="avatar_seed" name="avatar_seed" value="">
            <input type="hidden" id="avatar_style" name="avatar_style" value="{{ user.avatar_style or 'avataaars' }}">
            
            <div class="form-section">
                <h3>–í–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è)</h3>
                
                <div class="form-group">
                    <label for="bio" class="form-label">
                        –û —Å–µ–±–µ
                        <small class="form-hint">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small>
                    </label>
                    <textarea 
                        id="bio" 
                        name="bio" 
                        class="form-textarea"
                        rows="5"
                        placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."
                    >{{ user.bio or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="contact_info" class="form-label">
                        –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        <small class="form-hint">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –æ—á–µ–Ω—å –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –≤—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö "–ê–Ω–æ–Ω–∏–º–Ω—ã–π –î–µ–¥ –ú–æ—Ä–æ–∑")</small>
                    </label>
                    <textarea 
                        id="contact_info" 
                        name="contact_info" 
                        class="form-textarea"
                        rows="3"
                        placeholder="–í–∞—à–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."
                    >{{ user.contact_info or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">
                        Email
                        <small class="form-hint">–ê–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small>
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input"
                        placeholder="example@mail.com"
                        value="{{ user.email or '' }}"
                    >
                </div>
                
                <div class="form-group">
                    <label for="phone" class="form-label">
                        –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        <small class="form-hint">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small>
                    </label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone" 
                        class="form-input"
                        placeholder="+7 (999) 123-45-67"
                        value="{{ user.phone or '' }}"
                    >
                </div>
                
                <div class="form-group">
                    <label for="telegram" class="form-label">
                        Telegram
                        <small class="form-hint">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (–±–µ–∑ @) (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small>
                    </label>
                    <input 
                        type="text" 
                        id="telegram" 
                        name="telegram" 
                        class="form-input"
                        placeholder="username"
                        value="{{ user.telegram or '' }}"
                    >
                </div>
                
                <div class="form-group">
                    <label for="whatsapp" class="form-label">
                        WhatsApp
                        <small class="form-hint">–ù–æ–º–µ—Ä WhatsApp (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small>
                    </label>
                    <input 
                        type="tel" 
                        id="whatsapp" 
                        name="whatsapp" 
                        class="form-input"
                        placeholder="+7 (999) 123-45-67"
                        value="{{ user.whatsapp or '' }}"
                    >
                </div>
                
                <div class="form-group">
                    <label for="viber" class="form-label">
                        Viber
                        <small class="form-hint">–ù–æ–º–µ—Ä Viber (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</small>
                    </label>
                    <input 
                        type="tel" 
                        id="viber" 
                        name="viber" 
                        class="form-input"
                        placeholder="+7 (999) 123-45-67"
                        value="{{ user.viber or '' }}"
                    >
                </div>
            </div>
            
            <div class="form-section">
                <h3>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)</h3>
                
                <div class="form-group">
                    <label for="last_name" class="form-label">
                        –§–∞–º–∏–ª–∏—è *
                    </label>
                    <input 
                        type="text" 
                        id="last_name" 
                        name="last_name" 
                        class="form-input"
                        placeholder="–ò–≤–∞–Ω–æ–≤"
                        value="{{ user.last_name or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="first_name" class="form-label">
                        –ò–º—è *
                    </label>
                    <input 
                        type="text" 
                        id="first_name" 
                        name="first_name" 
                        class="form-input"
                        placeholder="–ò–≤–∞–Ω"
                        value="{{ user.first_name or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="middle_name" class="form-label">
                        –û—Ç—á–µ—Å—Ç–≤–æ *
                    </label>
                    <input 
                        type="text" 
                        id="middle_name" 
                        name="middle_name" 
                        class="form-input"
                        placeholder="–ò–≤–∞–Ω–æ–≤–∏—á"
                        value="{{ user.middle_name or '' }}"
                        required
                    >
                </div>
            </div>
            
            <div class="form-section">
                <h3>–ê–¥—Ä–µ—Å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)</h3>
                
                <div class="form-group">
                    <label for="postal_code" class="form-label">
                        –ò–Ω–¥–µ–∫—Å *
                    </label>
                    <input 
                        type="text" 
                        id="postal_code" 
                        name="postal_code" 
                        class="form-input"
                        placeholder="123456"
                        value="{{ user.postal_code or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="country" class="form-label">
                        –°—Ç—Ä–∞–Ω–∞ *
                    </label>
                    <input 
                        type="text" 
                        id="country" 
                        name="country" 
                        class="form-input"
                        placeholder="–†–æ—Å—Å–∏—è"
                        value="{{ user.country or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="city" class="form-label">
                        –ì–æ—Ä–æ–¥ *
                    </label>
                    <input 
                        type="text" 
                        id="city" 
                        name="city" 
                        class="form-input"
                        placeholder="–ú–æ—Å–∫–≤–∞"
                        value="{{ user.city or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="street" class="form-label">
                        –£–ª–∏—Ü–∞ *
                    </label>
                    <input 
                        type="text" 
                        id="street" 
                        name="street" 
                        class="form-input"
                        placeholder="–õ–µ–Ω–∏–Ω–∞"
                        value="{{ user.street or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="house" class="form-label">
                        –î–æ–º *
                    </label>
                    <input 
                        type="text" 
                        id="house" 
                        name="house" 
                        class="form-input"
                        placeholder="10"
                        value="{{ user.house or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="building" class="form-label">
                        –ö–æ—Ä–ø—É—Å/–°—Ç—Ä–æ–µ–Ω–∏–µ *
                    </label>
                    <input 
                        type="text" 
                        id="building" 
                        name="building" 
                        class="form-input"
                        placeholder="1"
                        value="{{ user.building or '' }}"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="apartment" class="form-label">
                        –ö–≤–∞—Ä—Ç–∏—Ä–∞ *
                    </label>
                    <input 
                        type="text" 
                        id="apartment" 
                        name="apartment" 
                        class="form-input"
                        placeholder="25"
                        value="{{ user.apartment or '' }}"
                        required
                    >
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                {% if session.user_id and 'admin' in session.get('roles', []) %}
                <button type="button" id="clear-profile-btn" class="btn btn-danger" title="–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ" style="margin-left: auto;">
                    üóëÔ∏è
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->
<div id="avatar-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>–í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞</h2>
            <button type="button" class="modal-close" id="close-avatar-modal">&times;</button>
        </div>
        
        <div class="modal-body">
            <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div id="step-category" class="avatar-modal-step">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∞–≤–∞—Ç–∞—Ä–∞</h3>
                <div class="avatar-styles-grid">
                    {% set avatar_styles = [
                        {'value': 'adventurer', 'name': 'Adventurer', 'preview_seed': 'preview1'},
                        {'value': 'adventurer-neutral', 'name': 'Adventurer Neutral', 'preview_seed': 'preview2'},
                        {'value': 'avataaars', 'name': 'Avataaars', 'preview_seed': 'preview3'},
                        {'value': 'avataaars-neutral', 'name': 'Avataaars Neutral', 'preview_seed': 'preview4'},
                        {'value': 'big-ears', 'name': 'Big Ears', 'preview_seed': 'preview5'},
                        {'value': 'big-ears-neutral', 'name': 'Big Ears Neutral', 'preview_seed': 'preview6'},
                        {'value': 'big-smile', 'name': 'Big Smile', 'preview_seed': 'preview7'},
                        {'value': 'bottts', 'name': 'Bottts', 'preview_seed': 'preview8'},
                        {'value': 'bottts-neutral', 'name': 'Bottts Neutral', 'preview_seed': 'preview9'},
                        {'value': 'croodles', 'name': 'Croodles', 'preview_seed': 'preview10'},
                        {'value': 'croodles-neutral', 'name': 'Croodles Neutral', 'preview_seed': 'preview11'},
                        {'value': 'fun-emoji', 'name': 'Fun Emoji', 'preview_seed': 'preview12'},
                        {'value': 'icons', 'name': 'Icons', 'preview_seed': 'preview13'},
                        {'value': 'identicon', 'name': 'Identicon', 'preview_seed': 'preview14'},
                        {'value': 'initials', 'name': 'Initials', 'preview_seed': 'preview15'},
                        {'value': 'lorelei', 'name': 'Lorelei', 'preview_seed': 'preview16'},
                        {'value': 'lorelei-neutral', 'name': 'Lorelei Neutral', 'preview_seed': 'preview17'},
                        {'value': 'micah', 'name': 'Micah', 'preview_seed': 'preview18'},
                        {'value': 'miniavs', 'name': 'Mini Avatars', 'preview_seed': 'preview19'},
                        {'value': 'open-peeps', 'name': 'Open Peeps', 'preview_seed': 'preview20'},
                        {'value': 'personas', 'name': 'Personas', 'preview_seed': 'preview21'},
                        {'value': 'pixel-art', 'name': 'Pixel Art', 'preview_seed': 'preview22'},
                        {'value': 'pixel-art-neutral', 'name': 'Pixel Art Neutral', 'preview_seed': 'preview23'},
                        {'value': 'rings', 'name': 'Rings', 'preview_seed': 'preview24'},
                        {'value': 'shapes', 'name': 'Shapes', 'preview_seed': 'preview25'},
                        {'value': 'thumbs', 'name': 'Thumbs', 'preview_seed': 'preview26'}
                    ] %}
                    
                    {% for style in avatar_styles %}
                    <button type="button" class="avatar-style-option category-select" data-style="{{ style.value }}">
                        <div class="avatar-style-preview">
                            <img 
                                src="https://api.dicebear.com/7.x/{{ style.value }}/svg?seed={{ style.preview_seed }}&size=80" 
                                alt="{{ style.name }}"
                                class="avatar-preview-img"
                            >
                        </div>
                        <span class="avatar-style-name">{{ style.name }}</span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            
            <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ -->
            <div id="step-avatar" class="avatar-modal-step" style="display: none;">
                <div class="step-header">
                    <button type="button" class="btn btn-secondary btn-back" id="back-to-category">‚Üê –ù–∞–∑–∞–¥</button>
                    <h3 id="selected-category-name">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</h3>
                </div>
                <div id="avatar-candidates-grid" class="avatar-candidates-grid">
                    <div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤...</div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-avatar-modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" id="save-avatar-btn" style="display: none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const changeAvatarBtn = document.getElementById('change-avatar-btn');
    const avatarModal = document.getElementById('avatar-modal');
    const closeModalBtn = document.getElementById('close-avatar-modal');
    const cancelModalBtn = document.getElementById('cancel-avatar-modal');
    const backToCategoryBtn = document.getElementById('back-to-category');
    const categorySelectBtns = document.querySelectorAll('.category-select');
    const stepCategory = document.getElementById('step-category');
    const stepAvatar = document.getElementById('step-avatar');
    const avatarCandidatesGrid = document.getElementById('avatar-candidates-grid');
    const selectedCategoryName = document.getElementById('selected-category-name');
    const saveAvatarBtn = document.getElementById('save-avatar-btn');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarSeedInput = document.getElementById('avatar_seed');
    const avatarStyleInput = document.getElementById('avatar_style');
    
    let selectedAvatarSeed = null;
    let selectedAvatarStyle = null;
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (changeAvatarBtn) {
        changeAvatarBtn.addEventListener('click', function() {
            avatarModal.style.display = 'block';
            resetModal();
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        avatarModal.style.display = 'none';
        resetModal();
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    
    if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', closeModal);
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    avatarModal.addEventListener('click', function(e) {
        if (e.target === avatarModal) {
            closeModal();
        }
    });
    
    // –°–±—Ä–æ—Å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function resetModal() {
        stepCategory.style.display = 'block';
        stepAvatar.style.display = 'none';
        saveAvatarBtn.style.display = 'none';
        selectedAvatarSeed = null;
        selectedAvatarStyle = null;
        avatarCandidatesGrid.innerHTML = '<div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤...</div>';
    }
    
    // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    categorySelectBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const style = this.getAttribute('data-style');
            selectedAvatarStyle = style;
            loadAvatarCandidates(style);
        });
    });
    
    // –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (backToCategoryBtn) {
        backToCategoryBtn.addEventListener('click', function() {
            stepCategory.style.display = 'block';
            stepAvatar.style.display = 'none';
            saveAvatarBtn.style.display = 'none';
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∞–≤–∞—Ç–∞—Ä–æ–≤
    function loadAvatarCandidates(style) {
        avatarCandidatesGrid.innerHTML = '<div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤...</div>';
        
        fetch(`/api/avatar/candidates?style=${style}&count=32`)
            .then(response => response.json())
            .then(data => {
                if (data.candidates && data.candidates.length > 0) {
                    avatarCandidatesGrid.innerHTML = '';
                    data.candidates.forEach((candidate, index) => {
                        const avatarItem = document.createElement('div');
                        avatarItem.className = 'avatar-candidate-item';
                        avatarItem.innerHTML = `
                            <img src="${candidate.url}" alt="Avatar ${index + 1}" class="avatar-candidate-img">
                            <span class="avatar-candidate-label">${index + 1}</span>
                        `;
                        avatarItem.addEventListener('click', function() {
                            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö
                            document.querySelectorAll('.avatar-candidate-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π
                            this.classList.add('selected');
                            selectedAvatarSeed = candidate.seed;
                            saveAvatarBtn.style.display = 'block';
                        });
                        avatarCandidatesGrid.appendChild(avatarItem);
                    });
                } else {
                    avatarCandidatesGrid.innerHTML = '<p class="text-muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>';
                }
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
                stepCategory.style.display = 'none';
                stepAvatar.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categoryName = document.querySelector(`[data-style="${style}"] .avatar-style-name`).textContent;
                selectedCategoryName.textContent = `–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä: ${categoryName}`;
            })
            .catch(error => {
                console.error('Error loading avatar candidates:', error);
                avatarCandidatesGrid.innerHTML = '<p class="text-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>';
            });
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
    if (saveAvatarBtn) {
        saveAvatarBtn.addEventListener('click', function() {
            if (selectedAvatarSeed && selectedAvatarStyle) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                if (avatarSeedInput) {
                    avatarSeedInput.value = selectedAvatarSeed;
                    console.log('Avatar seed set to:', selectedAvatarSeed);
                }
                if (avatarStyleInput) {
                    avatarStyleInput.value = selectedAvatarStyle;
                    console.log('Avatar style set to:', selectedAvatarStyle);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                if (avatarPreview) {
                    avatarPreview.src = `https://api.dicebear.com/7.x/${selectedAvatarStyle}/svg?seed=${selectedAvatarSeed}&size=128`;
                }
                
                closeModal();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const form = document.querySelector('.profile-edit-form');
                if (form) {
                    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É submit –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                    const submitBtn = document.createElement('button');
                    submitBtn.type = 'submit';
                    submitBtn.style.display = 'none';
                    form.appendChild(submitBtn);
                    submitBtn.click();
                    form.removeChild(submitBtn);
                }
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä');
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
    const clearProfileBtn = document.getElementById('clear-profile-btn');
    if (clearProfileBtn) {
        clearProfileBtn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å—Ç–µ—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                fetch('/profile/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—á–∏—â–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
                        location.reload();
                    } else {
                        alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø—Ä–æ—Ñ–∏–ª—è');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                });
            }
        });
    }
});
</script>
{% endblock %}
