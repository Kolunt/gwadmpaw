{% extends "base.html" %}

{% block title %}–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ {{ event.name }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
            <p class="text-muted" style="margin: 0;">{{ event.name }}</p>
        </div>
        <div class="event-header-actions">
            <a href="{{ url_for('admin_event_view', event_id=event.id) }}" class="btn-icon" title="–ù–∞–∑–∞–¥ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é">‚Üê</a>
            <a href="{{ url_for('admin_event_participants', event_id=event.id) }}" class="btn-icon" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–∞–¥–º–∏–Ω)">üë•</a>
        </div>
    </div>

    <div class="event-meta-card">
        <div class="event-meta-item">
            <span class="event-meta-label">–°—Ç–∞—Ç—É—Å –æ—Ç–±–æ—Ä–∞</span>
            <span class="event-meta-value">–ü–æ–∑–∏—Ç–∏–≤ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã)</span>
        </div>
        <div class="event-meta-item">
            <span class="event-meta-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ</span>
            <span class="event-meta-value">{{ participants_count }}</span>
        </div>
    </div>

    {# –¢–∞–±—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã #}
    <div class="tabs-container">
        <a href="{{ url_for('admin_event_distribution_positive_view', event_id=event.id) }}?tab=all" class="tab-button {% if not request.args.get('tab') or request.args.get('tab') == 'all' %}active{% endif %}" data-tab="all" onclick="return switchParticipantsTab('all', arguments[0])">
            –í—Å–µ <span class="tab-count" id="tab-count-all">{{ participants_count }}</span>
        </a>
        <a href="{{ url_for('admin_event_distribution_positive_view', event_id=event.id) }}?tab=formed" class="tab-button {% if request.args.get('tab') == 'formed' %}active{% endif %}" data-tab="formed" onclick="return switchParticipantsTab('formed', arguments[0])">
            –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ <span class="tab-count" id="tab-count-formed">{{ (participants_with_pairs|list|length) }}</span>
        </a>
        <a href="{{ url_for('admin_event_distribution_positive_view', event_id=event.id) }}?tab=unformed" class="tab-button {% if request.args.get('tab') == 'unformed' %}active{% endif %}" data-tab="unformed" onclick="return switchParticipantsTab('unformed', arguments[0])">
            –ù–µ—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ <span class="tab-count" id="tab-count-unformed">{{ participants_count - (participants_with_pairs|list|length) }}</span>
        </a>
    </div>

    <div class="event-view-card participants-section" style="margin-bottom: 1.5rem;">
        <div class="settings-section">
            <h2 class="section-title" style="margin-bottom: 1rem;">–ü–æ–∑–∏—Ç–∏–≤-—É—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
            
            {% if participants_count > 0 %}
            <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
            <div class="table-controls" style="margin-bottom: 1rem;">
                <div class="search-box" style="position: relative; max-width: 400px;">
                    <input 
                        type="text" 
                        id="participants-search-input" 
                        class="search-input" 
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º..."
                        autocomplete="off"
                        style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 0.75rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card, #fff); color: var(--text-primary);"
                    >
                    <span class="search-icon" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary, #666);">üîç</span>
                </div>
                <div class="table-info" style="margin-top: 0.5rem; color: var(--text-secondary, #666); font-size: 0.9rem;">
                    <span id="participants-search-count">–ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="participants-visible-count">{{ participants_count }}</strong> –∏–∑ <strong id="participants-total-count">{{ participants_count }}</strong></span>
                </div>
            </div>
            {% endif %}
            
            {% if participants_count == 0 %}
            <div class="alert alert-info">
                –ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
            </div>
            {% else %}
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                –û–ø—Ü–∏—è ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ. –ü—Ä–∏ —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –ø–∞—Ä—ã –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é.
            </div>
            
            <div class="table-container">
                <table class="admin-table participants-table">
                    <thead>
                        <tr>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                            <th>–°—Ç—Ä–∞–Ω–∞</th>
                            <th>–°—Ç—Ä–∞–Ω–∞ / –ì–æ—Ä–æ–¥</th>
                            <th>–ê–¥—Ä–µ—Å</th>
                            <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                            <th>–ó–∞–º–µ—Ç–∫–∏</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in participants %}
                        <tr data-participant-id="{{ p.user_id }}" 
                            class="participant-row {% if p.user_id in participants_with_pairs %}participant-formed{% else %}participant-unformed{% endif %}"
                            data-has-pair="{% if p.user_id in participants_with_pairs %}true{% else %}false{% endif %}">
                            <td data-label="–£—á–∞—Å—Ç–Ω–∏–∫">
                                <div class="table-primary-text">{{ p.last_name }} {{ p.first_name }} {{ p.middle_name }}</div>
                                <div class="table-secondary-text">{{ p.username }}</div>
                            </td>
                            <td data-label="–°—Ç—Ä–∞–Ω–∞">
                                {% set addr = p.address %}
                                <div class="table-secondary-text">{{ addr.country or '‚Äî' }}</div>
                            </td>
                            <td data-label="–°—Ç—Ä–∞–Ω–∞ / –ì–æ—Ä–æ–¥">
                                <div class="table-secondary-text">
                                    {% if addr.country or addr.city %}
                                        {{ addr.country or '‚Äî' }}{% if addr.city %} / {{ addr.city }}{% endif %}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="–ê–¥—Ä–µ—Å">
                                {% set addr = p.address %}
                                {% if addr.postal_code or addr.country or addr.city or addr.street %}
                                    <div class="table-secondary-text">
                                        {{ addr.postal_code or '‚Äî' }}, {{ addr.country or '‚Äî' }}, {{ addr.city or '‚Äî' }}<br>
                                        {{ addr.street or '‚Äî' }}, {{ addr.house or '‚Äî' }}{% if addr.building %}, –∫–æ—Ä–ø. {{ addr.building }}{% endif %}{% if addr.apartment %}, –∫–≤. {{ addr.apartment }}{% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td data-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã">
                                {% set c = p.contacts %}
                                {% if c.phone %}
                                <div>
                                    <a class="contact-link" href="tel:{{ c.phone }}">{{ c.phone }}</a>
                                    {% set phone_clean = c.phone|replace('+','')|replace(' ','')|replace('-','')|replace('(','')|replace(')','') %}
                                    {% set telegram_url = 'https://t.me/' ~ phone_clean %}
                                    <span style="margin-left: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;">
                                        <a class="contact-link" href="{{ telegram_url }}" target="_blank" rel="noopener">Telegram</a>
                                        <button type="button" 
                                                class="btn-icon-copy" 
                                                onclick="copyToClipboard('{{ telegram_url }}', this)"
                                                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL Telegram"
                                                style="background: none; border: none; cursor: pointer; padding: 0.25rem; display: inline-flex; align-items: center; color: var(--text-secondary); font-size: 0.9em;">
                                            üìã
                                        </button>
                                    </span>
                                </div>
                                {% endif %}
                                {% if c.telegram and c.telegram != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="https://t.me/{{ c.telegram|replace('@','') }}" target="_blank" rel="noopener">Telegram</a></div>
                                {% endif %}
                                {% if c.whatsapp and c.whatsapp != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="https://wa.me/{{ c.whatsapp|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">WhatsApp</a></div>
                                {% endif %}
                                {% if c.viber and c.viber != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="viber://chat?number={{ c.viber|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">Viber</a></div>
                                {% endif %}
                                {% if not c.phone and (not c.telegram or c.telegram == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') and (not c.whatsapp or c.whatsapp == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') and (not c.viber or c.viber == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') %}
                                <div class="table-secondary-text">‚Äî</div>
                                {% endif %}
                            </td>
                            <td data-label="–ó–∞–º–µ—Ç–∫–∏">{{ p.notes or '‚Äî' }}</td>
                            <td data-label="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">{{ p.registered_at or '‚Äî' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º —Ç–∞–±–ª–∏—Ü—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    function performParticipantsSearch() {
        const searchInput = document.getElementById('participants-search-input');
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.toLowerCase().trim();
        const rows = document.querySelectorAll('.participants-table tbody tr.participant-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
            const rowText = row.textContent.toLowerCase();
            const matches = !searchTerm || rowText.includes(searchTerm);
            
            // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
            const activeTab = document.querySelector('.tab-button.active')?.dataset.tab || 'all';
            const hasPair = row.dataset.hasPair === 'true';
            
            let shouldShow = matches;
            
            if (activeTab === 'formed') {
                shouldShow = matches && hasPair;
            } else if (activeTab === 'unformed') {
                shouldShow = matches && !hasPair;
            }
            
            if (shouldShow) {
                row.classList.remove('hidden');
                visibleCount++;
            } else {
                row.classList.add('hidden');
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        const visibleCountEl = document.getElementById('participants-visible-count');
        if (visibleCountEl) {
            visibleCountEl.textContent = visibleCount;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º —Ç–∞–±–ª–∏—Ü—ã –ø–∞—Ä
    function performPairsSearch() {
        const searchInput = document.getElementById('pairs-search-input');
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#distribution-results-body tr');
        let visibleCount = 0;
        const totalCount = rows.length;
        
        rows.forEach(row => {
            // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
            const rowText = row.textContent.toLowerCase();
            const matches = !searchTerm || rowText.includes(searchTerm);
            
            if (matches) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        const visibleCountEl = document.getElementById('pairs-visible-count');
        const totalCountEl = document.getElementById('pairs-total-count');
        if (visibleCountEl) {
            visibleCountEl.textContent = visibleCount;
        }
        if (totalCountEl && totalCount > 0) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏
            totalCountEl.textContent = totalCount;
        }
    }
    
    function switchParticipantsTab(tabName, clickEvent) {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        if (clickEvent) {
            clickEvent.preventDefault();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({ tab: tabName }, '', url);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Ç–∞–±–∞
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tabName) {
                btn.classList.add('active');
            }
        });
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–≥–æ —Ç–∞–±–∞
        performParticipantsSearch();
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        const rows = document.querySelectorAll('.participants-table tbody tr.participant-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const hasPair = row.dataset.hasPair === 'true';
            
            if (tabName === 'all') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö
                row.classList.remove('hidden');
                visibleCount++;
            } else if (tabName === 'formed') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ –µ—Å—Ç—å –ø–∞—Ä–∞
                if (hasPair) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            } else if (tabName === 'unformed') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ –ù–ï–¢ –ø–∞—Ä—ã
                if (!hasPair) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            } else {
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã–≤–∞–µ–º
                row.classList.add('hidden');
            }
        });
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∞–±–∞–º
        performParticipantsSearch();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        console.log(`Tab "${tabName}": showing ${visibleCount} participants`);
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é —Å–µ–∫—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∞–±–∞
        // –¢–∞–±—ã –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ–∫—Ü–∏–π
        const participantsSection = document.querySelector('.participants-section');
        const distributionSection = document.querySelector('.distribution-section');
        const distributionResults = document.getElementById('distribution-results');
        const hasPairs = distributionResults && distributionResults.querySelector('tbody tr');
        
        if (tabName === 'all') {
            // –ù–∞ —Ç–∞–±–µ "all" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∞—Ä
            if (participantsSection) {
                participantsSection.style.display = 'block';
            }
            if (distributionSection) {
                distributionSection.style.display = 'none';
            }
        } else if (tabName === 'formed') {
            // –ù–∞ —Ç–∞–±–µ "formed" —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—É –ø–∞—Ä
            if (participantsSection) {
                participantsSection.style.display = 'none';
            }
            if (distributionSection) {
                distributionSection.style.display = 'block';
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∞—Ä, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã
            const hasRenderedPairs = distributionResults && distributionResults.querySelector('tbody tr');
            const hasSavedPairs = typeof existingPairs !== 'undefined' && existingPairs && existingPairs.length > 0;
            
            if (hasRenderedPairs || hasSavedPairs) {
                if (distributionResults) {
                    distributionResults.style.display = 'block';
                }
                // –ï—Å–ª–∏ –ø–∞—Ä—ã –Ω–µ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã, –Ω–æ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ - —Ä–µ–Ω–¥–µ—Ä–∏–º –∏—Ö
                if (!hasRenderedPairs && hasSavedPairs) {
                    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã
                    const initialLocks = existingPairs
                        .filter(pair => pair && pair.locked)
                        .map(pair => ({
                            santa_id: pair.santa_id,
                            recipient_id: pair.recipient_id
                        }));
                    renderPairs(existingPairs, { markDirty: false, locks: initialLocks, assignedLocks: lockedFromAssignments || [] });
                }
            }
        } else if (tabName === 'unformed') {
            // –ù–∞ —Ç–∞–±–µ "unformed" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∞—Ä
            if (participantsSection) {
                participantsSection.style.display = 'block';
            }
            if (distributionSection) {
                distributionSection.style.display = 'none';
            }
        }
        
        return false; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –±—Ä–∞—É–∑–µ—Ä–∞ "–ù–∞–∑–∞–¥/–í–ø–µ—Ä–µ–¥"
    window.addEventListener('popstate', function(event) {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab') || 'all';
        switchParticipantsTab(tab, null);
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    function updateParticipantsStatus(pairs) {
        // –°–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –ø–∞—Ä–∞–º–∏
        const participantsWithPairs = new Set();
        pairs.forEach(pair => {
            participantsWithPairs.add(pair.santa_id);
            participantsWithPairs.add(pair.recipient_id);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        const rows = document.querySelectorAll('.participants-table tbody tr.participant-row');
        let formedCount = 0;
        let unformedCount = 0;
        
        rows.forEach(row => {
            const participantIdAttr = row.getAttribute('data-participant-id');
            if (!participantIdAttr) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ ID
            }
            const participantId = parseInt(participantIdAttr);
            if (isNaN(participantId) || participantId === 0) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ ID
            }
            
            const hasPair = participantsWithPairs.has(participantId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏ –∞—Ç—Ä–∏–±—É—Ç—ã
            row.classList.remove('participant-formed', 'participant-unformed');
            if (hasPair) {
                row.classList.add('participant-formed');
                row.dataset.hasPair = 'true';
                formedCount++;
            } else {
                row.classList.add('participant-unformed');
                row.dataset.hasPair = 'false';
                unformedCount++;
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ —Ç–∞–±–∞—Ö
        const totalCount = rows.length;
        const formedCountEl = document.getElementById('tab-count-formed');
        const unformedCountEl = document.getElementById('tab-count-unformed');
        const allCountEl = document.getElementById('tab-count-all');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –±–µ–∑ —Å–∫–æ–±–æ–∫ (–∫–∞–∫ –≤ —à–∞–±–ª–æ–Ω–µ)
        if (formedCountEl) {
            formedCountEl.textContent = formedCount;
        }
        if (unformedCountEl) {
            unformedCountEl.textContent = unformedCount;
        }
        if (allCountEl) {
            allCountEl.textContent = totalCount;
        }
        
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–± –∞–∫—Ç–∏–≤–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const activeTab = document.querySelector('.tab-button.active');
        if (activeTab) {
            switchParticipantsTab(activeTab.dataset.tab);
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–± –∏–∑ URL
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
        const searchInput = document.getElementById('participants-search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                performParticipantsSearch();
            });
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ Escape
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    performParticipantsSearch();
                }
            });
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab') || 'all';
        // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ tab –∏–º–µ–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const validTabs = ['all', 'formed', 'unformed'];
        const activeTab = validTabs.includes(tab) ? tab : 'all';
        // –ï—Å–ª–∏ –≤ URL –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ tab –∏–ª–∏ –æ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        if (!urlParams.get('tab') || !validTabs.includes(tab)) {
            const url = new URL(window.location);
            url.searchParams.set('tab', activeTab);
            window.history.replaceState({ tab: activeTab }, '', url);
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–∞ (–≤–∫–ª—é—á–∞—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é —Å–µ–∫—Ü–∏–π)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤
        requestAnimationFrame(function() {
            requestAnimationFrame(function() {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã –∏ –º—ã –Ω–∞ —Ç–∞–±–µ "formed", —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –æ–Ω–∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã
                if (activeTab === 'formed' && typeof existingPairs !== 'undefined' && existingPairs && existingPairs.length > 0) {
                    const hasRenderedPairs = document.getElementById('distribution-results') && document.getElementById('distribution-results').querySelector('tbody tr');
                    if (!hasRenderedPairs) {
                        const initialLocks = existingPairs
                            .filter(pair => pair && pair.locked)
                            .map(pair => ({
                                santa_id: pair.santa_id,
                                recipient_id: pair.recipient_id
                            }));
                        renderPairs(existingPairs, { markDirty: false, locks: initialLocks, assignedLocks: lockedFromAssignments || [] });
                    }
                }
                switchParticipantsTab(activeTab, null);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–∞—Ä
                const pairsSearchInput = document.getElementById('pairs-search-input');
                if (pairsSearchInput) {
                    pairsSearchInput.addEventListener('input', function() {
                        performPairsSearch();
                    });
                    
                    pairsSearchInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            pairsSearchInput.value = '';
                            performPairsSearch();
                        }
                    });
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ç–∞–±–∞ "unformed" - —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å –ø–∞—Ä–∞–º–∏ —Å–∫—Ä—ã—Ç—ã
                if (activeTab === 'unformed') {
                    const rows = document.querySelectorAll('.participants-table tbody tr.participant-row');
                    let unformedCount = 0;
                    rows.forEach(row => {
                        const hasPair = row.dataset.hasPair === 'true';
                        if (hasPair) {
                            row.classList.add('hidden');
                        } else {
                            row.classList.remove('hidden');
                            unformedCount++;
                        }
                    });
                    console.log(`Unformed tab: showing ${unformedCount} participants without pairs`);
                }
            });
        });
    });
    </script>

    <div class="event-view-card distribution-section">
        <div class="settings-section">
            <div class="distribution-actions" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                <button id="generate-pairs-btn" class="btn btn-primary" {% if participants_count < 2 %}disabled{% endif %}>&#127922; –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <label class="checkbox-inline" style="display: flex; gap: 0.35rem; align-items: center;">
                    <input type="checkbox" id="distribute-same-country">
                    <span>–ü–æ —Å—Ç—Ä–∞–Ω–∞–º</span>
                </label>
                <span class="text-muted">–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º –∏ –í–Ω—É—á–∫–æ–º —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑.</span>
            </div>
            {% if participants_count < 2 %}
            <div class="alert alert-warning" style="margin-top: 1rem;">
                –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ú–∏–Ω–∏–º—É–º: 2 –ø–æ–∑–∏—Ç–∏–≤-—É—á–∞—Å—Ç–Ω–∏–∫–∞.
            </div>
            {% endif %}

            <div id="distribution-message" class="alert" style="display: none; margin-top: 1rem;"></div>

            <div class="table-container" id="distribution-results" style="display: none; margin-top: 1.5rem;">
                <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–∞—Ä -->
                <div class="table-controls" style="margin-bottom: 1rem;">
                    <div class="search-box" style="position: relative; max-width: 400px;">
                        <input 
                            type="text" 
                            id="pairs-search-input" 
                            class="search-input" 
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º..."
                            autocomplete="off"
                            style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 0.75rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card, #fff); color: var(--text-primary);"
                        >
                        <span class="search-icon" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary, #666);">üîç</span>
                    </div>
                    <div class="table-info" style="margin-top: 0.5rem; color: var(--text-secondary, #666); font-size: 0.9rem;">
                        <span id="pairs-search-count">–ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="pairs-visible-count">0</strong> –∏–∑ <strong id="pairs-total-count">0</strong></span>
                    </div>
                </div>
                <table class="admin-table" id="pairs-table">
                    <thead>
                        <tr>
                            <th>üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</th>
                            <th>üéÅ –í–Ω—É—á–æ–∫/–í–Ω—É—á–∫–∞</th>
                            <th class="distribution-status-col">–°—Ç–∞—Ç—É—Å</th>
                            <th class="distribution-actions-col">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="distribution-results-body"></tbody>
                </table>
                <p class="text-muted" style="margin-top: 0.75rem;">–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.</p>
                <div id="save-pairs-container" style="display: none; margin-top: 1rem;">
                    <button id="save-pairs-btn" class="btn btn-secondary" disabled>&#128190; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div id="create-assignments-container" style="display: none; margin-top: 1.25rem;">
                <button id="create-assignments-btn" class="btn btn-success">üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
            </div>
        </div>
    </div>
</div>

<script>
const generateUrl = {{ distribution_generate_url|tojson }};
const saveUrl = {{ distribution_save_url|tojson }};
const existingPairs = {{ saved_pairs|tojson }};
const lockedFromAssignments = {{ saved_locked_santas|tojson }};
const unassignUrl = {{ distribution_unassign_url|tojson }};
const generateBtn = document.getElementById('generate-pairs-btn');
const saveContainer = document.getElementById('save-pairs-container');
const saveBtn = document.getElementById('save-pairs-btn');
const assignmentsContainer = document.getElementById('create-assignments-container');
const assignmentsBtn = document.getElementById('create-assignments-btn');
const sameCountryToggle = document.getElementById('distribute-same-country');
const resultsSection = document.getElementById('distribution-results');
const resultsBody = document.getElementById('distribution-results-body');
const messageBox = document.getElementById('distribution-message');
let draggedCell = null;
let pendingChanges = false;
let currentLocksMap = {};
let assignedLockedPairs = {};
let removingAssignmentPromise = null;

function showMessage(text, type = 'info') {
    if (!messageBox) return;
    messageBox.className = 'alert alert-' + type;
    messageBox.textContent = text;
    messageBox.style.display = 'block';
}

function hideMessage() {
    if (!messageBox) return;
    messageBox.style.display = 'none';
}

function formatLocation(country, city) {
    if (!country && !city) {
        return '‚Äî';
    }
    if (country && city) {
        return `${country} / ${city}`;
    }
    return country || city || '‚Äî';
}

function updateRecipientCellDisplay(cell) {
    if (!cell) return;
    const nameEl = cell.querySelector('.table-primary-text');
    const locationEl = cell.querySelector('.table-secondary-text');
    if (nameEl) {
        nameEl.textContent = cell.dataset.recipientName || '‚Äî';
    }
    if (locationEl) {
        locationEl.textContent = formatLocation(cell.dataset.recipientCountry, cell.dataset.recipientCity);
    }
}

function markDirty() {
    pendingChanges = true;
    if (saveContainer) {
        saveContainer.style.display = 'block';
    }
    if (saveBtn) {
        saveBtn.disabled = false;
    }
    if (assignmentsContainer) {
        assignmentsContainer.style.display = 'none';
    }
    assignmentsBtn.disabled = true;
}

function updateAssignmentsButtonVisibility() {
    if (!assignmentsBtn || !assignmentsContainer) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä –≤ —Ç–∞–±–ª–∏—Ü–µ
    const hasPairs = resultsBody && resultsBody.querySelectorAll('tr').length > 0;
    const hasLocks = Object.keys(currentLocksMap).length > 0;
    const hasAssigned = Object.keys(assignedLockedPairs).length > 0;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä—ã (–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∏–ª–∏ –Ω–µ—Ç)
    if (hasPairs) {
        assignmentsContainer.style.display = 'block';
        // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã
        // –î–ª—è –Ω–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ä –∫–Ω–æ–ø–∫–∞ —Ç–æ–∂–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è
        // –ù–æ –ø–æ –ª–æ–≥–∏–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π —Ç—Ä–µ–±—É—é—Ç—Å—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã, –ø–æ—ç—Ç–æ–º—É –∫–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö
        assignmentsBtn.disabled = !hasLocks;
    } else {
        assignmentsContainer.style.display = 'none';
        assignmentsBtn.disabled = true;
    }
}

async function removeAssignmentForSanta(santaId) {
    if (!unassignUrl) {
        return { ok: false, message: 'URL –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.' };
    }
    try {
        const response = await fetch(unassignUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ santa_id: santaId })
        });
        const data = await response.json();
        if (response.ok && data.success) {
            return { ok: true, message: data.message || '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.' };
        }
        return { ok: false, message: data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.' };
    } catch (error) {
        console.error(error);
        return { ok: false, message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–¥–∞–Ω–∏—è.' };
    }
}

function updateRowLockState(row, locked, { silent = false } = {}) {
    if (!row) return;
    const lockButton = row.querySelector('.lock-toggle');
    const recipientCell = row.querySelector('.recipient-cell');
    row.dataset.locked = locked ? 'true' : 'false';

    const santaId = row.dataset.santaId;
    const isAssignedLock = assignedLockedPairs[santaId] !== undefined;

    if (locked) {
        row.classList.add('distribution-row-locked');
        if (lockButton) {
            lockButton.innerHTML = 'üîí';
            if (row.dataset.assigned === 'true') {
                lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É (–∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ)';
            } else {
                lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É';
            }
            lockButton.classList.add('locked');
            lockButton.classList.toggle('lock-fixed', row.dataset.assigned === 'true');
            lockButton.disabled = false;
        }
        if (recipientCell) {
            recipientCell.setAttribute('draggable', 'false');
        }
        currentLocksMap[row.dataset.santaId] = Number(row.dataset.recipientId);
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –ø–∞—Ä—É –≤–≤–µ—Ä—Ö —Å–ø–∏—Å–∫–∞
        if (resultsBody && row.parentNode === resultsBody) {
            const lockedRows = Array.from(resultsBody.querySelectorAll('tr[data-locked="true"]'));
            const unlockedRows = Array.from(resultsBody.querySelectorAll('tr[data-locked="false"]'));
            
            // –û—á–∏—â–∞–µ–º tbody
            resultsBody.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏)
            const sortedLocked = lockedRows.sort((a, b) => {
                const aName = (a.dataset.santaName || '').toLowerCase();
                const bName = (b.dataset.santaName || '').toLowerCase();
                return aName.localeCompare(bName);
            });
            sortedLocked.forEach(r => resultsBody.appendChild(r));
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏)
            const sortedUnlocked = unlockedRows.sort((a, b) => {
                const aName = (a.dataset.santaName || '').toLowerCase();
                const bName = (b.dataset.santaName || '').toLowerCase();
                return aName.localeCompare(bName);
            });
            sortedUnlocked.forEach(r => resultsBody.appendChild(r));
            
            // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag & drop
            attachDragHandlers();
        }
    } else {
        row.classList.remove('distribution-row-locked');
        if (lockButton) {
            lockButton.innerHTML = 'üîì';
            lockButton.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É';
            lockButton.classList.remove('locked');
            lockButton.classList.remove('lock-fixed');
            lockButton.disabled = false;
        }
        if (recipientCell) {
            recipientCell.setAttribute('draggable', 'true');
        }
        delete currentLocksMap[row.dataset.santaId];
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –ø–∞—Ä—É –≤–Ω–∏–∑ —Å–ø–∏—Å–∫–∞ (–∫ –Ω–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º)
        if (resultsBody && row.parentNode === resultsBody) {
            const lockedRows = Array.from(resultsBody.querySelectorAll('tr[data-locked="true"]'));
            const unlockedRows = Array.from(resultsBody.querySelectorAll('tr[data-locked="false"]'));
            
            // –û—á–∏—â–∞–µ–º tbody
            resultsBody.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏)
            const sortedLocked = lockedRows.sort((a, b) => {
                const aName = (a.dataset.santaName || '').toLowerCase();
                const bName = (b.dataset.santaName || '').toLowerCase();
                return aName.localeCompare(bName);
            });
            sortedLocked.forEach(r => resultsBody.appendChild(r));
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏)
            const sortedUnlocked = unlockedRows.sort((a, b) => {
                const aName = (a.dataset.santaName || '').toLowerCase();
                const bName = (b.dataset.santaName || '').toLowerCase();
                return aName.localeCompare(bName);
            });
            sortedUnlocked.forEach(r => resultsBody.appendChild(r));
            
            // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag & drop
            attachDragHandlers();
        }
    }

    if (!silent) {
        markDirty();
        showMessage(locked ? '–ü–∞—Ä–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞: –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π.' : '–ü–∞—Ä–∞ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∞: –æ–Ω–∞ –±—É–¥–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏.', 'info');
    }
    updateAssignmentsButtonVisibility();
}

function collectPairsFromTable() {
    if (!resultsBody) {
        console.warn('collectPairsFromTable: resultsBody not found');
        return [];
    }
    const rows = resultsBody.querySelectorAll('tr');
    if (!rows || rows.length === 0) {
        console.warn('collectPairsFromTable: No rows found');
        return [];
    }
    
    console.log(`collectPairsFromTable: Found ${rows.length} rows`);
    
    const pairs = Array.from(rows).map((row, index) => {
        const santaId = row.dataset.santaId;
        const recipientId = row.dataset.recipientId;
        
        if (!santaId || !recipientId) {
            console.warn(`collectPairsFromTable: Row ${index} missing IDs: santaId=${santaId}, recipientId=${recipientId}`);
            return null;
        }
        
        const santaIdNum = Number(santaId);
        const recipientIdNum = Number(recipientId);
        
        if (Number.isNaN(santaIdNum) || Number.isNaN(recipientIdNum)) {
            console.warn(`collectPairsFromTable: Row ${index} invalid IDs: santaId=${santaId}, recipientId=${recipientId}`);
            return null;
        }
        
        return {
            santa_id: santaIdNum,
            recipient_id: recipientIdNum
        };
    }).filter(pair => pair !== null && Number.isInteger(pair.santa_id) && Number.isInteger(pair.recipient_id));
    
    console.log(`collectPairsFromTable: Collected ${pairs.length} valid pairs`);
    return pairs;
}

function collectLockedPairs() {
    return Object.entries(currentLocksMap).map(([santaId, recipientId]) => ({
        santa_id: Number(santaId),
        recipient_id: Number(recipientId)
    }));
}

async function savePairs({ showSuccess = true } = {}) {
    if (!saveUrl) {
        return { ok: false, message: 'URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.' };
    }

    const pairs = collectPairsFromTable();
    if (!pairs || !Array.isArray(pairs) || pairs.length === 0) {
        const errorMsg = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ.';
        if (showSuccess) {
            showMessage(errorMsg, 'error');
        }
        return { ok: false, message: errorMsg };
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    const validPairs = pairs.filter(pair => {
        return pair && 
               typeof pair.santa_id === 'number' && 
               typeof pair.recipient_id === 'number' &&
               !Number.isNaN(pair.santa_id) && 
               !Number.isNaN(pair.recipient_id) &&
               pair.santa_id > 0 && 
               pair.recipient_id > 0 &&
               pair.santa_id !== pair.recipient_id;
    });

    if (validPairs.length !== pairs.length) {
        const errorMsg = '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.';
        if (showSuccess) {
            showMessage(errorMsg, 'error');
        }
        return { ok: false, message: errorMsg };
    }

    if (validPairs.length === 0) {
        const errorMsg = '–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–∞—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
        if (showSuccess) {
            showMessage(errorMsg, 'error');
        }
        return { ok: false, message: errorMsg };
    }

    if (saveBtn) {
        saveBtn.disabled = true;
    }
    if (saveContainer) {
        saveContainer.style.display = 'block';
    }

    try {
        const requestBody = {
            pairs: validPairs,
            enforce_country: sameCountryToggle ? sameCountryToggle.checked : false,
            locked_pairs: collectLockedPairs()
        };

        console.log('Saving pairs:', {
            pairsCount: validPairs.length,
            enforce_country: requestBody.enforce_country,
            locked_pairs_count: requestBody.locked_pairs.length,
            firstPair: validPairs[0],
            lastPair: validPairs[validPairs.length - 1]
        });

        const response = await fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(requestBody)
        });
        
        let data;
        try {
            const responseText = await response.text();
            console.log('Response status:', response.status);
            console.log('Response text:', responseText);
            
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('Failed to parse JSON:', parseError);
                throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + responseText.substring(0, 200));
            }
        } catch (parseError) {
            console.error('Failed to get response:', parseError);
            throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + (parseError.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        
        if (response.ok && data.success) {
            pendingChanges = false;
            if (saveBtn) {
                saveBtn.disabled = true;
            }
            if (saveContainer) {
                saveContainer.style.display = 'none';
            }
            const message = data.message || '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.';
            if (showSuccess) {
                showMessage(message, 'success');
            }
            return { ok: true, message };
        }
        if (saveBtn) {
            saveBtn.disabled = !pendingChanges;
        }
        if (saveContainer && pendingChanges) {
            saveContainer.style.display = 'block';
        }
        const errorMessage = data.error || `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. (HTTP ${response.status})`;
        if (showSuccess) {
            showMessage(errorMessage, 'error');
        }
        return { ok: false, message: errorMessage };
    } catch (error) {
        console.error('Error in savePairs:', error);
        if (saveBtn) {
            saveBtn.disabled = !pendingChanges;
        }
        if (saveContainer && pendingChanges) {
            saveContainer.style.display = 'block';
        }
        const errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: ' + (error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        if (showSuccess) {
            showMessage(errorMessage, 'error');
        }
        return { ok: false, message: errorMessage };
    }
}

function swapRecipients(a, b) {
    if (!a || !b) return;
    const tempId = a.dataset.recipientId;
    const tempName = a.dataset.recipientName;
    const tempCountry = a.dataset.recipientCountry;
    const tempCity = a.dataset.recipientCity;

    a.dataset.recipientId = b.dataset.recipientId;
    a.dataset.recipientName = b.dataset.recipientName;
    a.dataset.recipientCountry = b.dataset.recipientCountry;
    a.dataset.recipientCity = b.dataset.recipientCity;
    updateRecipientCellDisplay(a);

    b.dataset.recipientId = tempId;
    b.dataset.recipientName = tempName;
    b.dataset.recipientCountry = tempCountry;
    b.dataset.recipientCity = tempCity;
    updateRecipientCellDisplay(b);

    const santaRowA = a.closest('tr');
    const santaRowB = b.closest('tr');
    if (santaRowA && santaRowB) {
        santaRowA.dataset.recipientId = a.dataset.recipientId;
        santaRowA.dataset.recipientName = a.dataset.recipientName || '';
        santaRowA.dataset.recipientCountry = a.dataset.recipientCountry || '';
        santaRowA.dataset.recipientCity = a.dataset.recipientCity || '';
        santaRowB.dataset.recipientId = b.dataset.recipientId;
        santaRowB.dataset.recipientName = b.dataset.recipientName || '';
        santaRowB.dataset.recipientCountry = b.dataset.recipientCountry || '';
        santaRowB.dataset.recipientCity = b.dataset.recipientCity || '';
    }
}

function handleDragStart(event) {
    const row = event.currentTarget.closest('tr');
    if (row && row.dataset.locked === 'true') {
        event.preventDefault();
        return;
    }
    draggedCell = event.currentTarget;
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', draggedCell.dataset.recipientId);
    requestAnimationFrame(() => draggedCell.classList.add('is-dragging'));
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    const target = event.currentTarget;
    if (target !== draggedCell) {
        target.classList.add('drop-target');
    }
}

function handleDragEnter(event) {
    const target = event.currentTarget;
    if (target !== draggedCell) {
        target.classList.add('drop-target');
    }
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('drop-target');
}

function handleDrop(event) {
    event.preventDefault();
    const target = event.currentTarget;
    target.classList.remove('drop-target');
    if (!draggedCell || target === draggedCell) {
        return;
    }

    const draggedRow = draggedCell.closest('tr');
    const targetRow = target.closest('tr');
    if (!draggedRow || !targetRow) {
        return;
    }

    if (draggedRow.dataset.locked === 'true' || targetRow.dataset.locked === 'true') {
        showMessage('–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø–∞—Ä—ã –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é.', 'error');
        return;
    }

    const draggedSantaId = draggedRow.dataset.santaId;
    const draggedSantaCountry = draggedRow.dataset.santaCountry || '';
    const targetSantaId = targetRow.dataset.santaId;
    const targetSantaCountry = targetRow.dataset.santaCountry || '';
    const draggedRecipientId = draggedCell.dataset.recipientId;
    const draggedRecipientCountry = draggedCell.dataset.recipientCountry || '';
    const targetRecipientId = target.dataset.recipientId;
    const targetRecipientCountry = target.dataset.recipientCountry || '';

    if (draggedSantaId === targetRecipientId || targetSantaId === draggedRecipientId) {
        showMessage('–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.', 'error');
        return;
    }

    if (sameCountryToggle && sameCountryToggle.checked) {
        if (draggedSantaCountry && targetRecipientCountry && draggedSantaCountry !== targetRecipientCountry) {
            showMessage('–ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –î–µ–¥ –ú–æ—Ä–æ–∑ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã.', 'error');
            return;
        }
        if (targetSantaCountry && draggedRecipientCountry && targetSantaCountry !== draggedRecipientCountry) {
            showMessage('–ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –î–µ–¥ –ú–æ—Ä–æ–∑ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã.', 'error');
            return;
        }
    }

    swapRecipients(draggedCell, target);
    markDirty();
    showMessage('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.', 'info');
}

function handleDragEnd() {
    if (draggedCell) {
        draggedCell.classList.remove('is-dragging');
    }
    draggedCell = null;
    const cells = resultsBody ? resultsBody.querySelectorAll('.recipient-cell') : [];
    cells.forEach(cell => cell.classList.remove('drop-target'));
}

function attachDragHandlers() {
    if (!resultsBody) return;
    const cells = resultsBody.querySelectorAll('.recipient-cell');
    cells.forEach(cell => {
        cell.addEventListener('dragstart', handleDragStart);
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragenter', handleDragEnter);
        cell.addEventListener('dragleave', handleDragLeave);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('dragend', handleDragEnd);
    });
}

function renderPairs(pairs, options = {}) {
    if (!resultsBody) {
        console.error('resultsBody element not found');
        return;
    }
    
    if (!Array.isArray(pairs)) {
        console.error('pairs is not an array:', pairs);
        return;
    }
    
    const initialLockMap = {};
    if (Array.isArray(options.locks)) {
        options.locks.forEach(lock => {
            if (!lock || lock.santa_id == null || lock.recipient_id == null) return;
            const santaId = Number(lock.santa_id);
            const recipientId = Number(lock.recipient_id);
            if (!Number.isNaN(santaId) && !Number.isNaN(recipientId)) {
                initialLockMap[santaId] = recipientId;
            }
        });
    }

    currentLocksMap = {};
    assignedLockedPairs = {};
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
        const parent = resultsBody.parentElement;
        resultsBody.innerHTML = '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ –≤ DOM
        if (!parent || !parent.contains(resultsBody)) {
            console.error('resultsBody was removed from DOM');
            return;
        }
    } catch (error) {
        console.error('Error clearing resultsBody:', error);
        return;
    }
    
    const assignedSet = new Set((options.assignedLocks || []).map(Number));

    const formatLocation = (country, city) => {
        if (!country && !city) return '‚Äî';
        if (country && city) {
            return `${country} / ${city}`;
        }
        return country || city || '‚Äî';
    };

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä—ã: –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –≤–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
    const sortedPairs = [...pairs].sort((a, b) => {
        const aIsLocked = initialLockMap[Number(a.santa_id)] !== undefined;
        const bIsLocked = initialLockMap[Number(b.santa_id)] !== undefined;
        
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã
        if (aIsLocked && !bIsLocked) return -1;
        if (!aIsLocked && bIsLocked) return 1;
        
        // –ó–∞—Ç–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
        const aName = (a.santa_name || '').toLowerCase();
        const bName = (b.santa_name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    sortedPairs.forEach(pair => {
        const row = document.createElement('tr');
        const santaId = Number(pair.santa_id);
        const recipientId = Number(pair.recipient_id);
        row.dataset.santaId = santaId;
        row.dataset.santaName = pair.santa_name || ''; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        row.dataset.santaCountry = pair.santa_country || '';
        row.dataset.santaCity = pair.santa_city || '';
        row.dataset.recipientId = recipientId;
        row.dataset.recipientName = pair.recipient_name || '';
        row.dataset.recipientCountry = pair.recipient_country || '';
        row.dataset.recipientCity = pair.recipient_city || '';
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –ª–∏ –ø–∞—Ä–∞
        const isLocked = initialLockMap[santaId] !== undefined;
        row.dataset.locked = isLocked ? 'true' : 'false';
        row.dataset.assigned = 'false';

        const santaCell = document.createElement('td');
        santaCell.dataset.label = '–î–µ–¥ –ú–æ—Ä–æ–∑';
        const santaName = document.createElement('div');
        santaName.className = 'table-primary-text';
        const santaLink = document.createElement('a');
        santaLink.href = `/profile/${santaId}`;
        santaLink.target = '_blank';
        santaLink.rel = 'noopener noreferrer';
        santaLink.textContent = pair.santa_name;
        santaLink.style.textDecoration = 'none';
        santaLink.style.color = 'inherit';
        santaLink.style.cursor = 'pointer';
        santaLink.addEventListener('mouseenter', function() {
            this.style.textDecoration = 'underline';
        });
        santaLink.addEventListener('mouseleave', function() {
            this.style.textDecoration = 'none';
        });
        santaName.appendChild(santaLink);
        const santaLocation = document.createElement('div');
        santaLocation.className = 'table-secondary-text';
        santaLocation.textContent = formatLocation(pair.santa_country, pair.santa_city);
        santaCell.appendChild(santaName);
        santaCell.appendChild(santaLocation);

        const recipientCell = document.createElement('td');
        recipientCell.dataset.label = '–í–Ω—É—á–æ–∫/–í–Ω—É—á–∫–∞';
        recipientCell.dataset.recipientId = String(recipientId);
        recipientCell.dataset.recipientName = pair.recipient_name;
        recipientCell.dataset.recipientCountry = pair.recipient_country || '';
        recipientCell.dataset.recipientCity = pair.recipient_city || '';
        recipientCell.classList.add('recipient-cell');
        recipientCell.setAttribute('draggable', 'true');
        const recipientName = document.createElement('div');
        recipientName.className = 'table-primary-text';
        const recipientLink = document.createElement('a');
        recipientLink.href = `/profile/${recipientId}`;
        recipientLink.target = '_blank';
        recipientLink.rel = 'noopener noreferrer';
        recipientLink.textContent = pair.recipient_name;
        recipientLink.style.textDecoration = 'none';
        recipientLink.style.color = 'inherit';
        recipientLink.style.cursor = 'pointer';
        recipientLink.addEventListener('mouseenter', function() {
            this.style.textDecoration = 'underline';
        });
        recipientLink.addEventListener('mouseleave', function() {
            this.style.textDecoration = 'none';
        });
        recipientName.appendChild(recipientLink);
        const recipientLocation = document.createElement('div');
        recipientLocation.className = 'table-secondary-text';
        recipientLocation.textContent = formatLocation(pair.recipient_country, pair.recipient_city);
        recipientCell.appendChild(recipientName);
        recipientCell.appendChild(recipientLocation);

        const actionCell = document.createElement('td');
        actionCell.dataset.label = '–î–µ–π—Å—Ç–≤–∏—è';
        actionCell.classList.add('distribution-actions-cell');
        const actionsWrapper = document.createElement('div');
        actionsWrapper.classList.add('distribution-actions-group');
        actionsWrapper.style.display = 'flex';
        actionsWrapper.style.gap = '0.5rem';
        actionsWrapper.style.alignItems = 'center';
        
        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
        const lockButton = document.createElement('button');
        lockButton.type = 'button';
        lockButton.className = 'btn-icon lock-toggle';
        lockButton.innerHTML = 'üîì';
        lockButton.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É';
        lockButton.addEventListener('click', async () => {
            const isLocked = row.dataset.locked === 'true';
            const santaId = Number(row.dataset.santaId);
            if (isLocked && row.dataset.assigned === 'true') {
                const confirmed = confirm('–°–Ω—è—Ç—å –∑–∞–º–æ–∫? –ó–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ.');
                if (!confirmed) {
                    return;
                }
                lockButton.disabled = true;
                const result = await removeAssignmentForSanta(santaId);
                if (!result.ok) {
                    showMessage(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.', 'error');
                    lockButton.disabled = false;
                    return;
                }
                showMessage(result.message || '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.', 'info');
                delete assignedLockedPairs[santaId];
                row.dataset.assigned = 'false';
            }
            updateRowLockState(row, !isLocked);
            lockButton.disabled = false;
        });
        actionsWrapper.appendChild(lockButton);
        
        // –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è
        const unassignButton = document.createElement('button');
        unassignButton.type = 'button';
        unassignButton.className = 'btn-icon unassign-button';
        unassignButton.innerHTML = 'üóëÔ∏è';
        unassignButton.title = '–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É (—á–∞—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–µ)';
        unassignButton.style.color = 'var(--error-color, #dc3545)';
        unassignButton.addEventListener('click', async () => {
            const santaId = Number(row.dataset.santaId);
            const santaName = row.dataset.santaName || '–î–µ–¥ –ú–æ—Ä–æ–∑';
            const recipientName = pair.recipient_name || '–ü–æ–ª—É—á–∞—Ç–µ–ª—å';
            
            const confirmed = confirm(
                `–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É?\n\n` +
                `üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑: ${santaName}\n` +
                `üéÅ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${recipientName}\n\n` +
                `–ß–∞—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∞—Ä—Ö–∏–≤–µ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∞–¥–º–∏–Ω—É. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–∞—Ä—ã –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–∞—Ç.`
            );
            
            if (!confirmed) {
                return;
            }
            
            unassignButton.disabled = true;
            try {
                const response = await fetch(unassignUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ santa_id: santaId })
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage(data.message || '–ü–∞—Ä–∞ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞. –ß–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∞—Ä—Ö–∏–≤–µ.', 'success');
                    
                    // –ü–æ–ª—É—á–∞–µ–º ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞—Ä—ã
                    const santaId = Number(row.dataset.santaId);
                    const recipientId = Number(row.dataset.recipientId);
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                    row.remove();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - –ø–æ–º–µ—á–∞–µ–º –∏—Ö –∫–∞–∫ –Ω–µ –∏–º–µ—é—â–∏—Ö –ø–∞—Ä—É
                    const santaRow = document.querySelector(`.participants-table tbody tr[data-participant-id="${santaId}"]`);
                    const recipientRow = document.querySelector(`.participants-table tbody tr[data-participant-id="${recipientId}"]`);
                    
                    if (santaRow) {
                        santaRow.classList.remove('participant-formed');
                        santaRow.classList.add('participant-unformed');
                        santaRow.dataset.hasPair = 'false';
                    }
                    if (recipientRow) {
                        recipientRow.classList.remove('participant-formed');
                        recipientRow.classList.add('participant-unformed');
                        recipientRow.dataset.hasPair = 'false';
                    }
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–∞—Ä—ã –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
                    const remainingRows = document.querySelectorAll('#distribution-results-body tr');
                    const remainingPairs = [];
                    remainingRows.forEach(tr => {
                        const santaId = Number(tr.dataset.santaId);
                        const recipientId = Number(tr.dataset.recipientId);
                        if (santaId && recipientId) {
                            remainingPairs.push({
                                santa_id: santaId,
                                recipient_id: recipientId
                            });
                        }
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∞—Ä
                    updateParticipantsStatus(remainingPairs);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∏—Å–∫ –∏ —Å—á–µ—Ç—á–∏–∫–∏
                    performPairsSearch();
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ç–∞–±—É
                    const activeTab = document.querySelector('.tab-button.active')?.dataset.tab || 'all';
                    switchParticipantsTab(activeTab, null);
                } else {
                    showMessage(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É.', 'error');
                    unassignButton.disabled = false;
                }
            } catch (error) {
                console.error('Error unassigning pair:', error);
                showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä—ã.', 'error');
                unassignButton.disabled = false;
            }
        });
        actionsWrapper.appendChild(unassignButton);
        
        actionCell.appendChild(actionsWrapper);

        const statusCell = document.createElement('td');
        statusCell.dataset.label = '–°—Ç–∞—Ç—É—Å';
        const statusBadge = document.createElement('span');
        statusBadge.classList.add('distribution-status');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏: —Ç–æ–ª—å–∫–æ –ø–æ santa_sent_at (–Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏–ª")
        const sentStamp = pair.santa_sent_at ? new Date(pair.santa_sent_at) : null;
        const isSent = sentStamp !== null;
        const receivedStamp = pair.recipient_received_at ? new Date(pair.recipient_received_at) : null;
        const isReceived = receivedStamp !== null;
        
        if (isReceived) {
            statusBadge.textContent = '–ü–æ–ª—É—á–∏–ª';
            statusBadge.classList.add('status-complete');
        } else if (isSent) {
            statusBadge.textContent = '–û—Ç–ø—Ä–∞–≤–∏–ª';
            statusBadge.classList.add('status-sent');
        } else {
            statusBadge.textContent = '–ù–µ –æ—Ç–ø—Ä–∞–≤–∏–ª';
            statusBadge.classList.add('status-pending');
        }
        
        statusCell.appendChild(statusBadge);

        row.appendChild(santaCell);
        row.appendChild(recipientCell);
        row.appendChild(statusCell);
        row.appendChild(actionCell);
        resultsBody.appendChild(row);

        const isAssignmentLocked = Boolean(pair.assignment_locked) || assignedSet.has(santaId);
        row.dataset.assigned = isAssignmentLocked ? 'true' : 'false';
        if (isAssignmentLocked) {
            assignedLockedPairs[santaId] = recipientId;
            initialLockMap[santaId] = recipientId;
        }

        const shouldLock = initialLockMap[santaId] !== undefined && Number(initialLockMap[santaId]) === recipientId;
        updateRowLockState(row, shouldLock, { silent: true });
        if (shouldLock && row.dataset.assigned === 'true') {
            lockButton.classList.add('lock-fixed');
            lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É (–∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ)';
        }
        
        // –ï—Å–ª–∏ –ø–∞—Ä–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –≤ currentLocksMap (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏)
        // updateRowLockState —É–∂–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç currentLocksMap, –Ω–æ –ø—Ä–∏ silent: true –º–æ–∂–µ—Ç –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏
        if (shouldLock) {
            currentLocksMap[santaId] = recipientId;
        }
    });

    resultsSection.style.display = pairs.length ? 'block' : 'none';
    attachDragHandlers();
    updateAssignmentsButtonVisibility();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –ø–∞—Ä
    const totalCountEl = document.getElementById('pairs-total-count');
    if (totalCountEl) {
        totalCountEl.textContent = pairs.length;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    performPairsSearch();

    if (options.markDirty === false) {
        pendingChanges = false;
        if (saveBtn) {
            saveBtn.disabled = true;
        }
        if (saveContainer) {
            saveContainer.style.display = 'none';
        }
    } else if (options.markDirty) {
        markDirty();
    }
}

async function handleGenerate() {
    hideMessage();
    if (!generateBtn) return;
    const lockedPairs = collectLockedPairs();
    generateBtn.disabled = true;
    generateBtn.textContent = '\u{1F3B2} –§–æ—Ä–º–∏—Ä—É–µ–º...';
    if (saveBtn) {
        saveBtn.disabled = true;
    }

    try {
        const response = await fetch(generateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                group_by_country: sameCountryToggle ? sameCountryToggle.checked : false,
                locked_pairs: lockedPairs,
                assignment_locked_santas: Object.keys(assignedLockedPairs).map(Number)
            })
        });
        const data = await response.json();
        if (response.ok && data.success) {
            if (sameCountryToggle && Object.prototype.hasOwnProperty.call(data, 'country_mode_applied')) {
                sameCountryToggle.checked = Boolean(data.country_mode_applied);
            }
            const countryModeApplied = data.country_mode_applied !== false;
            const assignedSantas = Object.keys(assignedLockedPairs).map(Number);
            
            console.log('Generated pairs count:', data.pairs ? data.pairs.length : 0);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–∞—Ä—ã –ø–æ–ª—É—á–µ–Ω—ã
            if (!data.pairs || !Array.isArray(data.pairs) || data.pairs.length === 0) {
                showMessage('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                if (saveBtn) {
                    saveBtn.disabled = !pendingChanges;
                }
                return;
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –ø–∞—Ä—ã
            // –î–ª—è –≤–Ω–æ–≤—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä–µ–ø–ª—è–µ–º –∏—Ö –≤—Å–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è
            const allPairsAsLocks = data.pairs.map(pair => ({
                santa_id: pair.santa_id,
                recipient_id: pair.recipient_id
            }));
            renderPairs(data.pairs, { markDirty: false, locks: allPairsAsLocks, assignedLocks: assignedSantas });
            
            // –ñ–¥–µ–º, –ø–æ–∫–∞ DOM –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            await new Promise(resolve => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –æ–±–Ω–æ–≤–ª–µ–Ω
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        resolve();
                    });
                });
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞—Ä—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã
            const collectedPairs = collectPairsFromTable();
            console.log('Collected pairs from table:', collectedPairs.length);
            console.log('Expected pairs count:', data.pairs.length);
            
            if (!collectedPairs || collectedPairs.length === 0) {
                showMessage('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é.', 'error');
                markDirty();
                return;
            }
            
            if (collectedPairs.length !== data.pairs.length) {
                console.warn(`Pair count mismatch: generated ${data.pairs.length}, collected ${collectedPairs.length}`);
                showMessage(`–í–Ω–∏–º–∞–Ω–∏–µ: —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ ${data.pairs.length} –ø–∞—Ä, –Ω–æ —Å–æ–±—Ä–∞–Ω–æ ${collectedPairs.length}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.`, 'error');
                markDirty();
                return;
            }
            
            const saveResult = await savePairs({ showSuccess: false });
            if (saveResult.ok) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                updateParticipantsStatus(collectedPairs);
                
                const successMessage = countryModeApplied
                    ? '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º.'
                    : '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –†–µ–∂–∏–º ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –æ—Ç–∫–ª—é—á—ë–Ω –¥–ª—è —á–∞—Å—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.';
                showMessage(successMessage, 'success');
            } else {
                showMessage('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å: ' + saveResult.message, 'error');
                markDirty();
            }
        } else {
            showMessage(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
            if (saveBtn) {
                saveBtn.disabled = !pendingChanges;
            }
        }
    } catch (error) {
        console.error('Error in handleGenerate:', error);
        showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.', 'error');
        if (saveBtn) {
            saveBtn.disabled = !pendingChanges;
        }
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '\u{1F3B2} –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å';
    }
}

if (generateBtn) {
    generateBtn.addEventListener('click', handleGenerate);
}

if (saveBtn) {
    saveBtn.addEventListener('click', async () => {
        const result = await savePairs();
        showMessage(result.message, result.ok ? 'success' : 'error');
    });
}

if (assignmentsBtn) {
    assignmentsBtn.addEventListener('click', async () => {
        const lockedPairs = collectLockedPairs();
        if (!lockedPairs.length || lockedPairs.length !== (resultsBody ? resultsBody.querySelectorAll('tr').length : 0)) {
            showMessage('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –∫–∞–∂–¥—É—é –ø–∞—Ä—É –∑–∞–º–∫–æ–º.', 'error');
            return;
        }

        const saveResult = await savePairs({ showSuccess: false });
        if (!saveResult.ok) {
            showMessage(saveResult.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ó–∞–¥–∞–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.', 'error');
            return;
        }

        assignmentsBtn.disabled = true;
        assignmentsBtn.textContent = 'üì¶ –°–æ–∑–¥–∞—ë–º...';
        for (const [santaId, recipientId] of Object.entries(currentLocksMap)) {
            const row = resultsBody.querySelector(`tr[data-santa-id="${santaId}"]`);
            if (!row) continue;
            const cell = row.querySelector('.recipient-cell');
            if (!cell) continue;
            if (Number(cell.dataset.recipientId) !== Number(recipientId)) {
                showMessage('–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è –ø–∞—Ä–∞ –≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–¥–∞–Ω–∏–π.', 'error');
                assignmentsBtn.disabled = false;
                assignmentsBtn.textContent = 'üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è';
                return;
            }
        }
        try {
            const response = await fetch({{ distribution_create_assignments_url|tojson }}, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });
            const data = await response.json();
            if (response.ok && data.success) {
                showMessage(data.message || '–ó–∞–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.', 'success');
                assignedLockedPairs = {};
                Object.entries(currentLocksMap).forEach(([santaId, recipientId]) => {
                    const row = resultsBody.querySelector(`tr[data-santa-id="${santaId}"]`);
                    if (!row) {
                        return;
                    }
                    row.dataset.assigned = 'true';
                    assignedLockedPairs[Number(santaId)] = Number(recipientId);
                    const lockButton = row.querySelector('.lock-toggle');
                    if (lockButton) {
                        lockButton.classList.add('lock-fixed');
                        lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É (–∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ)';
                    }
                });
                updateAssignmentsButtonVisibility();
            } else {
                showMessage(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è.', 'error');
            }
        } catch (error) {
            console.error(error);
            showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏–π.', 'error');
        } finally {
            assignmentsBtn.disabled = false;
            assignmentsBtn.textContent = 'üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è URL –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
function copyToClipboard(text, button) {
    if (!text) return;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API Clipboard, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            const originalText = button.innerHTML;
            button.innerHTML = '‚úì';
            button.style.color = 'var(--success-color, #28a745)';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.color = '';
            }, 1500);
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            fallbackCopyToClipboard(text, button);
        });
    } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        fallbackCopyToClipboard(text, button);
    }
}

// Fallback –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
function fallbackCopyToClipboard(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            const originalText = button.innerHTML;
            button.innerHTML = '‚úì';
            button.style.color = 'var(--success-color, #28a745)';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.color = '';
            }, 1500);
        } else {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. URL: ' + text);
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. URL: ' + text);
    } finally {
        document.body.removeChild(textArea);
    }
}

// –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ MutationObserver (–º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å –∏–∑-–∑–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤)
// –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
(function() {
    'use strict';
    if (typeof MutationObserver === 'undefined' || !MutationObserver.prototype || !MutationObserver.prototype.observe) {
        return;
    }
    
    try {
        const originalObserve = MutationObserver.prototype.observe;
        if (!originalObserve) {
            return;
        }
        
        MutationObserver.prototype.observe = function(target, options) {
            // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: target –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º Node
            if (!target) {
                console.warn('MutationObserver.observe: null/undefined target');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ target —è–≤–ª—è–µ—Ç—Å—è Node —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤
            let isValidNode = false;
            
            // –°–ø–æ—Å–æ–± 1: instanceof Node
            if (typeof Node !== 'undefined') {
                try {
                    isValidNode = target instanceof Node;
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ instanceof
                }
            }
            
            // –°–ø–æ—Å–æ–± 2: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–∞ Node (–¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ instanceof –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
            if (!isValidNode && target && typeof target === 'object') {
                try {
                    const nodeType = target.nodeType;
                    const nodeName = target.nodeName;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nodeType –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–ª—è Node (1-12)
                    // –∏ nodeName —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    if (typeof nodeType === 'number' && nodeType >= 1 && nodeType <= 12 && nodeName) {
                        isValidNode = true;
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
                }
            }
            
            if (!isValidNode) {
                console.warn('MutationObserver.observe: invalid target (not a Node)', typeof target, target);
                return;
            }
            
            try {
                return originalObserve.call(this, target, options);
            } catch (error) {
                // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–∫—Ä–∏–ø—Ç—ã
                console.warn('MutationObserver.observe execution error:', error);
            }
        };
    } catch (e) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º - —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
        console.debug('Could not wrap MutationObserver.observe:', e);
    }
})();

// –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
if (existingPairs && existingPairs.length) {
    const initialLocks = existingPairs
        .filter(pair => pair && pair.locked)
        .map(pair => ({
            santa_id: pair.santa_id,
            recipient_id: pair.recipient_id
        }));
    renderPairs(existingPairs, { markDirty: false, locks: initialLocks, assignedLocks: lockedFromAssignments || [] });
    const hasLockedPairs = existingPairs.some(pair => pair && pair.locked);
    if (hasLockedPairs) {
        showMessage('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø–∞—Ä—ã –≤—ã–¥–µ–ª–µ–Ω—ã.', 'info');
    } else {
        showMessage('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'info');
    }
    
    // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–± "formed", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∞—Ä
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab') || 'all';
    if (activeTab === 'formed') {
        const distributionResults = document.getElementById('distribution-results');
        if (distributionResults) {
            distributionResults.style.display = 'block';
        }
        const distributionSection = document.querySelector('.distribution-section');
        if (distributionSection) {
            distributionSection.style.display = 'block';
        }
        const participantsSection = document.querySelector('.participants-section');
        if (participantsSection) {
            participantsSection.style.display = 'none';
        }
    }
} else {
    showMessage('–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä—ã –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.', 'info');
}

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∞–±–∞
// –≠—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –≤–∫–ª—é—á–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä—ã
// –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤
requestAnimationFrame(function() {
    requestAnimationFrame(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab') || 'all';
        switchParticipantsTab(activeTab, null);
    });
});
</script>
{% endblock %}

