{% extends "base.html" %}

{% block title %}–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ {{ event.name }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
            <p class="text-muted" style="margin: 0;">{{ event.name }}</p>
        </div>
        <div class="event-header-actions">
            <a href="{{ url_for('admin_event_view', event_id=event.id) }}" class="btn-icon" title="–ù–∞–∑–∞–¥ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é">‚Üê</a>
            <a href="{{ url_for('admin_event_participants', event_id=event.id) }}" class="btn-icon" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–∞–¥–º–∏–Ω)">üë•</a>
        </div>
    </div>

    <div class="event-meta-card">
        <div class="event-meta-item">
            <span class="event-meta-label">–°—Ç–∞—Ç—É—Å –æ—Ç–±–æ—Ä–∞</span>
            <span class="event-meta-value">–ü–æ–∑–∏—Ç–∏–≤ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã)</span>
        </div>
        <div class="event-meta-item">
            <span class="event-meta-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ</span>
            <span class="event-meta-value">{{ participants_count }}</span>
        </div>
    </div>

    <div class="event-view-card" style="margin-bottom: 1.5rem;">
        <div class="settings-section">
            <h2 class="section-title" style="margin-bottom: 1rem;">–ü–æ–∑–∏—Ç–∏–≤-—É—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
            {% if participants_count == 0 %}
            <div class="alert alert-info">
                –ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
            </div>
            {% else %}
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                            <th>–ê–¥—Ä–µ—Å</th>
                            <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                            <th>–ó–∞–º–µ—Ç–∫–∏</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in participants %}
                        <tr>
                            <td data-label="–£—á–∞—Å—Ç–Ω–∏–∫">
                                <div class="table-primary-text">{{ p.last_name }} {{ p.first_name }} {{ p.middle_name }}</div>
                                <div class="table-secondary-text">{{ p.username }}</div>
                            </td>
                            <td data-label="–ê–¥—Ä–µ—Å">
                                {% set addr = p.address %}
                                <div class="table-secondary-text">
                                    {{ addr.postal_code or '‚Äî' }}, {{ addr.country or '‚Äî' }}, {{ addr.city or '‚Äî' }}<br>
                                    {{ addr.street or '‚Äî' }}, {{ addr.house or '‚Äî' }}{% if addr.building %}, –∫–æ—Ä–ø. {{ addr.building }}{% endif %}{% if addr.apartment %}, –∫–≤. {{ addr.apartment }}{% endif %}
                                </div>
                            </td>
                            <td data-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã">
                                {% set c = p.contacts %}
                                {% if c.phone %}
                                <div><a class="contact-link" href="tel:{{ c.phone }}">{{ c.phone }}</a></div>
                                {% endif %}
                                {% if c.telegram and c.telegram != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="https://t.me/{{ c.telegram|replace('@','') }}" target="_blank" rel="noopener">Telegram</a></div>
                                {% endif %}
                                {% if c.whatsapp and c.whatsapp != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="https://wa.me/{{ c.whatsapp|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">WhatsApp</a></div>
                                {% endif %}
                                {% if c.viber and c.viber != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="viber://chat?number={{ c.viber|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">Viber</a></div>
                                {% endif %}
                                {% if not c.phone and (not c.telegram or c.telegram == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') and (not c.whatsapp or c.whatsapp == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') and (not c.viber or c.viber == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') %}
                                <div class="table-secondary-text">‚Äî</div>
                                {% endif %}
                            </td>
                            <td data-label="–ó–∞–º–µ—Ç–∫–∏">{{ p.notes or '‚Äî' }}</td>
                            <td data-label="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">{{ p.registered_at or '‚Äî' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="event-view-card">
        <div class="settings-section">
            <div class="distribution-actions" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                <button id="generate-pairs-btn" class="btn btn-primary" {% if participants_count < 2 %}disabled{% endif %}>&#127922; –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <span class="text-muted">–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º –∏ –í–Ω—É–∫–æ–º —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑.</span>
            </div>
            {% if participants_count < 2 %}
            <div class="alert alert-warning" style="margin-top: 1rem;">
                –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ú–∏–Ω–∏–º—É–º: 2 –ø–æ–∑–∏—Ç–∏–≤-—É—á–∞—Å—Ç–Ω–∏–∫–∞.
            </div>
            {% endif %}

            <div id="distribution-message" class="alert" style="display: none; margin-top: 1rem;"></div>

            <div class="table-container" id="distribution-results" style="display: none; margin-top: 1.5rem;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</th>
                            <th>üéÅ –í–Ω—É—á–æ–∫/–í–Ω—É—á–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody id="distribution-results-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const generateUrl = {{ distribution_generate_url|tojson }};
const generateBtn = document.getElementById('generate-pairs-btn');
const resultsSection = document.getElementById('distribution-results');
const resultsBody = document.getElementById('distribution-results-body');
const messageBox = document.getElementById('distribution-message');

function showMessage(text, type = 'info') {
    if (!messageBox) return;
    messageBox.className = 'alert alert-' + type;
    messageBox.textContent = text;
    messageBox.style.display = 'block';
}

function hideMessage() {
    if (!messageBox) return;
    messageBox.style.display = 'none';
}

function renderPairs(pairs) {
    if (!resultsBody || !resultsSection) return;
    resultsBody.innerHTML = '';
    pairs.forEach(pair => {
        const row = document.createElement('tr');
        const santaCell = document.createElement('td');
        santaCell.dataset.label = '–î–µ–¥ –ú–æ—Ä–æ–∑';
        santaCell.textContent = pair.santa_name;
        const recipientCell = document.createElement('td');
        recipientCell.dataset.label = '–í–Ω—É—á–æ–∫/–í–Ω—É—á–∫–∞';
        recipientCell.textContent = pair.recipient_name;
        row.appendChild(santaCell);
        row.appendChild(recipientCell);
        resultsBody.appendChild(row);
    });
    resultsSection.style.display = 'block';
}

async function handleGenerate() {
    hideMessage();
    if (!generateBtn) return;
    generateBtn.disabled = true;
    generateBtn.textContent = '\u{1F3B2} –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å';
    try {
        const response = await fetch(generateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin'
        });
        const data = await response.json();
        if (response.ok && data.success) {
            renderPairs(data.pairs);
            showMessage('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä—ã –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'success');
        } else {
            showMessage(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
        }
    } catch (error) {
        console.error(error);
        showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.', 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'üé≤ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å';
    }
}

if (generateBtn) {
    generateBtn.addEventListener('click', handleGenerate);
}
</script>
{% endblock %}

