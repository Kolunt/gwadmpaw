{% extends "base.html" %}

{% block title %}–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: {{ event.name }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –í–Ω—É—á–∫–∏: {{ event.name }}</h1>
        <div class="action-buttons">
            <a href="{{ url_for('admin_event_review', event_id=event.id) }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–≤—å—é</a>
        </div>
    </div>

    {% if approved_participants %}
    <div class="event-view-card">
        <div class="settings-section">
            <h2 class="settings-section-title">–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –ø–∞—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
            <p class="setting-hint" style="margin-bottom: 1.5rem;">
                –ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –≤—ã—Å—Ç—É–ø–∞—Ç—å –≤ —Ä–æ–ª–∏ ¬´–î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞¬ª –∏ ¬´–í–Ω—É—á–∫–∏¬ª —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑. –°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –ø–∞—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é, –∑–∞—Ç–µ–º —É—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.
            </p>

            <div class="distribution-actions" style="display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" id="generate-random-btn">üé≤ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ</button>
                <button type="button" class="btn btn-secondary" id="clear-assignment-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>

            <div id="distribution-alert" class="alert" style="display: none; margin-bottom: 1rem;"></div>

            <form id="distribution-form">
                <div class="table-container">
                    <table class="admin-table" id="distribution-table">
                        <thead>
                            <tr>
                                <th>üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</th>
                                <th>üéÅ –í–Ω—É—á–∫–∞</th>
                                <th style="width: 160px;">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in approved_participants %}
                            {% set current_recipient = assignments_map.get(participant.user_id) %}
                            <tr data-santa-id="{{ participant.user_id }}">
                                <td data-label="–î–µ–¥ –ú–æ—Ä–æ–∑">
                                    <strong>{{ participant.username }}</strong><br>
                                    <small style="color: var(--text-secondary);">
                                        {% if participant.last_name or participant.first_name %}
                                            {{ participant.last_name or '' }} {{ participant.first_name or '' }} {{ participant.middle_name or '' }}
                                        {% else %}
                                            ID: {{ participant.user_id }}
                                        {% endif %}
                                    </small>
                                </td>
                                <td data-label="–í–Ω—É—á–∫–∞">
                                    <select class="recipient-select" name="recipient_{{ participant.user_id }}">
                                        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Äî</option>
                                        {% for option in approved_participants %}
                                            {% if option.user_id != participant.user_id %}
                                            <option value="{{ option.user_id }}" {% if current_recipient == option.user_id %}selected{% endif %}>
                                                {{ option.username }}
                                                {% if option.last_name or option.first_name %}
                                                    ({{ option.last_name or '' }} {{ option.first_name or '' }})
                                                {% endif %}
                                            </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="assignment-status" data-label="–°—Ç–∞—Ç—É—Å">
                                    {% if current_recipient %}
                                        <span class="badge badge-success">–ì–æ—Ç–æ–≤–æ</span>
                                    {% else %}
                                        <span class="badge badge-warning">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="form-actions" style="margin-top: 1.5rem;">
                    <button type="button" class="btn btn-primary btn-large" id="save-assignment-btn">–£—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</button>
                </div>
            </form>

            {% if existing_assignments %}
            <div class="alert alert-info" style="margin-top: 1.5rem;">
                <p style="margin: 0;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç {{ existing_assignments|length }} –ø–∞—Ä. –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ –≤—ã—à–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–Ω–æ–≤–æ.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="event-view-card" style="margin-top: 1.5rem;">
        <div class="settings-section">
            <h2 class="settings-section-title">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ approved_participants|length }})</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem;">
                {% for participant in approved_participants %}
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                    <strong>{{ participant.username }}</strong>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        {% if participant.last_name or participant.first_name %}
                            {{ participant.last_name or '' }} {{ participant.first_name or '' }} {{ participant.middle_name or '' }}
                        {% else %}
                            ID: {{ participant.user_id }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="event-view-card">
        <div class="alert alert-warning">
            <p>–ù–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –°–Ω–∞—á–∞–ª–∞ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–≤—å—é.</p>
            <a href="{{ url_for('admin_event_review', event_id=event.id) }}" class="btn btn-primary" style="margin-top: 1rem;">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≤—å—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% if approved_participants %}
<script>
const eventId = {{ event.id }};
const randomUrl = {{ url_for('admin_event_distribution_random', event_id=event.id)|tojson }};
const saveUrl = {{ url_for('admin_event_distribution_save', event_id=event.id)|tojson }};
const approvedParticipants = {{ approved_participants|tojson }};
const existingAssignments = {{ existing_assignments|tojson }};

const distributionForm = document.getElementById('distribution-form');
const randomBtn = document.getElementById('generate-random-btn');
const clearBtn = document.getElementById('clear-assignment-btn');
const saveBtn = document.getElementById('save-assignment-btn');
const alertBox = document.getElementById('distribution-alert');
const rows = Array.from(document.querySelectorAll('#distribution-table tbody tr'));

function showAlert(message, type = 'info') {
    if (!alertBox) return;
    alertBox.className = 'alert alert-' + type;
    alertBox.textContent = message;
    alertBox.style.display = 'block';
}

function hideAlert() {
    if (!alertBox) return;
    alertBox.style.display = 'none';
}

function setRowStatus(row, text, type) {
    const cell = row.querySelector('.assignment-status');
    if (!cell) return;
    if (type === 'success') {
        cell.innerHTML = '<span class="badge badge-success">' + text + '</span>';
    } else if (type === 'warning') {
        cell.innerHTML = '<span class="badge badge-warning">' + text + '</span>';
    } else {
        cell.innerHTML = '<span class="badge">' + text + '</span>';
    }
}

function applyAssignments(assignments) {
    const map = new Map();
    assignments.forEach(item => {
        map.set(String(item.santa_user_id), String(item.recipient_user_id));
    });
    rows.forEach(row => {
        const santaId = row.dataset.santaId;
        const select = row.querySelector('.recipient-select');
        if (!select) return;
        const value = map.get(santaId) || '';
        select.value = value;
        if (value) {
            setRowStatus(row, '–ì–æ—Ç–æ–≤–æ', 'success');
        } else {
            setRowStatus(row, '–ù–µ –≤—ã–±—Ä–∞–Ω–æ', 'warning');
        }
        select.style.borderColor = '';
    });
    hideAlert();
}

function clearAssignments() {
    rows.forEach(row => {
        const select = row.querySelector('.recipient-select');
        if (select) {
            select.value = '';
            select.style.borderColor = '';
        }
        setRowStatus(row, '–ù–µ –≤—ã–±—Ä–∞–Ω–æ', 'warning');
    });
    showAlert('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ. –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –ø–∞—Ä—ã –∑–∞–Ω–æ–≤–æ.', 'info');
}

function gatherAssignments() {
    const assignments = [];
    let valid = true;
    const recipients = new Set();
    const errors = [];

    rows.forEach(row => {
        const santaId = parseInt(row.dataset.santaId, 10);
        const select = row.querySelector('.recipient-select');
        const value = select.value ? parseInt(select.value, 10) : null;
        select.style.borderColor = '';

        if (!value) {
            valid = false;
            errors.push('–ù–µ –≤—ã–±—Ä–∞–Ω—ã –≤—Å–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏');
            select.style.borderColor = 'var(--error-color)';
            setRowStatus(row, '–ù–µ –≤—ã–±—Ä–∞–Ω–æ', 'warning');
        } else if (value === santaId) {
            valid = false;
            errors.push('–£—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –¥–∞—Ä–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ —Å–µ–±–µ');
            select.style.borderColor = 'var(--error-color)';
            setRowStatus(row, '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ', 'warning');
        } else if (recipients.has(value)) {
            valid = false;
            errors.push('–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è');
            select.style.borderColor = 'var(--error-color)';
            setRowStatus(row, '–î—É–±–ª–∏–∫–∞—Ç', 'warning');
        } else {
            recipients.add(value);
            setRowStatus(row, '–ì–æ—Ç–æ–≤–æ', 'success');
        }

        assignments.push({
            santa_user_id: santaId,
            recipient_user_id: value
        });
    });

    if (!valid) {
        showAlert(errors[0], 'warning');
        return null;
    }

    if (recipients.size !== approvedParticipants.length) {
        showAlert('–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑.', 'warning');
        return null;
    }

    return assignments;
}

async function handleRandomGeneration() {
    hideAlert();
    try {
        const response = await fetch(randomUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({})
        });
        const data = await response.json();
        if (response.ok && data.success) {
            applyAssignments(data.assignments);
            showAlert('–°–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä—ã –∏ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.', 'info');
        } else {
            showAlert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', 'error');
        }
    } catch (error) {
        console.error(error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
    }
}

async function handleSave() {
    hideAlert();
    const assignments = gatherAssignments();
    if (!assignments) {
        return;
    }
    try {
        const response = await fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ assignments })
        });
        const data = await response.json();
        if (response.ok && data.success) {
            showAlert(data.message || '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
        } else {
            showAlert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', 'error');
        }
    } catch (error) {
        console.error(error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
    }
}

function initExistingAssignments() {
    if (!existingAssignments || !existingAssignments.length) {
        rows.forEach(row => setRowStatus(row, '–ù–µ –≤—ã–±—Ä–∞–Ω–æ', 'warning'));
        return;
    }
    const normalized = existingAssignments.map(item => ({
        santa_user_id: item.santa_user_id,
        recipient_user_id: item.recipient_user_id
    }));
    applyAssignments(normalized);
}

if (randomBtn) {
    randomBtn.addEventListener('click', handleRandomGeneration);
}
if (clearBtn) {
    clearBtn.addEventListener('click', clearAssignments);
}
if (saveBtn) {
    saveBtn.addEventListener('click', handleSave);
}

rows.forEach(row => {
    const select = row.querySelector('.recipient-select');
    if (!select) return;
    select.addEventListener('change', () => {
        if (select.value) {
            select.style.borderColor = '';
            setRowStatus(row, '–ì–æ—Ç–æ–≤–æ', 'success');
        } else {
            setRowStatus(row, '–ù–µ –≤—ã–±—Ä–∞–Ω–æ', 'warning');
        }
        hideAlert();
    });
});

initExistingAssignments();
</script>
{% endif %}
{% endblock %}

