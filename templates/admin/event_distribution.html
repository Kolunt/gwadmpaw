{% extends "base.html" %}

{% block title %}–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ {{ event.name }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
            <p class="text-muted" style="margin: 0;">{{ event.name }}</p>
        </div>
        <div class="event-header-actions">
            <a href="{{ url_for('admin_event_view', event_id=event.id) }}" class="btn-icon" title="–ù–∞–∑–∞–¥ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é">‚Üê</a>
            <a href="{{ url_for('admin_event_participants', event_id=event.id) }}" class="btn-icon" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–∞–¥–º–∏–Ω)">üë•</a>
        </div>
    </div>

    <div class="event-meta-card">
        <div class="event-meta-item">
            <span class="event-meta-label">–°—Ç–∞—Ç—É—Å –æ—Ç–±–æ—Ä–∞</span>
            <span class="event-meta-value">–ü–æ–∑–∏—Ç–∏–≤ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã)</span>
        </div>
        <div class="event-meta-item">
            <span class="event-meta-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ</span>
            <span class="event-meta-value">{{ participants_count }}</span>
        </div>
    </div>

    <div class="event-view-card" style="margin-bottom: 1.5rem;">
        <div class="settings-section">
            <h2 class="section-title" style="margin-bottom: 1rem;">–ü–æ–∑–∏—Ç–∏–≤-—É—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
            {% if participants_count == 0 %}
            <div class="alert alert-info">
                –ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
            </div>
            {% else %}
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                –û–ø—Ü–∏—è ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ. –ü—Ä–∏ —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –ø–∞—Ä—ã –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é.
            </div>
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                            <th>–°—Ç—Ä–∞–Ω–∞</th>
                            <th>–°—Ç—Ä–∞–Ω–∞ / –ì–æ—Ä–æ–¥</th>
                            <th>–ê–¥—Ä–µ—Å</th>
                            <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                            <th>–ó–∞–º–µ—Ç–∫–∏</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in participants %}
                        <tr>
                            <td data-label="–£—á–∞—Å—Ç–Ω–∏–∫">
                                <div class="table-primary-text">{{ p.last_name }} {{ p.first_name }} {{ p.middle_name }}</div>
                                <div class="table-secondary-text">{{ p.username }}</div>
                            </td>
                            <td data-label="–°—Ç—Ä–∞–Ω–∞">
                                {% set addr = p.address %}
                                <div class="table-secondary-text">{{ addr.country or '‚Äî' }}</div>
                            </td>
                            <td data-label="–°—Ç—Ä–∞–Ω–∞ / –ì–æ—Ä–æ–¥">
                                <div class="table-secondary-text">
                                    {% if addr.country or addr.city %}
                                        {{ addr.country or '‚Äî' }}{% if addr.city %} / {{ addr.city }}{% endif %}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="–ê–¥—Ä–µ—Å">
                                {% set addr = p.address %}
                                {% if addr.postal_code or addr.country or addr.city or addr.street %}
                                    <div class="table-secondary-text">
                                        {{ addr.postal_code or '‚Äî' }}, {{ addr.country or '‚Äî' }}, {{ addr.city or '‚Äî' }}<br>
                                        {{ addr.street or '‚Äî' }}, {{ addr.house or '‚Äî' }}{% if addr.building %}, –∫–æ—Ä–ø. {{ addr.building }}{% endif %}{% if addr.apartment %}, –∫–≤. {{ addr.apartment }}{% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td data-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã">
                                {% set c = p.contacts %}
                                {% if c.phone %}
                                <div><a class="contact-link" href="tel:{{ c.phone }}">{{ c.phone }}</a></div>
                                {% endif %}
                                {% if c.telegram and c.telegram != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="https://t.me/{{ c.telegram|replace('@','') }}" target="_blank" rel="noopener">Telegram</a></div>
                                {% endif %}
                                {% if c.whatsapp and c.whatsapp != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="https://wa.me/{{ c.whatsapp|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">WhatsApp</a></div>
                                {% endif %}
                                {% if c.viber and c.viber != '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é' %}
                                <div><a class="contact-link" href="viber://chat?number={{ c.viber|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">Viber</a></div>
                                {% endif %}
                                {% if not c.phone and (not c.telegram or c.telegram == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') and (not c.whatsapp or c.whatsapp == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') and (not c.viber or c.viber == '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é') %}
                                <div class="table-secondary-text">‚Äî</div>
                                {% endif %}
                            </td>
                            <td data-label="–ó–∞–º–µ—Ç–∫–∏">{{ p.notes or '‚Äî' }}</td>
                            <td data-label="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">{{ p.registered_at or '‚Äî' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="event-view-card">
        <div class="settings-section">
            <div class="distribution-actions" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                <button id="generate-pairs-btn" class="btn btn-primary" {% if participants_count < 2 %}disabled{% endif %}>&#127922; –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <label class="checkbox-inline" style="display: flex; gap: 0.35rem; align-items: center;">
                    <input type="checkbox" id="distribute-same-country">
                    <span>–ü–æ —Å—Ç—Ä–∞–Ω–∞–º</span>
                </label>
                <span class="text-muted">–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º –∏ –í–Ω—É—á–∫–æ–º —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑.</span>
            </div>
            {% if participants_count < 2 %}
            <div class="alert alert-warning" style="margin-top: 1rem;">
                –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ú–∏–Ω–∏–º—É–º: 2 –ø–æ–∑–∏—Ç–∏–≤-—É—á–∞—Å—Ç–Ω–∏–∫–∞.
            </div>
            {% endif %}

            <div id="distribution-message" class="alert" style="display: none; margin-top: 1rem;"></div>

            <div class="table-container" id="distribution-results" style="display: none; margin-top: 1.5rem;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</th>
                            <th>üéÅ –í–Ω—É—á–æ–∫/–í–Ω—É—á–∫–∞</th>
                            <th class="distribution-status-col">–°—Ç–∞—Ç—É—Å</th>
                            <th class="distribution-actions-col">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="distribution-results-body"></tbody>
                </table>
                <p class="text-muted" style="margin-top: 0.75rem;">–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.</p>
                <div id="save-pairs-container" style="display: none; margin-top: 1rem;">
                    <button id="save-pairs-btn" class="btn btn-secondary" disabled>&#128190; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div id="create-assignments-container" style="display: none; margin-top: 1.25rem;">
                <button id="create-assignments-btn" class="btn btn-success">üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
            </div>
        </div>
    </div>
</div>

<script>
const generateUrl = {{ distribution_generate_url|tojson }};
const saveUrl = {{ distribution_save_url|tojson }};
const existingPairs = {{ saved_pairs|tojson }};
const lockedFromAssignments = {{ saved_locked_santas|tojson }};
const unassignUrl = {{ distribution_unassign_url|tojson }};
const generateBtn = document.getElementById('generate-pairs-btn');
const saveContainer = document.getElementById('save-pairs-container');
const saveBtn = document.getElementById('save-pairs-btn');
const assignmentsContainer = document.getElementById('create-assignments-container');
const assignmentsBtn = document.getElementById('create-assignments-btn');
const sameCountryToggle = document.getElementById('distribute-same-country');
const resultsSection = document.getElementById('distribution-results');
const resultsBody = document.getElementById('distribution-results-body');
const messageBox = document.getElementById('distribution-message');
let draggedCell = null;
let pendingChanges = false;
let currentLocksMap = {};
let assignedLockedPairs = {};
let removingAssignmentPromise = null;

function showMessage(text, type = 'info') {
    if (!messageBox) return;
    messageBox.className = 'alert alert-' + type;
    messageBox.textContent = text;
    messageBox.style.display = 'block';
}

function hideMessage() {
    if (!messageBox) return;
    messageBox.style.display = 'none';
}

function formatLocation(country, city) {
    if (!country && !city) {
        return '‚Äî';
    }
    if (country && city) {
        return `${country} / ${city}`;
    }
    return country || city || '‚Äî';
}

function updateRecipientCellDisplay(cell) {
    if (!cell) return;
    const nameEl = cell.querySelector('.table-primary-text');
    const locationEl = cell.querySelector('.table-secondary-text');
    if (nameEl) {
        nameEl.textContent = cell.dataset.recipientName || '‚Äî';
    }
    if (locationEl) {
        locationEl.textContent = formatLocation(cell.dataset.recipientCountry, cell.dataset.recipientCity);
    }
}

function markDirty() {
    pendingChanges = true;
    if (saveContainer) {
        saveContainer.style.display = 'block';
    }
    if (saveBtn) {
        saveBtn.disabled = false;
    }
    if (assignmentsContainer) {
        assignmentsContainer.style.display = 'none';
    }
    assignmentsBtn.disabled = true;
}

function updateAssignmentsButtonVisibility() {
    if (!assignmentsBtn || !assignmentsContainer) return;
    const hasLocks = Object.keys(currentLocksMap).length > 0;
    const hasAssigned = Object.keys(assignedLockedPairs).length > 0;
    if (hasLocks || hasAssigned) {
        assignmentsContainer.style.display = 'block';
        assignmentsBtn.disabled = !hasLocks;
    } else {
        assignmentsContainer.style.display = 'none';
        assignmentsBtn.disabled = true;
    }
}

async function removeAssignmentForSanta(santaId) {
    if (!unassignUrl) {
        return { ok: false, message: 'URL –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.' };
    }
    try {
        const response = await fetch(unassignUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ santa_id: santaId })
        });
        const data = await response.json();
        if (response.ok && data.success) {
            return { ok: true, message: data.message || '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.' };
        }
        return { ok: false, message: data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.' };
    } catch (error) {
        console.error(error);
        return { ok: false, message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–¥–∞–Ω–∏—è.' };
    }
}

function updateRowLockState(row, locked, { silent = false } = {}) {
    if (!row) return;
    const lockButton = row.querySelector('.lock-toggle');
    const recipientCell = row.querySelector('.recipient-cell');
    row.dataset.locked = locked ? 'true' : 'false';

    const santaId = row.dataset.santaId;
    const isAssignedLock = assignedLockedPairs[santaId] !== undefined;

    if (locked) {
        row.classList.add('distribution-row-locked');
        if (lockButton) {
            lockButton.innerHTML = 'üîí';
            if (row.dataset.assigned === 'true') {
                lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É (–∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ)';
            } else {
                lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É';
            }
            lockButton.classList.add('locked');
            lockButton.classList.toggle('lock-fixed', row.dataset.assigned === 'true');
            lockButton.disabled = false;
        }
        if (recipientCell) {
            recipientCell.setAttribute('draggable', 'false');
        }
        currentLocksMap[row.dataset.santaId] = Number(row.dataset.recipientId);
    } else {
        row.classList.remove('distribution-row-locked');
        if (lockButton) {
            lockButton.innerHTML = 'üîì';
            lockButton.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É';
            lockButton.classList.remove('locked');
            lockButton.classList.remove('lock-fixed');
            lockButton.disabled = false;
        }
        if (recipientCell) {
            recipientCell.setAttribute('draggable', 'true');
        }
        delete currentLocksMap[row.dataset.santaId];
    }

    if (!silent) {
        markDirty();
        showMessage(locked ? '–ü–∞—Ä–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞: –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π.' : '–ü–∞—Ä–∞ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∞: –æ–Ω–∞ –±—É–¥–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏.', 'info');
    }
    updateAssignmentsButtonVisibility();
}

function collectPairsFromTable() {
    if (!resultsBody) return [];
    return Array.from(resultsBody.querySelectorAll('tr')).map(row => ({
        santa_id: Number(row.dataset.santaId),
        recipient_id: Number(row.dataset.recipientId)
    })).filter(pair => Number.isInteger(pair.santa_id) && Number.isInteger(pair.recipient_id));
}

function collectLockedPairs() {
    return Object.entries(currentLocksMap).map(([santaId, recipientId]) => ({
        santa_id: Number(santaId),
        recipient_id: Number(recipientId)
    }));
}

async function savePairs({ showSuccess = true } = {}) {
    if (!saveUrl) {
        return { ok: false, message: 'URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.' };
    }

    const pairs = collectPairsFromTable();
    if (!pairs.length) {
        return { ok: false, message: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.' };
    }

    if (saveBtn) {
        saveBtn.disabled = true;
    }
    if (saveContainer) {
        saveContainer.style.display = 'block';
    }

    try {
        const response = await fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                pairs,
                enforce_country: sameCountryToggle ? sameCountryToggle.checked : false,
                locked_pairs: collectLockedPairs()
            })
        });
        const data = await response.json();
        if (response.ok && data.success) {
            pendingChanges = false;
            if (saveBtn) {
                saveBtn.disabled = true;
            }
            if (saveContainer) {
                saveContainer.style.display = 'none';
            }
            const message = data.message || '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.';
            if (showSuccess) {
                showMessage(message, 'success');
            }
            return { ok: true, message };
        }
        if (saveBtn) {
            saveBtn.disabled = !pendingChanges;
        }
        if (saveContainer && pendingChanges) {
            saveContainer.style.display = 'block';
        }
        const errorMessage = data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.';
        if (showSuccess) {
            showMessage(errorMessage, 'error');
        }
        return { ok: false, message: errorMessage };
    } catch (error) {
        console.error(error);
        if (saveBtn) {
            saveBtn.disabled = !pendingChanges;
        }
        if (saveContainer && pendingChanges) {
            saveContainer.style.display = 'block';
        }
        const errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.';
        if (showSuccess) {
            showMessage(errorMessage, 'error');
        }
        return { ok: false, message: errorMessage };
    }
}

function swapRecipients(a, b) {
    if (!a || !b) return;
    const tempId = a.dataset.recipientId;
    const tempName = a.dataset.recipientName;
    const tempCountry = a.dataset.recipientCountry;
    const tempCity = a.dataset.recipientCity;

    a.dataset.recipientId = b.dataset.recipientId;
    a.dataset.recipientName = b.dataset.recipientName;
    a.dataset.recipientCountry = b.dataset.recipientCountry;
    a.dataset.recipientCity = b.dataset.recipientCity;
    updateRecipientCellDisplay(a);

    b.dataset.recipientId = tempId;
    b.dataset.recipientName = tempName;
    b.dataset.recipientCountry = tempCountry;
    b.dataset.recipientCity = tempCity;
    updateRecipientCellDisplay(b);

    const santaRowA = a.closest('tr');
    const santaRowB = b.closest('tr');
    if (santaRowA && santaRowB) {
        santaRowA.dataset.recipientId = a.dataset.recipientId;
        santaRowA.dataset.recipientName = a.dataset.recipientName || '';
        santaRowA.dataset.recipientCountry = a.dataset.recipientCountry || '';
        santaRowA.dataset.recipientCity = a.dataset.recipientCity || '';
        santaRowB.dataset.recipientId = b.dataset.recipientId;
        santaRowB.dataset.recipientName = b.dataset.recipientName || '';
        santaRowB.dataset.recipientCountry = b.dataset.recipientCountry || '';
        santaRowB.dataset.recipientCity = b.dataset.recipientCity || '';
    }
}

function handleDragStart(event) {
    const row = event.currentTarget.closest('tr');
    if (row && row.dataset.locked === 'true') {
        event.preventDefault();
        return;
    }
    draggedCell = event.currentTarget;
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', draggedCell.dataset.recipientId);
    requestAnimationFrame(() => draggedCell.classList.add('is-dragging'));
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    const target = event.currentTarget;
    if (target !== draggedCell) {
        target.classList.add('drop-target');
    }
}

function handleDragEnter(event) {
    const target = event.currentTarget;
    if (target !== draggedCell) {
        target.classList.add('drop-target');
    }
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('drop-target');
}

function handleDrop(event) {
    event.preventDefault();
    const target = event.currentTarget;
    target.classList.remove('drop-target');
    if (!draggedCell || target === draggedCell) {
        return;
    }

    const draggedRow = draggedCell.closest('tr');
    const targetRow = target.closest('tr');
    if (!draggedRow || !targetRow) {
        return;
    }

    if (draggedRow.dataset.locked === 'true' || targetRow.dataset.locked === 'true') {
        showMessage('–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø–∞—Ä—ã –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é.', 'error');
        return;
    }

    const draggedSantaId = draggedRow.dataset.santaId;
    const draggedSantaCountry = draggedRow.dataset.santaCountry || '';
    const targetSantaId = targetRow.dataset.santaId;
    const targetSantaCountry = targetRow.dataset.santaCountry || '';
    const draggedRecipientId = draggedCell.dataset.recipientId;
    const draggedRecipientCountry = draggedCell.dataset.recipientCountry || '';
    const targetRecipientId = target.dataset.recipientId;
    const targetRecipientCountry = target.dataset.recipientCountry || '';

    if (draggedSantaId === targetRecipientId || targetSantaId === draggedRecipientId) {
        showMessage('–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.', 'error');
        return;
    }

    if (sameCountryToggle && sameCountryToggle.checked) {
        if (draggedSantaCountry && targetRecipientCountry && draggedSantaCountry !== targetRecipientCountry) {
            showMessage('–ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –î–µ–¥ –ú–æ—Ä–æ–∑ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã.', 'error');
            return;
        }
        if (targetSantaCountry && draggedRecipientCountry && targetSantaCountry !== draggedRecipientCountry) {
            showMessage('–ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –î–µ–¥ –ú–æ—Ä–æ–∑ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã.', 'error');
            return;
        }
    }

    swapRecipients(draggedCell, target);
    markDirty();
    showMessage('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.', 'info');
}

function handleDragEnd() {
    if (draggedCell) {
        draggedCell.classList.remove('is-dragging');
    }
    draggedCell = null;
    const cells = resultsBody ? resultsBody.querySelectorAll('.recipient-cell') : [];
    cells.forEach(cell => cell.classList.remove('drop-target'));
}

function attachDragHandlers() {
    if (!resultsBody) return;
    const cells = resultsBody.querySelectorAll('.recipient-cell');
    cells.forEach(cell => {
        cell.addEventListener('dragstart', handleDragStart);
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragenter', handleDragEnter);
        cell.addEventListener('dragleave', handleDragLeave);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('dragend', handleDragEnd);
    });
}

function renderPairs(pairs, options = {}) {
    if (!resultsBody || !Array.isArray(pairs)) return;
    const initialLockMap = {};
    if (Array.isArray(options.locks)) {
        options.locks.forEach(lock => {
            if (!lock || lock.santa_id == null || lock.recipient_id == null) return;
            const santaId = Number(lock.santa_id);
            const recipientId = Number(lock.recipient_id);
            if (!Number.isNaN(santaId) && !Number.isNaN(recipientId)) {
                initialLockMap[santaId] = recipientId;
            }
        });
    }

    currentLocksMap = {};
    assignedLockedPairs = {};
    resultsBody.innerHTML = '';
    const assignedSet = new Set((options.assignedLocks || []).map(Number));

    const formatLocation = (country, city) => {
        if (!country && !city) return '‚Äî';
        if (country && city) {
            return `${country} / ${city}`;
        }
        return country || city || '‚Äî';
    };

    pairs.forEach(pair => {
        const row = document.createElement('tr');
        const santaId = Number(pair.santa_id);
        const recipientId = Number(pair.recipient_id);
        row.dataset.santaId = santaId;
        row.dataset.santaCountry = pair.santa_country || '';
        row.dataset.santaCity = pair.santa_city || '';
        row.dataset.recipientId = recipientId;
        row.dataset.recipientName = pair.recipient_name || '';
        row.dataset.recipientCountry = pair.recipient_country || '';
        row.dataset.recipientCity = pair.recipient_city || '';
        row.dataset.locked = 'false';

        row.dataset.assigned = 'false';

        const santaCell = document.createElement('td');
        santaCell.dataset.label = '–î–µ–¥ –ú–æ—Ä–æ–∑';
        const santaName = document.createElement('div');
        santaName.className = 'table-primary-text';
        santaName.textContent = pair.santa_name;
        const santaLocation = document.createElement('div');
        santaLocation.className = 'table-secondary-text';
        santaLocation.textContent = formatLocation(pair.santa_country, pair.santa_city);
        santaCell.appendChild(santaName);
        santaCell.appendChild(santaLocation);

        const recipientCell = document.createElement('td');
        recipientCell.dataset.label = '–í–Ω—É—á–æ–∫/–í–Ω—É—á–∫–∞';
        recipientCell.dataset.recipientId = String(recipientId);
        recipientCell.dataset.recipientName = pair.recipient_name;
        recipientCell.dataset.recipientCountry = pair.recipient_country || '';
        recipientCell.dataset.recipientCity = pair.recipient_city || '';
        recipientCell.classList.add('recipient-cell');
        recipientCell.setAttribute('draggable', 'true');
        const recipientName = document.createElement('div');
        recipientName.className = 'table-primary-text';
        recipientName.textContent = pair.recipient_name;
        const recipientLocation = document.createElement('div');
        recipientLocation.className = 'table-secondary-text';
        recipientLocation.textContent = formatLocation(pair.recipient_country, pair.recipient_city);
        recipientCell.appendChild(recipientName);
        recipientCell.appendChild(recipientLocation);

        const actionCell = document.createElement('td');
        actionCell.dataset.label = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
        actionCell.classList.add('distribution-actions-cell');
        const lockWrapper = document.createElement('div');
        lockWrapper.classList.add('distribution-actions-group');
        const lockButton = document.createElement('button');
        lockButton.type = 'button';
        lockButton.className = 'btn-icon lock-toggle';
        lockButton.innerHTML = 'üîì';
        lockButton.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É';
        lockButton.addEventListener('click', async () => {
            const isLocked = row.dataset.locked === 'true';
            const santaId = Number(row.dataset.santaId);
            if (isLocked && row.dataset.assigned === 'true') {
                const confirmed = confirm('–°–Ω—è—Ç—å –∑–∞–º–æ–∫? –ó–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ.');
                if (!confirmed) {
                    return;
                }
                lockButton.disabled = true;
                const result = await removeAssignmentForSanta(santaId);
                if (!result.ok) {
                    showMessage(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.', 'error');
                    lockButton.disabled = false;
                    return;
                }
                showMessage(result.message || '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.', 'info');
                delete assignedLockedPairs[santaId];
                row.dataset.assigned = 'false';
            }
            updateRowLockState(row, !isLocked);
            lockButton.disabled = false;
        });
        lockWrapper.appendChild(lockButton);
        actionCell.appendChild(lockWrapper);

        const statusCell = document.createElement('td');
        statusCell.dataset.label = '–°—Ç–∞—Ç—É—Å';
        const statusBadge = document.createElement('span');
        statusBadge.classList.add('distribution-status');
        const sentStamp = pair.santa_sent_at ? new Date(pair.santa_sent_at) : null;
        const receivedStamp = pair.recipient_received_at ? new Date(pair.recipient_received_at) : null;
        if (receivedStamp) {
            statusBadge.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
            statusBadge.classList.add('status-complete');
        } else if (sentStamp) {
            statusBadge.textContent = '–û—Ç–ø—Ä–∞–≤–∏–ª';
            statusBadge.classList.add('status-sent');
        } else {
            statusBadge.textContent = '–ù–µ –æ—Ç–ø—Ä–∞–≤–∏–ª';
            statusBadge.classList.add('status-pending');
        }
        statusCell.appendChild(statusBadge);

        row.appendChild(santaCell);
        row.appendChild(recipientCell);
        row.appendChild(statusCell);
        row.appendChild(actionCell);
        resultsBody.appendChild(row);

        const isAssignmentLocked = Boolean(pair.assignment_locked) || assignedSet.has(santaId);
        row.dataset.assigned = isAssignmentLocked ? 'true' : 'false';
        if (isAssignmentLocked) {
            assignedLockedPairs[santaId] = recipientId;
            initialLockMap[santaId] = recipientId;
        }

        const shouldLock = initialLockMap[santaId] !== undefined && Number(initialLockMap[santaId]) === recipientId;
        updateRowLockState(row, shouldLock, { silent: true });
        if (shouldLock && row.dataset.assigned === 'true') {
            lockButton.classList.add('lock-fixed');
            lockButton.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ä—É (–∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ)';
        }
    });

    resultsSection.style.display = pairs.length ? 'block' : 'none';
    attachDragHandlers();
    updateAssignmentsButtonVisibility();

    if (options.markDirty === false) {
        pendingChanges = false;
        if (saveBtn) {
            saveBtn.disabled = true;
        }
        if (saveContainer) {
            saveContainer.style.display = 'none';
        }
    } else if (options.markDirty) {
        markDirty();
    }
}

async function handleGenerate() {
    hideMessage();
    if (!generateBtn) return;
    const lockedPairs = collectLockedPairs();
    generateBtn.disabled = true;
    generateBtn.textContent = '\u{1F3B2} –§–æ—Ä–º–∏—Ä—É–µ–º...';
    if (saveBtn) {
        saveBtn.disabled = true;
    }

    try {
        const response = await fetch(generateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                group_by_country: sameCountryToggle ? sameCountryToggle.checked : false,
                locked_pairs: lockedPairs,
                assignment_locked_santas: Object.keys(assignedLockedPairs).map(Number)
            })
        });
        const data = await response.json();
        if (response.ok && data.success) {
            if (sameCountryToggle && Object.prototype.hasOwnProperty.call(data, 'country_mode_applied')) {
                sameCountryToggle.checked = Boolean(data.country_mode_applied);
            }
            const countryModeApplied = data.country_mode_applied !== false;
            const assignedSantas = Object.keys(assignedLockedPairs).map(Number);
            renderPairs(data.pairs, { markDirty: false, locks: lockedPairs, assignedLocks: assignedSantas });
            const saveResult = await savePairs({ showSuccess: false });
            if (saveResult.ok) {
                const successMessage = countryModeApplied
                    ? '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º.'
                    : '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –†–µ–∂–∏–º ¬´–ü–æ —Å—Ç—Ä–∞–Ω–∞–º¬ª –æ—Ç–∫–ª—é—á—ë–Ω –¥–ª—è —á–∞—Å—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.';
                showMessage(successMessage, 'success');
            } else {
                showMessage('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å: ' + saveResult.message, 'error');
            }
        } else {
            showMessage(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
            if (saveBtn) {
                saveBtn.disabled = !pendingChanges;
            }
        }
    } catch (error) {
        console.error(error);
        showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.', 'error');
        if (saveBtn) {
            saveBtn.disabled = !pendingChanges;
        }
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '\u{1F3B2} –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å';
    }
}

if (generateBtn) {
    generateBtn.addEventListener('click', handleGenerate);
}

if (saveBtn) {
    saveBtn.addEventListener('click', async () => {
        const result = await savePairs();
        showMessage(result.message, result.ok ? 'success' : 'error');
    });
}

if (assignmentsBtn) {
    assignmentsBtn.addEventListener('click', async () => {
        const lockedPairs = collectLockedPairs();
        if (!lockedPairs.length || lockedPairs.length !== (resultsBody ? resultsBody.querySelectorAll('tr').length : 0)) {
            showMessage('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –∫–∞–∂–¥—É—é –ø–∞—Ä—É –∑–∞–º–∫–æ–º.', 'error');
            return;
        }

        assignmentsBtn.disabled = true;
        assignmentsBtn.textContent = 'üì¶ –°–æ–∑–¥–∞—ë–º...';
        for (const [santaId, recipientId] of Object.entries(currentLocksMap)) {
            const row = resultsBody.querySelector(`tr[data-santa-id="${santaId}"]`);
            if (!row) continue;
            const cell = row.querySelector('.recipient-cell');
            if (!cell) continue;
            if (Number(cell.dataset.recipientId) !== Number(recipientId)) {
                showMessage('–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è –ø–∞—Ä–∞ –≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–¥–∞–Ω–∏–π.', 'error');
                assignmentsBtn.disabled = false;
                assignmentsBtn.textContent = 'üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è';
                return;
            }
        }
        try {
            const response = await fetch({{ distribution_create_assignments_url|tojson }}, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });
            const data = await response.json();
            if (response.ok && data.success) {
                showMessage(data.message || '–ó–∞–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.', 'success');
            } else {
                showMessage(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è.', 'error');
            }
        } catch (error) {
            console.error(error);
            showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏–π.', 'error');
        } finally {
            assignmentsBtn.disabled = false;
            assignmentsBtn.textContent = 'üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è';
        }
    });
}

if (existingPairs && existingPairs.length) {
    const initialLocks = existingPairs
        .filter(pair => pair && pair.locked)
        .map(pair => ({
            santa_id: pair.santa_id,
            recipient_id: pair.recipient_id
        }));
    renderPairs(existingPairs, { markDirty: false, locks: initialLocks, assignedLocks: lockedFromAssignments || [] });
    const hasLockedPairs = existingPairs.some(pair => pair && pair.locked);
    if (hasLockedPairs) {
        showMessage('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø–∞—Ä—ã –≤—ã–¥–µ–ª–µ–Ω—ã.', 'info');
    } else {
        showMessage('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'info');
    }
} else {
    showMessage('–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä—ã –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.', 'info');
}
</script>
{% endblock %}

