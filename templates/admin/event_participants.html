{% extends "base.html" %}

{% block title %}–£—á–∞—Å—Ç–Ω–∏–∫–∏ {{ event.name }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h1>
            <p class="text-muted" style="margin: 0;">{{ event.name }}</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            <a href="{{ url_for('admin_event_view', event_id=event.id) }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é</a>
            <a href="{{ url_for('admin_events') }}" class="btn btn-secondary">–°–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</a>
        </div>
    </div>

    <div class="event-meta-card">
        <div class="event-meta-item">
            <span class="event-meta-label">ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</span>
            <span class="event-meta-value">#{{ event.id }}</span>
        </div>
        <div class="event-meta-item">
            <span class="event-meta-label">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>
            <span class="event-meta-value">{{ event.creator_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
        </div>
        <div class="event-meta-item">
            <span class="event-meta-label">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
            <span class="event-meta-value">{{ participants_count }}</span>
        </div>
        <div class="event-meta-item">
            <span class="event-meta-label">–û–ø–∏—Å–∞–Ω–∏–µ</span>
            <span class="event-meta-value">{{ event.description or '‚Äî' }}</span>
        </div>
    </div>

    <div class="admin-card">
        <h2 style="margin-top: 0;">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤—Ä—É—á–Ω—É—é</h2>
        <form method="POST" action="{{ url_for('admin_event_participant_add', event_id=event.id) }}" class="manual-add-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="user_identifier" class="form-label">ID –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="user_identifier" name="user_identifier" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12345 –∏–ª–∏ username" required>
                </div>
                <div class="form-group">
                    <label for="notes" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" id="notes" name="notes" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ–±–∞–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é">
                </div>
                <div class="form-group">
                    <label for="stage" class="form-label">–≠—Ç–∞–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                    <select id="stage" name="stage" class="form-select" required>
                        <option value="pre" selected>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</option>
                        <option value="main">–û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</option>
                    </select>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
                <p class="text-muted" style="margin: 0;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ —Å—Ä–∞–∑—É –æ–¥–æ–±—Ä–µ–Ω.</p>
            </div>
        </form>
    </div>

{% macro participants_table(participants, show_actions=False) %}
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–§–ò–û</th>
                    <th>–ê–¥—Ä–µ—Å</th>
                    <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    {% if show_actions %}
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr>
                    <td data-label="ID">{{ participant.user_id }}</td>
                    <td data-label="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
                        <a href="{{ url_for('view_profile', user_id=participant.user_id) }}" class="contact-link">{{ participant.username }}</a>
                    </td>
                    <td data-label="–§–ò–û">
                        {% if participant.last_name or participant.first_name or participant.middle_name %}
                            {{ participant.last_name or '' }} {{ participant.first_name or '' }} {{ participant.middle_name or '' }}
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td data-label="–ê–¥—Ä–µ—Å">
                        {% if participant.postal_code or participant.country or participant.city or participant.street %}
                            <div class="address-text">
                                {% if participant.postal_code %}{{ participant.postal_code }},{% endif %}
                                {% if participant.country %} {{ participant.country }},{% endif %}
                                {% if participant.city %} {{ participant.city }},{% endif %}
                                {% if participant.street %} {{ participant.street }}{% endif %}
                                {% if participant.house %}, –¥. {{ participant.house }}{% endif %}
                                {% if participant.building %}, –∫–æ—Ä–ø. {{ participant.building }}{% endif %}
                                {% if participant.apartment %}, –∫–≤. {{ participant.apartment }}{% endif %}
                            </div>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td data-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã">
                        <div class="contacts-list">
                            {% if participant.email %}
                            <div><strong>Email:</strong> <a href="mailto:{{ participant.email }}" class="contact-link">{{ participant.email }}</a></div>
                            {% endif %}
                            {% if participant.phone %}
                            <div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <a href="tel:{{ participant.phone|replace(' ', '') }}" class="contact-link">{{ participant.phone }}</a></div>
                            {% endif %}
                            {% if participant.telegram %}
                            <div><strong>Telegram:</strong>
                                <a href="https://t.me/{{ participant.telegram.lstrip('@') }}" class="contact-link">
                                    {{ participant.telegram if participant.telegram.startswith('@') else '@' ~ participant.telegram }}
                                </a>
                            </div>
                            {% endif %}
                            {% if participant.whatsapp %}
                            <div><strong>WhatsApp:</strong> <a href="https://wa.me/{{ participant.whatsapp|replace(' ', '') }}" class="contact-link">{{ participant.whatsapp }}</a></div>
                            {% endif %}
                            {% if participant.viber %}
                            <div><strong>Viber:</strong> <a href="viber://chat?number={{ participant.viber|replace(' ', '') }}" class="contact-link">{{ participant.viber }}</a></div>
                            {% endif %}
                            {% if not (participant.email or participant.phone or participant.telegram or participant.whatsapp or participant.viber) %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </div>
                    </td>
                    <td data-label="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">
                        {% if participant.registered_at %}
                            {{ participant.registered_at }}
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td data-label="–°—Ç–∞—Ç—É—Å">
                        {% if participant.approval_status == 'approved' %}
                            <span class="badge badge-success">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                        {% elif participant.approval_status == 'rejected' %}
                            <span class="badge badge-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω</span>
                        {% else %}
                            <span class="badge badge-warning">–û–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è</span>
                        {% endif %}
                        {% if participant.approval_notes %}
                        <div class="text-muted small" style="margin-top: 0.25rem;">{{ participant.approval_notes }}</div>
                        {% endif %}
                    </td>
                    {% if show_actions %}
                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                        <div class="table-action-group">
                            {% if participant.can_confirm_participant and participant.stage == 'main' %}
                            <form method="POST" action="{{ url_for('admin_event_participant_confirm', event_id=event.id) }}">
                                <input type="hidden" name="user_id" value="{{ participant.user_id }}">
                                <button type="submit" class="btn-icon" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ">‚úÖ</button>
                            </form>
                            {% endif %}
                            {% if participant.can_reject_participant and participant.stage == 'main' %}
                            <form method="POST" action="{{ url_for('admin_event_participant_reject', event_id=event.id) }}" class="participant-reject-form">
                                <input type="hidden" name="user_id" value="{{ participant.user_id }}">
                                <input type="hidden" name="reason" class="reject-reason-input">
                                <button type="button" class="btn-icon btn-icon-danger participant-reject-btn" data-username="{{ participant.username }}">üö´</button>
                            </form>
                            {% endif %}
                            {% if participant.can_upgrade_to_main %}
                            <form method="POST" action="{{ url_for('admin_event_participant_upgrade', event_id=event.id) }}">
                                <input type="hidden" name="user_id" value="{{ participant.user_id }}">
                                <button type="submit" class="btn-icon" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é">‚¨ÜÔ∏è</button>
                            </form>
                            {% endif %}
                            {% if participant.can_downgrade_to_pre %}
                            <form method="POST" action="{{ url_for('admin_event_participant_downgrade', event_id=event.id) }}">
                                <input type="hidden" name="user_id" value="{{ participant.user_id }}">
                                <button type="submit" class="btn-icon" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é">‚¨áÔ∏è</button>
                            </form>
                            {% endif %}
                            <form method="POST" action="{{ url_for('admin_event_participant_remove', event_id=event.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ {{ participant.username }} –∏–∑ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è?');">
                                <input type="hidden" name="user_id" value="{{ participant.user_id }}">
                                <button type="submit" class="btn-icon btn-icon-danger" title="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞">üóëÔ∏è</button>
                            </form>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}

                {% if not participants %}
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        –£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    {% endmacro %}

    <div class="admin-tabs">
        <a class="admin-tab-btn active" data-tab="all" href="#all">–í—Å–µ ({{ participants_count }})</a>
        <a class="admin-tab-btn" data-tab="pre" href="#pre">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ({{ participants_pre_count }})</a>
        <a class="admin-tab-btn" data-tab="main" href="#main">–û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ({{ participants_main_count }})</a>
        <a class="admin-tab-btn" data-tab="positive" href="#positive">–ü–æ–∑–∏—Ç–∏–≤ ({{ participants_positive_count }})</a>
        <a class="admin-tab-btn" data-tab="negative" href="#negative">–ù–µ–≥–∞—Ç–∏–≤ ({{ participants_negative_count }})</a>
        <a class="admin-tab-btn" data-tab="na" href="#na">N/A ({{ participants_na_count }})</a>
    </div>

    <div class="admin-tab-content active" data-tab="all">
        {{ participants_table(participants_all, show_actions=True) }}
    </div>
    <div class="admin-tab-content" data-tab="pre">
        {{ participants_table(participants_pre, show_actions=True) }}
    </div>
    <div class="admin-tab-content" data-tab="main">
        {{ participants_table(participants_main, show_actions=True) }}
    </div>
    <div class="admin-tab-content" data-tab="positive">
        {{ participants_table(participants_positive, show_actions=True) }}
    </div>
    <div class="admin-tab-content" data-tab="negative">
        {{ participants_table(participants_negative, show_actions=True) }}
    </div>
    <div class="admin-tab-content" data-tab="na">
        {{ participants_table(participants_na, show_actions=True) }}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.admin-tab-btn');
    const contents = document.querySelectorAll('.admin-tab-content');

    function activateTab(tabName, updateHash = true) {
        tabs.forEach(btn => {
            if (btn.dataset.tab === tabName) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        contents.forEach(content => {
            if (content.dataset.tab === tabName) {
                content.classList.add('active');
            } else {
                content.classList.remove('active');
            }
        });

        if (updateHash) {
            const targetHash = '#' + tabName;
            if (window.location.hash !== targetHash) {
                history.replaceState(null, '', targetHash);
            }
        }
    }

    tabs.forEach(btn => {
        btn.addEventListener('click', function(event) {
            event.preventDefault();
            activateTab(this.dataset.tab);
        });
    });

    const initialHash = window.location.hash ? window.location.hash.substring(1) : '';
    if (initialHash) {
        const exists = Array.from(tabs).some(btn => btn.dataset.tab === initialHash);
        if (exists) {
            activateTab(initialHash, false);
        }
    }

    window.addEventListener('hashchange', function() {
        const newHash = window.location.hash ? window.location.hash.substring(1) : '';
        if (newHash) {
            const exists = Array.from(tabs).some(btn => btn.dataset.tab === newHash);
            if (exists) {
                activateTab(newHash, false);
            }
        }
    });

    const rejectButtons = document.querySelectorAll('.participant-reject-btn');
    rejectButtons.forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('form');
            const reasonInput = form.querySelector('.reject-reason-input');
            const username = this.dataset.username || '';
            const promptText = username ? `–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ –¥–ª—è ${username} (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):` : '–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):';
            const reason = window.prompt(promptText, '');
            if (reason === null) {
                return;
            }
            reasonInput.value = reason || '';
            form.submit();
        });
    });
});
</script>
{% endblock %}

