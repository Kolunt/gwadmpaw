{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
        <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
    
    <form method="POST" class="settings-form" enctype="multipart/form-data">
        <!-- –¢–∞–±—ã -->
        <div class="settings-tabs">
            {% for category, settings in settings_by_category.items() %}
            <a 
                href="{{ url_for('admin_settings') }}#{{ category }}"
                class="settings-tab {% if loop.first %}active{% endif %}"
                data-tab="{{ category }}"
            >
                {% if category == 'gwars' %}
                    ‚öîÔ∏è GWars
                {% elif category == 'system' %}
                    üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ
                {% elif category == 'integrations' %}
                    üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
                {% else %}
                    üìã –û–±—â–∏–µ
                {% endif %}
            </a>
            {% endfor %}
        </div>
        
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ -->
        {% for category, settings in settings_by_category.items() %}
        <div class="settings-tab-content {% if loop.first %}active{% endif %}" data-tab="{{ category }}">
            {% if category == 'integrations' %}
            <!-- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π -->
            <div class="integrations-container">
                <!-- –ü–æ–¥—Ç–∞–±—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π -->
                <div class="integrations-subtabs">
                    <button type="button" class="integration-subtab active" data-integration="dadata">
                        üîç Dadata
                    </button>
                </div>
                
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–¥—Ç–∞–±–æ–≤ -->
                <div class="integration-content active" data-integration="dadata">
                    <div class="settings-section">
                        <h2 class="settings-section-title">üîç –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Dadata</h2>
                        
                        {% set dadata_api_key = settings_dict.get('dadata_api_key', {}) %}
                        {% set dadata_secret_key = settings_dict.get('dadata_secret_key', {}) %}
                        {% set dadata_enabled = settings_dict.get('dadata_enabled', {}) %}
                        {% set dadata_verified = settings_dict.get('dadata_verified', {}) %}
                        
                        <div class="dadata-integration-form">
                            <div class="setting-item">
                                <label for="dadata_api_key" class="setting-label">
                                    API –∫–ª—é—á
                                    <small class="setting-hint">API –∫–ª—é—á –æ—Ç Dadata</small>
                                </label>
                                <input 
                                    type="text" 
                                    id="dadata_api_key" 
                                    name="setting_dadata_api_key" 
                                    value="{{ dadata_api_key.get('value', '') if dadata_api_key else '' }}"
                                    class="setting-input"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á"
                                >
                            </div>
                            
                            <div class="setting-item">
                                <label for="dadata_secret_key" class="setting-label">
                                    Secret –∫–ª—é—á
                                    <small class="setting-hint">Secret –∫–ª—é—á –æ—Ç Dadata</small>
                                </label>
                                <input 
                                    type="password" 
                                    id="dadata_secret_key" 
                                    name="setting_dadata_secret_key" 
                                    value="{{ dadata_secret_key.get('value', '') if dadata_secret_key else '' }}"
                                    class="setting-input"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ Secret –∫–ª—é—á"
                                >
                            </div>
                            
                            <div class="setting-item">
                                <button type="button" id="verify-dadata-btn" class="btn btn-secondary">
                                    üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏
                                </button>
                                <span id="dadata-verify-status" class="verify-status"></span>
                            </div>
                            
                            <div class="setting-item">
                                <label for="dadata_enabled" class="setting-label">
                                    <input 
                                        type="checkbox" 
                                        id="dadata_enabled" 
                                        name="setting_dadata_enabled" 
                                        value="1"
                                        {% if dadata_enabled and dadata_enabled.get('value', '0') == '1' %}checked{% endif %}
                                        {% if not dadata_verified or dadata_verified.get('value', '0') != '1' %}disabled{% endif %}
                                        class="setting-checkbox"
                                        onchange="document.getElementById('dadata_enabled_hidden').value = this.checked ? '1' : '0';"
                                    >
                                    <input type="hidden" id="dadata_enabled_hidden" name="setting_dadata_enabled" value="{% if dadata_enabled and dadata_enabled.get('value', '0') == '1' %}1{% else %}0{% endif %}">
                                    <span>–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é Dadata</span>
                                    <small class="setting-hint">
                                        {% if not dadata_verified or dadata_verified.get('value', '0') != '1' %}
                                            –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏
                                        {% else %}
                                            –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞
                                        {% endif %}
                                    </small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="settings-section">
                <h2 class="settings-section-title">
                    {% if category == 'gwars' %}
                        ‚öîÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GWars
                    {% elif category == 'system' %}
                        üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    {% else %}
                        üìã –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    {% endif %}
                </h2>
                
                <div class="settings-grid">
                    {% for setting in settings %}
                    <div class="setting-card">
                        <div class="setting-card-header">
                            <label for="setting_{{ setting.key }}" class="setting-label">
                                {{ setting.description or setting.key }}
                            </label>
                            {% if setting.key == 'admin_user_ids' %}
                                <span class="setting-badge">–°–∏—Å—Ç–µ–º–∞</span>
                            {% elif setting.key in ['gwars_site_id', 'gwars_host'] %}
                                <span class="setting-badge">GWars</span>
                            {% elif setting.key in ['default_theme', 'site_icon', 'site_logo', 'site_title', 'site_description', 'logo_text'] %}
                                <span class="setting-badge">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</span>
                            {% endif %}
                        </div>
                        <div class="setting-card-body">
                            {% if setting.key == 'admin_user_ids' %}
                                <small class="setting-hint">ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: 283494, 240139)</small>
                            {% elif setting.key == 'gwars_site_id' %}
                                <small class="setting-hint">–ß–∏—Å–ª–æ–≤–æ–π ID —Å–∞–π—Ç–∞ –≤ GWars</small>
                            {% elif setting.key == 'gwars_host' %}
                                <small class="setting-hint">–î–æ–º–µ–Ω –±–µ–∑ http:// (–Ω–∞–ø—Ä–∏–º–µ—Ä: gwadm.pythonanywhere.com)</small>
                            {% elif setting.key == 'default_theme' %}
                                <small class="setting-hint">–¢–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
                            {% elif setting.key == 'site_icon' %}
                                <small class="setting-hint">–ò–∫–æ–Ω–∫–∞ —Å–∞–π—Ç–∞ (favicon). –§–æ—Ä–º–∞—Ç—ã: .ico, .png, .jpg, .svg</small>
                            {% elif setting.key == 'site_logo' %}
                                <small class="setting-hint">–õ–æ–≥–æ—Ç–∏–ø —Å–∞–π—Ç–∞. –§–æ—Ä–º–∞—Ç—ã: .png, .jpg, .svg, .gif, .webp</small>
                            {% elif setting.key == 'site_title' %}
                                <small class="setting-hint">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∞–π—Ç–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞</small>
                            {% elif setting.key == 'site_description' %}
                                <small class="setting-hint">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∞–π—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º</small>
                            {% elif setting.key == 'logo_text' %}
                                <small class="setting-hint">–¢–µ–∫—Å—Ç, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ä—è–¥–æ–º —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞</small>
                            {% endif %}
                        {% if setting.key == 'default_theme' %}
                        <select 
                            id="setting_{{ setting.key }}" 
                            name="setting_{{ setting.key }}" 
                            class="setting-input"
                        >
                            <option value="light" {% if setting.value == 'light' %}selected{% endif %}>–°–≤–µ—Ç–ª–∞—è</option>
                            <option value="dark" {% if setting.value == 'dark' %}selected{% endif %}>–¢–µ–º–Ω–∞—è</option>
                        </select>
                        {% elif setting.key == 'site_icon' %}
                        <div class="file-upload-group">
                            {% if setting.value %}
                            <div class="current-file-preview">
                                <img src="{{ setting.value }}" alt="–¢–µ–∫—É—â–∞—è –∏–∫–æ–Ω–∫–∞" class="file-preview-icon">
                                <span class="current-file-label">–¢–µ–∫—É—â–∞—è –∏–∫–æ–Ω–∫–∞</span>
                            </div>
                            {% endif %}
                            <input 
                                type="file" 
                                id="site_icon" 
                                name="site_icon" 
                                accept=".ico,.png,.jpg,.jpeg,.svg"
                                class="file-input"
                            >
                            <label for="site_icon" class="file-upload-label">
                                <span class="file-upload-text">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                                <span class="file-upload-btn">üìÅ</span>
                            </label>
                        </div>
                        {% elif setting.key == 'site_logo' %}
                        <div class="file-upload-group">
                            {% if setting.value %}
                            <div class="current-file-preview">
                                <img src="{{ setting.value }}" alt="–¢–µ–∫—É—â–∏–π –ª–æ–≥–æ—Ç–∏–ø" class="file-preview-logo">
                                <span class="current-file-label">–¢–µ–∫—É—â–∏–π –ª–æ–≥–æ—Ç–∏–ø</span>
                            </div>
                            {% endif %}
                            <input 
                                type="file" 
                                id="site_logo" 
                                name="site_logo" 
                                accept=".png,.jpg,.jpeg,.svg,.gif,.webp"
                                class="file-input"
                            >
                            <label for="site_logo" class="file-upload-label">
                                <span class="file-upload-text">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                                <span class="file-upload-btn">üìÅ</span>
                            </label>
                        </div>
                        {% elif setting.key == 'site_description' %}
                        <textarea 
                            id="setting_{{ setting.key }}" 
                            name="setting_{{ setting.key }}" 
                            rows="3"
                            class="setting-input"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∞–π—Ç–∞"
                        >{{ setting.value or '' }}</textarea>
                        {% else %}
                        <input 
                            type="text" 
                            id="setting_{{ setting.key }}" 
                            name="setting_{{ setting.key }}" 
                            value="{{ setting.value or '' }}"
                            class="setting-input"
                            {% if setting.key == 'gwars_site_id' %}pattern="[0-9]+"{% endif %}
                        >
                        {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π URL hash
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.settings-tab');
    const tabContents = document.querySelectorAll('.settings-tab-content');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–∞
    function switchTab(tabName) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —Ç–∞–±–æ–≤ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∞–±—É –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
        const selectedTab = document.querySelector(`.settings-tab[data-tab="${tabName}"]`);
        const selectedContent = document.querySelector(`.settings-tab-content[data-tab="${tabName}"]`);
        
        if (selectedTab && selectedContent) {
            selectedTab.classList.add('active');
            selectedContent.classList.add('active');
            // –û–±–Ω–æ–≤–ª—è–µ–º URL hash –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (window.location.hash !== '#' + tabName) {
                window.history.replaceState(null, '', '#' + tabName);
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–∞–±–∞–º
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');
            switchTab(targetTab);
        });
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º hash –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const hash = window.location.hash.substring(1); // –£–±–∏—Ä–∞–µ–º #
    if (hash) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–± —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
        const tabExists = Array.from(tabs).some(t => t.getAttribute('data-tab') === hash);
        if (tabExists) {
            switchTab(hash);
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è hash (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–Ω–æ–ø–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞)
    window.addEventListener('hashchange', function() {
        const newHash = window.location.hash.substring(1);
        if (newHash) {
            const tabExists = Array.from(tabs).some(t => t.getAttribute('data-tab') === newHash);
            if (tabExists) {
                switchTab(newHash);
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Dadata API
    const verifyDadataBtn = document.getElementById('verify-dadata-btn');
    const verifyStatus = document.getElementById('dadata-verify-status');
    const dadataEnabledCheckbox = document.getElementById('dadata_enabled');
    
    if (verifyDadataBtn) {
        verifyDadataBtn.addEventListener('click', function() {
            const apiKey = document.getElementById('dadata_api_key').value.trim();
            const secretKey = document.getElementById('dadata_secret_key').value.trim();
            
            if (!apiKey || !secretKey) {
                verifyStatus.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è';
                verifyStatus.className = 'verify-status error';
                return;
            }
            
            verifyDadataBtn.disabled = true;
            verifyDadataBtn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            verifyStatus.textContent = '';
            verifyStatus.className = 'verify-status';
            
            const formData = new FormData();
            formData.append('api_key', apiKey);
            formData.append('secret_key', secretKey);
            
            fetch('{{ url_for("verify_dadata") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    verifyStatus.textContent = '‚úÖ ' + data.message;
                    verifyStatus.className = 'verify-status success';
                    if (dadataEnabledCheckbox) {
                        dadataEnabledCheckbox.disabled = false;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                        const hint = dadataEnabledCheckbox.closest('.setting-item').querySelector('.setting-hint');
                        if (hint) {
                            hint.textContent = '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞';
                        }
                    }
                } else {
                    verifyStatus.textContent = '‚ùå ' + data.message;
                    verifyStatus.className = 'verify-status error';
                    if (dadataEnabledCheckbox) {
                        dadataEnabledCheckbox.disabled = true;
                        dadataEnabledCheckbox.checked = false;
                        const hiddenInput = document.getElementById('dadata_enabled_hidden');
                        if (hiddenInput) {
                            hiddenInput.value = '0';
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                        const hint = dadataEnabledCheckbox.closest('.setting-item').querySelector('.setting-hint');
                        if (hint) {
                            hint.textContent = '–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏';
                        }
                    }
                }
            })
            .catch(error => {
                verifyStatus.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: ' + error.message;
                verifyStatus.className = 'verify-status error';
            })
            .finally(() => {
                verifyDadataBtn.disabled = false;
                verifyDadataBtn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏';
            });
        });
    }
});
</script>
{% endblock %}

