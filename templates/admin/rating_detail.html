{% extends "base.html" %}

{% block title %}Снежинки - {{ user.username or ('ID ' ~ user.user_id) }}{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <h1>❄️ Снежинки участника</h1>
                <p class="text-muted" style="margin: 0;">
                    {{ user.username or ('ID ' ~ user.user_id) }} · ID {{ user.user_id }}
                </p>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <a href="{{ url_for('user_rating') }}" class="btn btn-secondary">← К рейтингу</a>
                <a href="{{ url_for('view_profile', user_id=user.user_id) }}" class="btn btn-outline-secondary">Профиль</a>
            </div>
        </div>

        <div class="event-view-card">
            <h2 style="margin-bottom: 1rem;">Итоговые снежинки: {{ active_count }}</h2>

            {% if events %}
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Источник</th>
                            <th>Причина</th>
                            <th style="width: 8rem;">Статус</th>
                            <th style="width: 11rem;">Выдано</th>
                            <th style="width: 11rem;">Обновлено</th>
                            <th style="width: 11rem;">Аннулировано</th>
                            <th style="width: 10rem;">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr>
                            <td data-label="Источник">
                                {{ source_labels.get(event.source, event.source) }}
                            </td>
                            <td data-label="Причина">
                                {{ event.reason }}
                            </td>
                            <td data-label="Статус">
                                {% if event.active %}
                                <span class="badge badge-success">Активна</span>
                                {% elif event.manual_revoked %}
                                <span class="badge badge-danger">Аннулирована</span>
                                {% else %}
                                <span class="badge badge-secondary">Отключена</span>
                                {% endif %}
                            </td>
                            <td data-label="Выдано">
                                {{ event.created_at or '—' }}
                            </td>
                            <td data-label="Обновлено">
                                {{ event.updated_at or '—' }}
                            </td>
                            <td data-label="Аннулировано">
                                {{ event.revoked_at or '—' }}
                            </td>
                            <td data-label="Действия">
                                {% if event.active %}
                                <form method="post" action="{{ url_for('admin_rating_event_annul', event_id=event.id) }}" onsubmit="return confirm('Аннулировать снежинку?');">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">Аннулировать</button>
                                </form>
                                {% else %}
                                    {% if event.manual_revoked %}
                                    <form method="post" action="{{ url_for('admin_rating_event_restore', event_id=event.id) }}" onsubmit="return confirm('Восстановить снежинку?');">
                                        <button type="submit" class="btn btn-outline-success btn-sm">Восстановить</button>
                                    </form>
                                    {% else %}
                                    <span class="text-muted">Авто-отключена</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <p>Для этого участника пока нет записей о снежинках.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

