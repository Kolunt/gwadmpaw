<div id="registration-modal" class="modal" aria-hidden="true">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="registration-modal-title">–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h2>
            <button type="button" class="modal-close" id="registration-modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">&times;</button>
        </div>
        <div class="modal-body">
            <div id="registration-modal-error" class="alert alert-danger" role="alert" style="display: none;"></div>

            <div class="registration-step" data-step="step1">
                <div class="registration-step-content">
                    <h3>–ü–æ—á–µ–º—É –Ω—É–∂–Ω—ã —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ?</h3>
                    <p>–ú—ã –ø—Ä–æ—Å–∏–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –∏ –ø–æ—á—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –≤–æ–≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É –∏ –∏–º–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Å–≤—è–∑–∏ —Å –≤–∞–º–∏.</p>
                    <p>–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –ø—É–±–ª–∏—á–Ω–æ. –í—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</p>
                </div>
            </div>

            <div class="registration-step" data-step="step2">
                <div class="registration-step-content">
                    <h3>–§–∞–º–∏–ª–∏—è, –ò–º—è, –û—Ç—á–µ—Å—Ç–≤–æ</h3>
                    <div class="form-group">
                        <label for="registration-last-name" class="form-label">–§–∞–º–∏–ª–∏—è *</label>
                        <input type="text" id="registration-last-name" class="form-input" placeholder="–ò–≤–∞–Ω–æ–≤" autocomplete="family-name">
                    </div>
                    <div class="form-group">
                        <label for="registration-first-name" class="form-label">–ò–º—è *</label>
                        <input type="text" id="registration-first-name" class="form-input" placeholder="–ò–≤–∞–Ω" autocomplete="given-name">
                    </div>
                    <div class="form-group">
                        <label for="registration-middle-name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ *</label>
                        <input type="text" id="registration-middle-name" class="form-input" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á" autocomplete="additional-name">
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step3">
                <div class="registration-step-content">
                    <h3>–ê–¥—Ä–µ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞</h3>
                    <div class="form-grid-two">
                        <div class="form-group">
                            <label for="registration-postal-code" class="form-label">–ò–Ω–¥–µ–∫—Å *</label>
                            <input type="text" id="registration-postal-code" class="form-input" placeholder="123456" autocomplete="postal-code">
                        </div>
                        <div class="form-group">
                            <label for="registration-country" class="form-label">–°—Ç—Ä–∞–Ω–∞ *</label>
                            <input type="text" id="registration-country" class="form-input" placeholder="–†–æ—Å—Å–∏—è" autocomplete="country-name">
                        </div>
                        <div class="form-group">
                            <label for="registration-city" class="form-label">–ì–æ—Ä–æ–¥ *</label>
                            <input type="text" id="registration-city" class="form-input" placeholder="–ú–æ—Å–∫–≤–∞" autocomplete="address-level2">
                        </div>
                        <div class="form-group">
                            <label for="registration-street" class="form-label">–£–ª–∏—Ü–∞ *</label>
                            <input type="text" id="registration-street" class="form-input" placeholder="–õ–µ–Ω–∏–Ω–∞" autocomplete="address-line1">
                        </div>
                        <div class="form-group">
                            <label for="registration-house" class="form-label">–î–æ–º *</label>
                            <input type="text" id="registration-house" class="form-input" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label for="registration-building" class="form-label">–ö–æ—Ä–ø—É—Å / —Å—Ç—Ä–æ–µ–Ω–∏–µ *</label>
                            <input type="text" id="registration-building" class="form-input" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label for="registration-apartment" class="form-label">–ö–≤–∞—Ä—Ç–∏—Ä–∞ *</label>
                            <input type="text" id="registration-apartment" class="form-input" placeholder="25">
                        </div>
                    </div>
                    <div class="registration-hint">
                        <span class="registration-hint-icon">‚ÑπÔ∏è</span>
                        –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –Ω–æ–º–µ—Ä–∞ –∫–æ—Ä–ø—É—Å–∞/—Å—Ç—Ä–æ–µ–Ω–∏—è/–∫–≤–∞—Ä—Ç–∏—Ä—ã, –ø—Ä–æ—Å—Ç–æ –ø–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–æ—á–µ—Ä–∫ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–Ω–µ—Ç¬ª.
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step4">
                <div class="registration-step-content">
                    <h3>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</h3>
                    <p class="text-muted small-note">–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å e-mail –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é –∏ —Å–≤—è–∑–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</p>
                    <div class="form-group">
                        <label for="registration-email" class="form-label">E-mail *</label>
                        <input type="email" id="registration-email" class="form-input" placeholder="example@mail.com" autocomplete="email">
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step5">
                <div class="registration-step-content">
                    <h3>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
                    <p class="text-muted small-note">–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Å –≤–∞–º–∏ –º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è. –ú—ã –Ω–µ –±—É–¥–µ–º —Ä–∞—Å—Å—ã–ª–∞—Ç—å —Å–ø–∞–º.</p>
                    <div class="form-group">
                        <label for="registration-phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="registration-phone" class="form-input" placeholder="+7 (999) 123-45-67" autocomplete="tel">
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step6">
                <div class="registration-step-content">
                    <h3>–û —Å–µ–±–µ</h3>
                    <p class="text-muted small-note">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ, –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤–∞—à–µ–º—É –î–µ–¥—É –ú–æ—Ä–æ–∑—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ–¥–∞—Ä–æ–∫.</p>
                    <div class="form-group">
                        <label for="registration-bio" class="form-label">–û —Å–µ–±–µ</label>
                        <textarea id="registration-bio" class="form-input" rows="5" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ª—é–±–ª—é –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã, –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É—é –æ—Ç–∫—Ä—ã—Ç–∫–∏, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é —Ç—ë–ø–ª—ã–µ —à–∞—Ä—Ñ—ã, –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ."></textarea>
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step7">
                <div class="registration-step-content">
                    <h3>Telegram</h3>
                    <p class="text-muted small-note">–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Telegram, —É–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –Ω–æ–º–µ—Ä. –ò–Ω–∞—á–µ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é¬ª.</p>
                    <div class="form-group">
                        <label for="registration-telegram" class="form-label">–ê–∫–∫–∞—É–Ω—Ç –≤ Telegram</label>
                        <input type="text" id="registration-telegram" class="form-input" placeholder="@username">
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step8">
                <div class="registration-step-content">
                    <h3>WhatsApp</h3>
                    <p class="text-muted small-note">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å, –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—Ç—å—Ç–µ —ç—Ç–æ.</p>
                    <div class="form-group">
                        <label for="registration-whatsapp" class="form-label">–ê–∫–∫–∞—É–Ω—Ç –≤ WhatsApp</label>
                        <input type="text" id="registration-whatsapp" class="form-input" placeholder="+7 (999) 123-45-67">
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="step9">
                <div class="registration-step-content">
                    <h3>Viber</h3>
                    <p class="text-muted small-note">–ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Viber, –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é¬ª ‚Äî –ø–æ–ª–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—É—Å—Ç—ã–º.</p>
                    <div class="form-group">
                        <label for="registration-viber" class="form-label">–ê–∫–∫–∞—É–Ω—Ç –≤ Viber</label>
                        <input type="text" id="registration-viber" class="form-input" placeholder="+7 (999) 123-45-67">
                    </div>
                </div>
            </div>

            <div class="registration-step" data-step="stepfinal">
                <div class="registration-step-content">
                    <h3>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</h3>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∏–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞. –û–Ω–∞ –±—É–¥–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –∑–∞ —ç—Ç–∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ–º –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.</p>
                    <dl class="registration-summary">
                        <div class="summary-row">
                            <dt>–§–ò–û</dt>
                            <dd data-summary-field="fio"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–ò–Ω–¥–µ–∫—Å</dt>
                            <dd data-summary-field="postal_code"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–°—Ç—Ä–∞–Ω–∞</dt>
                            <dd data-summary-field="country"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–ì–æ—Ä–æ–¥</dt>
                            <dd data-summary-field="city"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–£–ª–∏—Ü–∞</dt>
                            <dd data-summary-field="street"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–î–æ–º</dt>
                            <dd data-summary-field="house"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–ö–æ—Ä–ø—É—Å / —Å—Ç—Ä–æ–µ–Ω–∏–µ</dt>
                            <dd data-summary-field="building"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–ö–≤–∞—Ä—Ç–∏—Ä–∞</dt>
                            <dd data-summary-field="apartment"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>E-mail</dt>
                            <dd data-summary-field="email"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–¢–µ–ª–µ—Ñ–æ–Ω</dt>
                            <dd data-summary-field="phone"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>Telegram</dt>
                            <dd data-summary-field="telegram"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>WhatsApp</dt>
                            <dd data-summary-field="whatsapp"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>Viber</dt>
                            <dd data-summary-field="viber"></dd>
                        </div>
                        <div class="summary-row">
                            <dt>–û —Å–µ–±–µ</dt>
                            <dd data-summary-field="bio"></dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-back-btn" id="registration-secondary-btn" style="display: none;" aria-label="–ù–∞–∑–∞–¥">üîô</button>
            <button type="button" class="btn btn-secondary" id="registration-tertiary-btn" style="display: none;"></button>
            <button type="button" class="btn btn-primary modal-primary-btn" id="registration-primary-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
(function() {
    if (window.__registrationModalInitialized) {
        return;
    }
    window.__registrationModalInitialized = true;

    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('registration-modal');
        if (!modal) {
            return;
        }

        const modalCloseBtn = document.getElementById('registration-modal-close');
        const modalTitle = document.getElementById('registration-modal-title');
        const errorBox = document.getElementById('registration-modal-error');
        const primaryBtn = document.getElementById('registration-primary-btn');
        const secondaryBtn = document.getElementById('registration-secondary-btn');
        const tertiaryBtn = document.getElementById('registration-tertiary-btn');

        const stepsOrder = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'stepfinal'];
        const stepElements = new Map();
        modal.querySelectorAll('.registration-step').forEach(step => {
            const key = step.getAttribute('data-step');
            if (key) {
                stepElements.set(key, step);
            }
        });

        const titles = {
            step1: '–≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
            step2: '–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
            step3: '–ê–¥—Ä–µ—Å –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞',
            step4: '–ö–æ–Ω—Ç–∞–∫—Ç—ã: e-mail',
            step5: '–ö–æ–Ω—Ç–∞–∫—Ç—ã: —Ç–µ–ª–µ—Ñ–æ–Ω',
            step6: '–û —Å–µ–±–µ',
            step7: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: Telegram',
            step8: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: WhatsApp',
            step9: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: Viber',
            stepfinal: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö'
        };

        const inputs = {
            last_name: document.getElementById('registration-last-name'),
            first_name: document.getElementById('registration-first-name'),
            middle_name: document.getElementById('registration-middle-name'),
            postal_code: document.getElementById('registration-postal-code'),
            country: document.getElementById('registration-country'),
            city: document.getElementById('registration-city'),
            street: document.getElementById('registration-street'),
            house: document.getElementById('registration-house'),
            building: document.getElementById('registration-building'),
            apartment: document.getElementById('registration-apartment'),
            email: document.getElementById('registration-email'),
            phone: document.getElementById('registration-phone'),
            bio: document.getElementById('registration-bio'),
            telegram: document.getElementById('registration-telegram'),
            whatsapp: document.getElementById('registration-whatsapp'),
            viber: document.getElementById('registration-viber')
        };

        const summaryFields = {};
        modal.querySelectorAll('[data-summary-field]').forEach(node => {
            summaryFields[node.getAttribute('data-summary-field')] = node;
        });

        const defaultProfile = {
            last_name: '',
            first_name: '',
            middle_name: '',
            postal_code: '',
            country: '',
            city: '',
            street: '',
            house: '',
            building: '',
            apartment: '',
            email: '',
            phone: '',
            bio: '',
            telegram: '',
            whatsapp: '',
            viber: ''
        };

        let profileData = { ...defaultProfile };
        let currentStepIndex = 0;
        let activeForm = null;
        let activeAction = '';
        let previousHash = '';
        let baseUrlWithoutHash = window.location.href.split('#')[0];
        let isBusy = false;

        function setHash(stepKey) {
            if (!stepKey) {
                return;
            }
            const targetUrl = `${baseUrlWithoutHash}#${stepKey}`;
            if (history.replaceState) {
                history.replaceState(null, '', targetUrl);
            } else {
                window.location.hash = stepKey;
            }
        }

        function restoreHash() {
            const targetUrl = previousHash ? `${baseUrlWithoutHash}${previousHash}` : baseUrlWithoutHash;
            if (history.replaceState) {
                history.replaceState(null, '', targetUrl);
            } else if (previousHash) {
                window.location.hash = previousHash;
            } else {
                window.location.hash = '';
            }
        }

        function showError(message) {
            if (!errorBox) return;
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }

        function clearError() {
            if (!errorBox) return;
            errorBox.style.display = 'none';
            errorBox.textContent = '';
        }

        function setBusy(state) {
            isBusy = state;
            primaryBtn.disabled = state;
            secondaryBtn.disabled = state;
            tertiaryBtn.disabled = state;
        }

        function fillInputs() {
            Object.keys(inputs).forEach(key => {
                const input = inputs[key];
                if (input) {
                    input.value = profileData[key] || '';
                }
            });
        }

        function textOrDash(value) {
            return value ? value : '‚Äî';
        }

        function updateSummary() {
            if (!summaryFields) return;
            const fio = [profileData.last_name, profileData.first_name, profileData.middle_name]
                .map(part => part || '')
                .filter(Boolean)
                .join(' ');
            if (summaryFields.fio) summaryFields.fio.textContent = fio || '‚Äî';
            ['postal_code', 'country', 'city', 'street', 'house', 'building', 'apartment', 'email', 'phone', 'telegram', 'whatsapp', 'viber', 'bio']
                .forEach(key => {
                    if (summaryFields[key]) {
                        summaryFields[key].textContent = textOrDash(profileData[key]);
                    }
                });
        }

        async function loadProfileData() {
            try {
                const response = await fetch('/api/profile/data', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    profileData = { ...defaultProfile };
                    return;
                }
                const result = await response.json();
                if (result && result.success && result.data) {
                    profileData = { ...defaultProfile, ...result.data };
                } else {
                    profileData = { ...defaultProfile };
                }
            } catch (error) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                profileData = { ...defaultProfile };
            }
        }

        async function saveProfileData(fields) {
            try {
                const response = await fetch('/api/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(fields)
                });
                if (!response.ok) {
                    let message = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                    try {
                        const data = await response.json();
                        if (data && data.error) {
                            message = data.error;
                        }
                    } catch (nested) {
                        const text = await response.text();
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:', response.status, text);
                    }
                    showError(message);
                    return false;
                }
                const result = await response.json();
                if (!result.success) {
                    showError(result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.');
                    return false;
                }
                profileData = { ...profileData, ...fields };
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                return false;
            }
        }

        async function handleStep2() {
            const data = {
                last_name: inputs.last_name.value.trim(),
                first_name: inputs.first_name.value.trim(),
                middle_name: inputs.middle_name.value.trim()
            };
            if (!data.last_name || !data.first_name || !data.middle_name) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é, –∏–º—è –∏ –æ—Ç—á–µ—Å—Ç–≤–æ.');
                return;
            }
            setBusy(true);
            const saved = await saveProfileData(data);
            setBusy(false);
            if (saved) {
                goToStep('step3');
            }
        }

        async function handleStep3() {
            const data = {
                postal_code: inputs.postal_code.value.trim(),
                country: inputs.country.value.trim(),
                city: inputs.city.value.trim(),
                street: inputs.street.value.trim(),
                house: inputs.house.value.trim(),
                building: inputs.building.value.trim(),
                apartment: inputs.apartment.value.trim()
            };
            const missing = Object.entries(data).filter(([, value]) => !value);
            if (missing.length > 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é.');
                return;
            }
            setBusy(true);
            const saved = await saveProfileData(data);
            setBusy(false);
            if (saved) {
                goToStep('step4');
            }
        }

        async function handleStep4() {
            const email = inputs.email.value.trim();
            if (!email) {
                showError('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.');
                return;
            }
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.');
                return;
            }
            setBusy(true);
            const saved = await saveProfileData({ email });
            setBusy(false);
            if (saved) {
                goToStep('step5');
            }
        }

        async function handleStep5() {
            const phone = inputs.phone.value.trim();
            if (!phone) {
                showError('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.');
                return;
            }
            setBusy(true);
            const saved = await saveProfileData({ phone });
            setBusy(false);
            if (saved) {
                goToStep('step6');
            }
        }

        async function handleStep6() {
            if (!inputs.bio) {
                goToStep('step7');
                return;
            }
            const bio = inputs.bio.value.trim();
            setBusy(true);
            const saved = await saveProfileData({ bio });
            setBusy(false);
            if (saved) {
                goToStep('step7');
            }
        }

        async function handleContactStep(fieldKey, requireValue) {
            const input = inputs[fieldKey];
            if (!input) {
                goToNextStep();
                return;
            }
            const value = input.value.trim();
            if (requireValue && !value) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é¬ª.');
                return;
            }
            if (!value) {
                goToNextStep();
                return;
            }
            setBusy(true);
            const saved = await saveProfileData({ [fieldKey]: value });
            setBusy(false);
            if (saved) {
                goToNextStep();
            }
        }

        async function handleNotUsing(fieldKey, storedValue) {
            const valueToSave = storedValue !== undefined ? storedValue : '–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é';
            setBusy(true);
            const saved = await saveProfileData({ [fieldKey]: valueToSave });
            setBusy(false);
            if (saved) {
                const input = inputs[fieldKey];
                if (input) {
                    input.value = valueToSave;
                }
                goToNextStep();
            }
        }

        async function finalizeRegistration() {
            if (!activeForm || !activeAction) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.');
                return;
            }
            setBusy(true);
            try {
                const response = await fetch(activeAction, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ final_registration: true })
                });
                if (!response.ok) {
                    const text = await response.text();
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', response.status, text);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                    setBusy(false);
                    return;
                }
                const result = await response.json();
                if (!result.success) {
                    showError(result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.');
                    setBusy(false);
                    return;
                }
                closeModal();
                window.location.reload();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                setBusy(false);
            }
        }

        function goToStep(stepKey) {
            const index = stepsOrder.indexOf(stepKey);
            if (index === -1) {
                return;
            }
            currentStepIndex = index;
            renderStep();
        }

        function goToNextStep() {
            if (currentStepIndex < stepsOrder.length - 1) {
                currentStepIndex += 1;
                renderStep();
            }
        }

        function goToPreviousStep() {
            if (currentStepIndex === 0) {
                closeModal();
                return;
            }
            currentStepIndex = Math.max(0, currentStepIndex - 1);
            renderStep();
        }

        function resetToStart() {
            currentStepIndex = 0;
            renderStep();
        }

        function renderStep() {
            clearError();
            stepElements.forEach((element, key) => {
                element.classList.toggle('active', key === stepsOrder[currentStepIndex]);
            });
            const activeKey = stepsOrder[currentStepIndex];
            modalTitle.textContent = titles[activeKey] || '–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö';
            setHash(activeKey);

            if (activeKey === 'stepfinal') {
                updateSummary();
            }

            primaryBtn.style.display = 'inline-block';
            primaryBtn.classList.remove('btn-secondary');
            primaryBtn.classList.add('btn-primary');
            primaryBtn.textContent = '–î–∞–ª–µ–µ';
            primaryBtn.onclick = null;

            secondaryBtn.style.display = 'none';
            secondaryBtn.onclick = null;
            secondaryBtn.classList.remove('btn-primary');
            secondaryBtn.classList.add('btn-secondary');

            tertiaryBtn.style.display = 'none';
            tertiaryBtn.onclick = null;

            switch (activeKey) {
                case 'step1':
                    primaryBtn.textContent = '–î–∞–ª–µ–µ';
                    primaryBtn.onclick = () => goToStep('step2');
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.textContent = '–ù–µ —Å–µ–π—á–∞—Å';
                    secondaryBtn.removeAttribute('title');
                    secondaryBtn.removeAttribute('aria-label');
                    secondaryBtn.onclick = closeModal;
                    break;
                case 'step2':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = handleStep2;
                    break;
                case 'step3':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = handleStep3;
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step2');
                    break;
                case 'step4':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = handleStep4;
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step3');
                    break;
                case 'step5':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = handleStep5;
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step4');
                    break;
                case 'step6':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = handleStep6;
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step5');
                    tertiaryBtn.style.display = 'inline-block';
                    tertiaryBtn.textContent = '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å';
                    tertiaryBtn.onclick = () => {
                        inputs.bio.value = '';
                        handleStep6();
                    };
                    break;
                case 'step7':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = () => handleContactStep('telegram', true);
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step6');
                    tertiaryBtn.style.display = 'inline-block';
                    tertiaryBtn.textContent = '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é';
                    tertiaryBtn.onclick = () => handleNotUsing('telegram', '–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é');
                    break;
                case 'step8':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = () => handleContactStep('whatsapp', true);
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step7');
                    tertiaryBtn.style.display = 'inline-block';
                    tertiaryBtn.textContent = '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é';
                    tertiaryBtn.onclick = () => handleNotUsing('whatsapp', '–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é');
                    break;
                case 'step9':
                    fillInputs();
                    primaryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é';
                    primaryBtn.onclick = () => handleContactStep('viber', true);
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.innerHTML = '<span class="modal-btn-icon">üîô</span>';
                    secondaryBtn.setAttribute('aria-label', '–ù–∞–∑–∞–¥');
                    secondaryBtn.title = '–ù–∞–∑–∞–¥';
                    secondaryBtn.onclick = () => goToStep('step8');
                    tertiaryBtn.style.display = 'inline-block';
                    tertiaryBtn.textContent = '–ù–µ –∏—Å–ø–æ–ª—å–∑—É—é';
                    tertiaryBtn.onclick = () => handleNotUsing('viber', '');
                    break;
                case 'stepfinal':
                    fillInputs();
                    updateSummary();
                    primaryBtn.textContent = '–î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ';
                    primaryBtn.onclick = finalizeRegistration;
                    secondaryBtn.style.display = 'inline-block';
                    secondaryBtn.textContent = '–ó–∞–Ω–æ–≤–æ';
                    secondaryBtn.removeAttribute('title');
                    secondaryBtn.removeAttribute('aria-label');
                    secondaryBtn.onclick = resetToStart;
                    tertiaryBtn.style.display = 'inline-block';
                    tertiaryBtn.textContent = '–ù–∞–∑–∞–¥';
                    tertiaryBtn.onclick = () => goToStep('step9');
                    break;
                default:
                    primaryBtn.onclick = goToNextStep;
            }
        }

        async function openModal(form) {
            if (!form) return;
            activeForm = form;
            activeAction = form.getAttribute('action');
            previousHash = window.location.hash;
            baseUrlWithoutHash = window.location.href.split('#')[0];
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            setBusy(true);
            await loadProfileData();
            fillInputs();
            clearError();
            currentStepIndex = 0;
            renderStep();
            setBusy(false);
        }

        function closeModal() {
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            restoreHash();
            clearError();
            activeForm = null;
            activeAction = '';
            currentStepIndex = 0;
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            event.stopPropagation();
            if (isBusy) {
                return;
            }
            openModal(event.currentTarget);
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modal.addEventListener('mousedown', function(evt) {
            if (evt.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(evt) {
            if (evt.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
                closeModal();
            }
        });

        const registerForms = document.querySelectorAll('form.register-form');
        registerForms.forEach(form => form.addEventListener('submit', handleFormSubmit));
    });
})();
</script>

