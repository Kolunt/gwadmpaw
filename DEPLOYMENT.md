# Инструкция по развертыванию на PythonAnywhere

## Развертывание на gwadm.pythonanywhere.com

### ⚠️ Важное замечание о названиях

- **Репозиторий GitHub**: `gwadmpaw`
- **Папка на PythonAnywhere**: `gwadm`

При клонировании репозитория нужно указать имя папки `gwadm`, чтобы все пути в инструкции совпадали.

### Шаг 1: Подготовка файлов

**Важно**: Репозиторий называется `gwadmpaw`, но на PythonAnywhere папка должна называться `gwadm`.

1. **Клонируйте репозиторий** на PythonAnywhere через консоль с указанием имени папки:
```bash
cd ~
git clone https://github.com/Kolunt/gwadmpaw.git gwadm
```

Это создаст папку `gwadm` вместо `gwadmpaw`.

**Альтернативный способ** - если уже клонировали в папку `gwadmpaw`, переименуйте её:
```bash
cd ~
mv gwadmpaw gwadm
```

Или загрузите файлы через **Files** → **Upload a file** в панели управления PythonAnywhere в папку `gwadm`.

### Шаг 2: Установка зависимостей

1. Откройте консоль **Bash** в панели управления PythonAnywhere
2. Перейдите в директорию проекта:
```bash
cd ~/gwadm
```

**Важно**: Используйте папку `gwadm`, а не `gwadmpaw`.

3. **Проверьте и удалите ненужные зависимости** (если они были установлены ранее):
```bash
# Удалите mangum если он установлен (он не нужен для Flask)
pip3.10 uninstall mangum -y 2>/dev/null || true
```

4. Установите зависимости (для Python 3.10):
```bash
pip3.10 install --user -r requirements.txt
```

**Примечание**: Flask-Babel опционален. Если он не установлен, приложение будет работать с русскими переводами из встроенного словаря. Для полной функциональности локализации рекомендуется установить Flask-Babel.

Если используете другую версию Python, замените `3.10` на нужную версию (например, `3.9`, `3.11`).

### Шаг 3: Создание веб-приложения на PythonAnywhere

**Важно**: Если у вас уже есть созданное веб-приложение на PythonAnywhere, пропустите этот шаг и перейдите к Шагу 4.

1. **Войдите в панель управления PythonAnywhere**:
   - Откройте https://www.pythonanywhere.com
   - Войдите в свой аккаунт

2. **Перейдите в раздел Web**:
   - В верхнем меню нажмите на вкладку **Web**
   - Или перейдите по прямой ссылке: https://www.pythonanywhere.com/web_app_setup/

3. **Создайте новое веб-приложение**:
   - Найдите секцию **"Add a new web app"** или **"Create a new web app"**
   - Нажмите на кнопку **"Add a new web app"**

#### Процесс создания веб-приложения:

1. **Выберите домен**:
   - Если у вас **бесплатный аккаунт (Beginner)**, выберите домен вида `yourusername.pythonanywhere.com`
     - В нашем случае это `gwadm.pythonanywhere.com`
   - Если у вас **оплаченный аккаунт**, можете использовать свой кастомный домен
   - Нажмите **"Next"**

2. **Выберите шаблон WSGI**:
   - Выберите **"Flask"** из списка доступных фреймворков
   - Выберите **Python версию** (рекомендуется Python 3.10 или новее)
   - **Важно**: выберите ту же версию Python, которую вы использовали при установке зависимостей в Шаге 2
   - Нажмите **"Next"**

3. **Настройка пути к WSGI файлу**:
   - PythonAnywhere автоматически создаст файл по пути `/var/www/gwadm_pythonanywhere_com_wsgi.py`
   - По умолчанию будет создан шаблонный код Flask, который нужно будет заменить в следующем шаге
   - Нажмите **"Finish"** для завершения создания

4. **После создания**:
   - Веб-приложение будет создано, но еще не будет работать (так как нужно настроить WSGI файл)
   - Перейдите к следующему шагу для настройки WSGI файла

**Примечание**: Если веб-приложение уже было создано ранее, вы увидите его в списке "Your web apps". В этом случае просто перейдите к Шагу 4 для настройки WSGI файла.

### Шаг 4: Настройка WSGI файла

1. В разделе **Web** найдите секцию **WSGI configuration file**
2. Нажмите на ссылку для редактирования WSGI файла (обычно находится по пути `/var/www/gwadm_pythonanywhere_com_wsgi.py`)

3. **ВАЖНО**: Полностью удалите весь старый код из WSGI файла и замените на:

```python
import sys
import os

# Добавляем путь к проекту
# Важно: папка называется "gwadm", а не "gwadmpaw"
path = '/home/gwadm/gwadm'
if path not in sys.path:
    sys.path.insert(0, path)

# Импортируем приложение Flask
from app import app

# WSGI требует переменную application
application = app
```

**Критически важно**: 
- Убедитесь, что в WSGI файле **НЕТ** никаких упоминаний `mangum`, `Lambda`, `ASGI` или других библиотек для AWS
- WSGI файл должен быть максимально простым - только импорт Flask приложения
- Путь указывает на `/home/gwadm/gwadm` (папка `gwadm`, а не `gwadmpaw`)
- Если ваше имя пользователя на PythonAnywhere не `gwadm`, замените `/home/gwadm/` на правильный путь (например, `/home/ваш_username/gwadm`)

### Шаг 5: Настройка статических файлов

1. В разделе **Web** → **Static files** найдите секцию **Static files**
2. Добавьте следующие записи:

| URL | Directory |
|-----|-----------|
| `/static/` | `/home/gwadm/gwadm/static/` |

**Важно**: 
- Путь указывает на `/home/gwadm/gwadm/static/` (папка `gwadm`, а не `gwadmpaw`)
- Замените `gwadm` на ваше имя пользователя, если оно отличается

### Шаг 6: Проверка конфигурации

Убедитесь, что в файле `app.py` правильно указан домен:
```python
GWARS_HOST = "gwadm.pythonanywhere.com"
```

Это должно быть уже настроено, но проверьте на всякий случай.

### Шаг 7: Создание базы данных

База данных `database.db` создастся автоматически при первом запуске приложения. Убедитесь, что у вашей директории есть права на запись:

```bash
chmod 755 ~/gwadm
```

**Важно**: Используйте папку `gwadm`, а не `gwadmpaw`.

### Шаг 8: Запуск приложения

1. В разделе **Web** найдите секцию **Reload**
2. Нажмите зеленую кнопку **Reload** для перезагрузки веб-приложения
3. Дождитесь сообщения об успешной перезагрузке

### Шаг 9: Проверка работы

1. Откройте в браузере: `https://gwadm.pythonanywhere.com`
2. Вы должны увидеть главную страницу с кнопкой "Войти через GWars"
3. При нажатии на кнопку произойдет редирект на GWars для авторизации

### Шаг 10: Настройка в GWars (если требуется)

Если нужно обновить URL в настройках GWars, используйте:
```
https://www.gwars.io/cross-server-login.php?site_id=4&url=https://gwadm.pythonanywhere.com/login
```

## Проверка логов при ошибках

Если что-то не работает:

1. **Проверьте логи ошибок через веб-интерфейс**:
   - В панели управления PythonAnywhere перейдите в раздел **Web**
   - Найдите секцию **Error log** или **Server log**
   - Нажмите на ссылку для просмотра логов
   - Это самый надежный способ просмотра логов

2. **Проверьте логи ошибок через консоль**:
   ```bash
   # Попробуйте разные варианты путей к логам:
   tail -n 50 ~/logs/error.log
   tail -n 50 ~/logs/gwadm.pythonanywhere.com.error.log
   
   # Или найдите файлы логов:
   find ~/logs -name "*.log" -type f
   ls -la ~/logs/
   
   # Или проверьте логи через веб-панель (предпочтительно)
   ```

3. **Проверьте логи сервера**:
   ```bash
   tail -n 50 ~/logs/server.log
   tail -n 50 ~/logs/gwadm.pythonanywhere.com.server.log
   ```

4. **Альтернативный способ - просмотр через веб-интерфейс**:
   - В разделе **Web** найдите ссылку **"Error log"** или **"Server log"**
   - Логи отображаются прямо в браузере
   - Это самый простой и надежный способ

**Примечание**: На PythonAnywhere логи могут находиться в разных местах в зависимости от типа аккаунта. Используйте веб-интерфейс для просмотра логов - это самый надежный способ.

3. **Проверьте права доступа**:
```bash
ls -la ~/gwadmpaw
```

4. **Проверьте, что Python находит Flask**:
```bash
python3.10 -c "import flask; print(flask.__version__)"
```

## Обновление проекта

### Как правильно обновить проект через git pull

1. **Откройте консоль Bash** на PythonAnywhere

2. **Перейдите в директорию проекта**:
```bash
cd ~/gwadm
```

**Важно**: Используйте папку `gwadm`, а не `gwadmpaw`.

3. **Проверьте текущий статус** (опционально):
```bash
git status
```

4. **Получите последние изменения из репозитория**:
```bash
git pull origin main
```

Если возникнут конфликты, вы увидите сообщение об этом. В таком случае:
```bash
# Посмотрите, какие файлы в конфликте
git status

# Если нужно отменить локальные изменения и использовать версию из репозитория:
git reset --hard origin/main
```

**Внимание**: `git reset --hard` удалит все локальные изменения, которые не были закоммичены!

5. **Если устанавливались новые зависимости**, обновите их:
```bash
pip3.10 install --user -r requirements.txt
```

6. **Перезагрузите веб-приложение**:
   - В панели управления PythonAnywhere перейдите в раздел **Web**
   - Нажмите зеленую кнопку **Reload** для перезагрузки веб-приложения

### Альтернативный способ (если git pull не работает)

Если `git pull` выдает ошибки, можно сделать полное обновление:

```bash
cd ~/gwadm
git fetch origin
git reset --hard origin/main
```

### Проверка обновлений

После обновления проверьте:
- Что приложение работает: откройте `https://gwadm.pythonanywhere.com`
- Логи ошибок (если есть проблемы): 
  - Через веб-интерфейс: раздел **Web** → **Error log**
  - Или через консоль: `tail -n 50 ~/logs/error.log` (если файл существует)

## Структура файлов на сервере

После развертывания структура должна выглядеть так:

```
/home/gwadm/gwadm/          # Папка называется "gwadm", не "gwadmpaw"
├── app.py
├── requirements.txt
├── README.md
├── DEPLOYMENT.md
├── .gitignore
├── database.db              # Создается автоматически
├── templates/
│   ├── base.html
│   ├── index.html
│   └── dashboard.html
└── static/
    ├── css/
    │   └── style.css
    └── js/
        └── theme.js
```

**Важно**: 
- Репозиторий называется `gwadmpaw`
- Но папка на сервере должна называться `gwadm`
- Все пути в инструкции используют `/home/gwadm/gwadm/`

## Частые проблемы и решения

### Проблема: "ModuleNotFoundError: No module named 'flask'"

**Решение**: Установите зависимости еще раз:
```bash
pip3.10 install --user -r requirements.txt
```

### Проблема: "Permission denied" при создании database.db

**Решение**: Проверьте права доступа:
```bash
chmod 755 ~/gwadm
chmod 644 ~/gwadm/*.py
```

**Важно**: Используйте папку `gwadm`, а не `gwadmpaw`.

### Проблема: "Internal Server Error" или ошибка про "mangum" / "Lambda"

**Решение**: 
1. **Проверьте WSGI файл** - он должен быть простым и содержать только:
   ```python
   from app import app
   application = app
   ```
   Убедитесь, что в WSGI файле **НЕТ** упоминаний `mangum`, `Lambda`, `ASGI` или других AWS библиотек.

2. **Удалите ненужные зависимости** (если mangum установлен):
   ```bash
   pip3.10 uninstall mangum
   ```

3. Проверьте логи ошибок:
   - **Лучший способ**: через веб-интерфейс в разделе **Web** → **Error log**
   - Или через консоль: `tail -n 50 ~/logs/error.log`
4. Убедитесь, что путь в WSGI файле правильный
5. Проверьте, что все файлы загружены

### Проблема: Статические файлы не загружаются

**Решение**: 
1. Проверьте настройки Static files в разделе Web
2. Убедитесь, что путь указан правильно: `/home/gwadm/gwadm/static/` (папка `gwadm`, а не `gwadmpaw`)

## Настройка Cron задач (периодические задачи)

Периодические задачи можно настроить через внешний cron сервис (рекомендуется) или через встроенный планировщик PythonAnywhere.

### Что делает cron скрипт

Скрипт выполняет следующие задачи:
- **Очистка истекших кодов верификации Telegram** - удаляет коды, которые истекли (старше 10 минут)
- **Очистка старых логов** (опционально) - удаляет логи активности старше 90 дней
- **Резервное копирование базы данных** (опционально) - создает бэкап БД и удаляет старые (оставляет последние 7)

### Настройка через внешний Cron сервис (рекомендуется)

Приложение предоставляет HTTP endpoint для запуска cron задач, который можно использовать с любым внешним cron сервисом.

#### Шаг 1: Получение секретного токена

При первом обращении к endpoint токен генерируется автоматически и сохраняется в настройках. Получите токен одним из способов:

**Способ 1: Через админ-панель (рекомендуется)**
1. Откройте `/admin/settings#system` (раздел "Блатные" → "Система")
2. Найдите настройку `cron_secret_token` в списке системных настроек
3. Скопируйте значение токена
4. Если настройки нет в списке, сделайте первый запрос к endpoint (см. Способ 3), затем обновите страницу

**Способ 2: Через базу данных**
```bash
cd ~/gwadm
sqlite3 database.db "SELECT value FROM settings WHERE key = 'cron_secret_token';"
```

**Способ 3: Автоматическое создание**
- Сделайте запрос к endpoint без токена: `https://gwadm.pythonanywhere.com/cron/run`
- В ответе будет ошибка 401, но токен автоматически создастся в базе данных
- Затем получите его через способ 1 или 2

**Важно**: Токен создается автоматически при первом использовании endpoint. Храните его в безопасности!

#### Шаг 2: Настройка внешнего Cron сервиса

Популярные сервисы:
- **cron-job.org** (https://cron-job.org) - бесплатный, простой в использовании
- **EasyCron** (https://www.easycron.com) - платный, но надежный
- **UptimeRobot** (https://uptimerobot.com) - бесплатный, с мониторингом

**Пример настройки для cron-job.org:**

1. Зарегистрируйтесь на https://cron-job.org
2. Создайте новую задачу:
   - **Title**: Очистка кодов верификации Telegram
   - **Address (URL)**: `https://gwadm.pythonanywhere.com/cron/run?token=ВАШ_ТОКЕН`
     - Замените `ВАШ_ТОКЕН` на токен, полученный в Шаге 1
   - **Schedule**: Выберите расписание (например, каждый час)
   - **Request method**: GET или POST
3. Сохраните задачу

**Примеры URL для разных задач:**

- **Только очистка кодов верификации** (основная задача):
  ```
  https://gwadm.pythonanywhere.com/cron/run?token=ВАШ_ТОКЕН
  ```

- **С очисткой логов**:
  ```
  https://gwadm.pythonanywhere.com/cron/run?token=ВАШ_ТОКЕН&cleanup_logs=1&logs_days=90
  ```

- **С резервным копированием**:
  ```
  https://gwadm.pythonanywhere.com/cron/run?token=ВАШ_ТОКЕН&backup=1
  ```

- **Все задачи вместе**:
  ```
  https://gwadm.pythonanywhere.com/cron/run?token=ВАШ_ТОКЕН&cleanup_logs=1&logs_days=90&backup=1
  ```

#### Шаг 3: Проверка работы

1. **Запустите задачу вручную** через браузер:
   ```
   https://gwadm.pythonanywhere.com/cron/run?token=ВАШ_ТОКЕН
   ```

2. **Проверьте ответ** - должен быть JSON:
   ```json
   {
     "success": true,
     "timestamp": "2025-12-12T01:00:00",
     "tasks": {
       "cleanup_expired_verification_codes": {
         "success": true,
         "cleaned_count": 5
       }
     }
   }
   ```

3. **Проверьте логи** в админ-панели или через веб-интерфейс PythonAnywhere

#### Рекомендуемое расписание

- **Очистка кодов верификации**: Каждый час (`0 * * * *`)
- **Очистка логов**: Раз в день в 3:00 (`0 3 * * *`)
- **Резервное копирование**: Раз в день в 4:00 (`0 4 * * *`)

### Альтернатива: Настройка Cron на PythonAnywhere

Если предпочитаете использовать встроенный планировщик PythonAnywhere:

1. **Откройте раздел Tasks** в панели управления PythonAnywhere:
   - Войдите в панель управления: https://www.pythonanywhere.com
   - Перейдите в раздел **Tasks** (или найдите ссылку "Schedule a task")

2. **Создайте новую задачу**:
   - Нажмите на кнопку **"Create a task"** или **"Add a new scheduled task"**

3. **Настройте задачу**:
   - **Command**: `python3.10 ~/gwadm/cron_tasks.py`
     - Замените `3.10` на вашу версию Python
     - Замените `gwadm` на имя вашей папки, если отличается
   - **Hour**: `*` (каждый час) или конкретное время (например, `3` для 3:00)
   - **Minute**: `0` (в начале часа) или другое значение
   - **Enabled**: ✅ Включено

4. **Примеры расписания**:
   - **Каждый час**: Hour: `*`, Minute: `0`
   - **Каждые 6 часов**: Hour: `*/6`, Minute: `0`
   - **Раз в день в 3:00**: Hour: `3`, Minute: `0`
   - **Каждые 30 минут**: Hour: `*`, Minute: `*/30`

5. **Сохраните задачу**:
   - Нажмите **"Create"** или **"Save"**

**Важно**: 
- На бесплатном аккаунте PythonAnywhere может быть ограничение на количество cron задач
- Внешний cron сервис более надежен и не зависит от аккаунта PythonAnywhere

### Безопасность

- **Секретный токен** защищает endpoint от несанкционированного доступа
- Токен генерируется автоматически при первом использовании
- Храните токен в безопасности и не публикуйте его
- Можно изменить токен через настройки в админ-панели

## Дополнительная информация

- **Документация PythonAnywhere**: https://help.pythonanywhere.com/
- **Flask документация**: https://flask.palletsprojects.com/
- **Репозиторий проекта**: https://github.com/Kolunt/gwadmpaw
- **Cron на PythonAnywhere**: https://help.pythonanywhere.com/pages/ScheduledTasks/

## Контакты и поддержка

Если возникли проблемы, проверьте:
1. Логи ошибок
2. Правильность путей в WSGI файле
3. Установлены ли все зависимости
4. Правильно ли настроены Static files
5. Работают ли cron задачи (раздел Tasks в панели управления)

